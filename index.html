<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Movimentação de Produtos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- Firebase Storage -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <style>
        /* Estilos anteriores mantidos */
        :root {
            --primary-color: #4b6cb7;
            --secondary-color: #182848;
            --accent-color: #6a11cb;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --light-bg: #121212;
            --dark-bg: #1e1e1e;
            --card-bg: #2d2d2d;
            --text-color: #ffffff;
            --text-muted: #b0b0b0;
            --text-light: #ffffff;
            --border-color: #444;
            --sidebar-width: 280px;
            --table-header-bg: #343a40;
            --table-row-hover: rgba(255, 255, 255, 0.08);
            --table-striped: rgba(255, 255, 255, 0.05);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: var(--light-bg);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: all 0.3s ease;
            overflow-x: hidden;
            line-height: 1.6;
        }
        
        /* Layout com sidebar */
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--secondary-color) 0%, var(--dark-bg) 100%);
            color: white;
            padding: 0;
            box-shadow: 3px 0 10px rgba(0,0,0,0.2);
            z-index: 1000;
            transition: all 0.3s ease;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }
        
        .sidebar-header {
            padding: 25px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            text-align: center;
            background: rgba(0,0,0,0.2);
        }
        
        .sidebar-nav {
            padding: 20px 0;
        }
        
        .nav-item {
            margin-bottom: 5px;
        }
        
        .nav-link {
            color: rgba(255,255,255,0.9);
            padding: 15px 25px;
            border-radius: 0;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            border-left: 4px solid transparent;
            text-decoration: none;
            font-weight: 500;
        }
        
        .nav-link:hover, .nav-link.active {
            background: rgba(255,255,255,0.1);
            color: white;
            border-left-color: var(--primary-color);
        }
        
        .nav-link i {
            margin-right: 12px;
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }
        
        .main-content {
            flex: 1;
            padding: 20px;
            margin-left: var(--sidebar-width);
            background-color: var(--light-bg);
            min-height: 100vh;
        }
        
        .page {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .active {
            display: block;
        }
        
        /* Cards e containers */
        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            margin-bottom: 24px;
            transition: transform 0.3s, box-shadow 0.3s;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        
        .card-header {
            background: linear-gradient(135deg, rgba(75, 108, 183, 0.1) 0%, rgba(106, 17, 203, 0.1) 100%);
            border-bottom: 1px solid var(--border-color);
            padding: 18px 24px;
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text-light);
        }
        
        .card-body {
            padding: 24px;
        }
        
        /* Formulários */
        .form-control, .form-select {
            background-color: #3a3a3a;
            border: 1px solid #555;
            color: var(--text-color);
            border-radius: 8px;
            padding: 10px 15px;
            transition: all 0.3s;
        }
        
        .form-control:focus, .form-select:focus {
            background-color: #424242;
            border-color: var(--primary-color);
            color: var(--text-color);
            box-shadow: 0 0 0 0.25rem rgba(75, 108, 183, 0.25);
        }
        
        .form-label {
            color: var(--text-light);
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        /* Tabelas */
        .table {
            color: var(--text-color);
            border-color: var(--border-color);
            margin-bottom: 0;
            width: 100%;
            background-color: var(--card-bg);
        }
        
        .table th {
            background-color: var(--table-header-bg);
            color: var(--text-light);
            font-weight: 600;
            padding: 10px 12px;
            border-bottom: 2px solid var(--border-color);
            vertical-align: middle;
        }
        
        .table td {
            padding: 10px 12px;
            vertical-align: middle;
            color: var(--text-color);
            border-top: 1px solid var(--border-color);
            background-color: transparent;
        }
        
        .table-striped>tbody>tr:nth-of-type(odd) {
            background-color: var(--table-striped);
        }
        
        .table-hover tbody tr:hover {
            background-color: var(--table-row-hover);
        }
        
        /* Botões */
        .btn {
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s;
            padding: 10px 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: none;
        }
        
        .btn i {
            margin-right: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--primary-color) 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(75, 108, 183, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #1e7e34 100%);
            color: white;
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #1e7e34 0%, var(--success-color) 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #e0a800 100%);
            color: black;
        }
        
        .btn-warning:hover {
            background: linear-gradient(135deg, #e0a800 0%, var(--warning-color) 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 193, 7, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color) 0%, #c82333 100%);
            color: white;
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #c82333 0%, var(--danger-color) 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
        }
        
        .btn-outline-primary {
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            background: transparent;
        }
        
        .btn-outline-primary:hover {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            color: white;
            transform: translateY(-2px);
        }
        
        .btn-outline-secondary {
            color: var(--text-muted);
            border: 2px solid var(--border-color);
            background: transparent;
        }
        
        .btn-outline-secondary:hover {
            background: var(--border-color);
            color: white;
            transform: translateY(-2px);
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.875rem;
        }
        
        .btn-lg {
            padding: 12px 24px;
            font-size: 1.1rem;
        }
        
        /* Status para produtos segregados */
        .status-ativo {
            background-color: #856404;
            color: #fff3cd;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
            display: inline-block;
        }
        
        .status-liberado {
            background-color: #155724;
            color: #d4edda;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
            display: inline-block;
        }
        
        .status-descartado {
            background-color: #721c24;
            color: #f8d7da;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
            display: inline-block;
        }
        
        .segregation-badge {
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 12px;
            margin: 2px;
            display: inline-block;
        }
        
        .segregation-qualidade {
            background-color: #17a2b8;
            color: white;
        }
        
        .segregation-quarentena {
            background-color: #6c757d;
            color: white;
        }
        
        .segregation-nao-conformidade {
            background-color: #dc3545;
            color: white;
        }
        
        .segregation-retorno-cliente {
            background-color: #fd7e14;
            color: white;
        }
        
        .segregation-analise-tecnica {
            background-color: #6f42c1;
            color: white;
        }
        
        .segregation-outros {
            background-color: #e83e8c;
            color: white;
        }
        
        .document-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }
        
        .document-item {
            width: 120px;
            height: 120px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 10px;
            transition: transform 0.3s;
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .document-item:hover {
            transform: scale(1.05);
        }
        
        .document-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }
        
        .document-name {
            font-size: 0.8rem;
            word-break: break-word;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .segregation-alert {
            border-left: 4px solid #ffc107;
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 193, 7, 0.05) 100%);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 0 8px 8px 0;
        }
        
        .segregation-critical {
            border-left: 4px solid #dc3545;
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.1) 0%, rgba(220, 53, 69, 0.05) 100%);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 0 8px 8px 0;
        }
        
        .segregation-timeline {
            position: relative;
            padding-left: 30px;
            margin-top: 20px;
        }
        
        .segregation-timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: var(--border-color);
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 20px;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -23px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--primary-color);
            border: 2px solid var(--border-color);
        }
        
        .timeline-content {
            background-color: rgba(255, 255, 255, 0.05);
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        /* Foto preview */
        .photo-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }
        
        .photo-preview {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 10px;
            border: 2px solid var(--border-color);
            transition: transform 0.3s;
        }
        
        .photo-preview:hover {
            transform: scale(1.05);
        }

        /* Utilitários */
        .text-gradient {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Status badges */
        .status-valid {
            background-color: #155724;
            color: #d4edda;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
            display: inline-block;
        }
        
        .status-warning {
            background-color: #856404;
            color: #fff3cd;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
            display: inline-block;
        }
        
        .status-expired {
            background-color: #721c24;
            color: #f8d7da;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
            display: inline-block;
        }

        /* Movement badges */
        .movement-badge {
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 12px;
            margin: 2px;
            display: inline-block;
        }
        
        .movement-entrada {
            background-color: #155724;
            color: #d4edda;
        }
        
        .movement-saida {
            background-color: #721c24;
            color: #f8d7da;
        }
        
        .movement-devolucao {
            background-color: #856404;
            color: #fff3cd;
        }

        /* Dashboard cards */
        .stat-card {
            background: linear-gradient(135deg, rgba(75, 108, 183, 0.1) 0%, rgba(106, 17, 203, 0.1) 100%);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            transition: transform 0.3s;
            border: 1px solid rgba(255,255,255,0.1);
            height: 100%;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 5px;
            font-weight: 700;
            color: var(--text-light);
        }
        
        .stat-card p {
            color: var(--text-muted);
            margin-bottom: 0;
        }

        /* Product group styles */
        .product-group, .loading-group {
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .product-group:hover, .loading-group:hover {
            background-color: rgba(255,255,255,0.1) !important;
        }
        
        .product-details, .loading-details {
            background-color: rgba(255,255,255,0.03);
        }
        
        .batch-details {
            padding-left: 40px !important;
        }
        
        .batch-indicator {
            display: inline-block;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            text-align: center;
            line-height: 24px;
            font-size: 12px;
            margin-left: 8px;
            font-weight: bold;
        }

        /* Report line styles */
        .report-line {
            padding: 15px 20px;
            border-left: 4px solid var(--primary-color);
            background: linear-gradient(135deg, rgba(75, 108, 183, 0.1) 0%, rgba(106, 17, 203, 0.05) 100%);
            margin-bottom: 15px;
            border-radius: 0 10px 10px 0;
            transition: all 0.3s;
        }
        
        .report-line:hover {
            background: linear-gradient(135deg, rgba(75, 108, 183, 0.15) 0%, rgba(106, 17, 203, 0.1) 100%);
        }
        
        .report-header {
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-size: 1.1rem;
            color: var(--text-light);
        }
        
        .report-details {
            margin-top: 15px;
            padding-left: 20px;
            border-left: 2px dashed var(--border-color);
        }
        
        .report-item {
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .report-item:last-child {
            border-bottom: none;
        }

        /* Sync status */
        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }
        
        .sync-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .sync-online {
            background-color: var(--success-color);
        }
        
        .sync-offline {
            background-color: var(--danger-color);
        }
        
        .sync-syncing {
            background-color: var(--warning-color);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Modal com fundo escuro e fontes brancas */
        .modal-content {
            background-color: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        
        .modal-header {
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(135deg, rgba(75, 108, 183, 0.1) 0%, rgba(106, 17, 203, 0.1) 100%);
        }
        
        .modal-footer {
            border-top: 1px solid var(--border-color);
        }
        
        .btn-close {
            filter: invert(1);
        }

        /* ========== ALTERAÇÕES SOLICITADAS ========== */
        
        /* 1. Dashboard - Fontes brancas em toda a tela */
        #dashboard-page,
        #dashboard-page .card,
        #dashboard-page .card-body,
        #dashboard-page .card-header,
        #dashboard-page .table,
        #dashboard-page .table th,
        #dashboard-page .table td,
        #dashboard-page .text-muted,
        #dashboard-page .expiring-products-list,
        #dashboard-page .expiring-products-list .text-muted,
        #dashboard-page .expiring-products-list strong,
        #dashboard-page .expiring-products-list .small,
        #dashboard-page .stat-card p,
        #dashboard-page .stat-card h3 {
            color: var(--text-light) !important;
        }

        /* 2. Tela: Estoque de Produtos - Fontes brancas para SKU e Tipo de Produto */
        #products-page .report-header strong,
        #products-page .report-header .text-muted,
        #products-page .table td,
        #products-page .table th {
            color: var(--text-light) !important;
        }

        #products-page .card,
        #products-page .card-body,
        #products-page .form-label,
        #products-page .report-line {
            color: var(--text-light) !important;
        }

        #products-page .report-header .text-muted {
            color: var(--text-light) !important;
            opacity: 0.9;
        }

        /* 3. Tela: Movimentação de Palete - Cores azul com roxo igual ao cabeçalho */
        #paletes-page .card,
        #paletes-page .card-body,
        #paletes-page .form-label,
        #paletes-page .report-line,
        #paletes-page .table td,
        #paletes-page .table th {
            color: var(--text-light) !important;
        }

        #paletes-page .report-header,
        #paletes-page .card-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%) !important;
            -webkit-background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            background-clip: text !important;
            color: transparent !important;
        }

        #paletes-page .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            color: white;
            border: none;
        }

        /* 4. Tela: Configuração - Cor da fonte branca */
        #config-page .card,
        #config-page .card-body,
        #config-page .form-label,
        #config-page h5,
        #config-page .form-check-label,
        #config-page .sync-status,
        #config-page .btn {
            color: var(--text-light) !important;
        }

        .modal-content,
        .modal-header,
        .modal-body,
        .modal-footer {
            color: var(--text-light) !important;
        }

        .modal-title,
        .modal-body .form-label,
        .modal-body .text-muted {
            color: var(--text-light) !important;
        }

        /* Melhorias de acessibilidade para todas as telas */
        .form-control, .form-select {
            background-color: #3a3a3a;
            border: 1px solid #555;
            color: var(--text-light) !important;
        }

        .form-control:focus, .form-select:focus {
            background-color: #424242;
            border-color: var(--primary-color);
            color: var(--text-light) !important;
            box-shadow: 0 0 0 0.25rem rgba(75, 108, 183, 0.25);
        }

        body, .card, .modal-content {
            color: var(--text-light) !important;
        }

        .table td, .table th {
            color: var(--text-light) !important;
            border-color: var(--border-color);
        }

        .table-hover tbody tr:hover {
            background-color: var(--table-row-hover);
            color: var(--text-light) !important;
        }

        /* Footer com créditos */
        .app-footer {
            background-color: var(--dark-bg);
            color: var(--text-muted);
            padding: 20px;
            text-align: center;
            border-top: 1px solid var(--border-color);
            margin-top: 40px;
            font-size: 0.9rem;
        }

        /* NOVOS ESTILOS PARA AS MODIFICAÇÕES SOLICITADAS */
        
        /* Estilos para o relatório de paletes no formato da imagem */
        .paletes-movement-table {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
        }

        .paletes-item {
            font-size: 1rem;
        }

        .paletes-totals {
            font-size: 1.1rem;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 6px;
        }

        /* Estilos para a tabela de produtos com vencimento próximo */
        #expiring-products-table tr td {
            vertical-align: middle;
            padding: 12px 8px;
        }

        #expiring-products-table .badge {
            font-size: 0.75rem;
        }

        /* Responsividade */
        @media (max-width: 992px) {
            .sidebar {
                width: 80px;
            }
            
            .sidebar .nav-link span {
                display: none;
            }
            
            .sidebar .nav-link i {
                margin-right: 0;
            }
            
            .sidebar-header h3, .sidebar-header p {
                display: none;
            }
            
            .sidebar-header {
                padding: 20px 10px;
            }
            
            .main-content {
                margin-left: 80px;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .app-container {
                flex-direction: column;
            }
        }

        /* ========== MODIFICAÇÕES SOLICITADAS ========== */
        
        /* 1. Botão de ação na Tela Relatório de Estoque */
        .report-actions {
            display: flex;
            gap: 5px;
            margin-left: 10px;
        }
        
        .report-actions .btn {
            padding: 4px 8px;
        }
        
        /* 2. Ícone preto para botão de editar na Tela Movimentação de Paletes */
        .btn-edit-black {
            color: #000 !important;
        }
        
        /* 3. Cor mais escura para Vencimento Próximo no Dashboard */
        .status-warning {
            background-color: #b58900 !important; /* Tom mais escuro de amarelo */
            color: #fff3cd;
        }
        
        /* 4. Posicionamento do botão Salvar e Gerar PDF */
        .save-pdf-bottom {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar de Navegação -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3 class="mb-1">Sistema de Controle</h3>
                <p class="mb-0 small opacity-75">Gestão de Movimentação e Estoque</p>
                <div class="sync-status mt-2">
                    <span class="sync-indicator sync-offline" id="sync-status-indicator"></span>
                    <span id="sync-status-text">Offline</span>
                </div>
            </div>
            <div class="sidebar-nav">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" data-page="dashboard-page">
                            <i class="bi bi-speedometer2"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-page="stock-report-page">
                            <i class="bi bi-clipboard-data"></i>
                            <span>Relatório de Estoque</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-page="report-page">
                            <i class="bi bi-box-arrow-in-down"></i>
                            <span>Cadastro de Movimentação</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-page="products-page">
                            <i class="bi bi-boxes"></i>
                            <span>Estoque de Produtos</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-page="paletes-page">
                            <i class="bi bi-pallet"></i>
                            <span>Movimentação de Paletes</span>
                        </a>
                    </li>
                    <!-- NOVO: Link para Produtos Segregados -->
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-page="segregated-products-page">
                            <i class="bi bi-shield-exclamation"></i>
                            <span>Produtos Segregados</span>
                        </a>
                    </li>
                    <li class="nav-item mt-4">
                        <a class="nav-link" href="#" data-page="config-page">
                            <i class="bi bi-gear-fill"></i>
                            <span>Configurações</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Conteúdo Principal -->
        <div class="main-content">
            <!-- Dashboard -->
            <div id="dashboard-page" class="page active">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="text-gradient">Dashboard</h2>
                    <div class="text-muted">
                        <i class="bi bi-calendar3 me-1"></i>
                        <span id="current-date"></span>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-3 col-sm-6 mb-4">
                        <div class="stat-card">
                            <i class="bi bi-box-seam"></i>
                            <h3 id="total-products">0</h3>
                            <p class="text-muted">Produtos em Estoque</p>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-4">
                        <div class="stat-card">
                            <i class="bi bi-arrow-down-circle"></i>
                            <h3 id="total-entradas">0</h3>
                            <p class="text-muted">Entradas Hoje</p>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-4">
                        <div class="stat-card">
                            <i class="bi bi-arrow-up-circle"></i>
                            <h3 id="total-saidas">0</h3>
                            <p class="text-muted">Saídas Hoje</p>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-4">
                        <div class="stat-card">
                            <i class="bi bi-exclamation-triangle"></i>
                            <h3 id="total-alertas">0</h3>
                            <p class="text-muted">Alertas</p>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Movimentações de Produtos (Semanal) -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Movimentações de Produtos (Semanal)</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Tipo</th>
                                                <th>Tipo de Movimento</th>
                                                <th>Quantidade</th>
                                            </tr>
                                        </thead>
                                        <tbody id="weekly-products-movements">
                                            <tr>
                                                <td colspan="3" class="text-center">Nenhuma movimentação esta semana</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Movimentações de Produtos (Mensal) -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Movimentações de Produtos (Mensal)</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Tipo</th>
                                                <th>Tipo de Movimento</th>
                                                <th>Quantidade</th>
                                            </tr>
                                        </thead>
                                        <tbody id="monthly-products-movements">
                                            <tr>
                                                <td colspan="3" class="text-center">Nenhuma movimentação este mês</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Movimentação de Paletes (Semanal) -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Movimentação de Paletes (Semanal)</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Tipo</th>
                                                <th>Tipo de Movimento</th>
                                                <th>Quantidade</th>
                                            </tr>
                                        </thead>
                                        <tbody id="weekly-paletes-movements">
                                            <tr>
                                                <td colspan="3" class="text-center">Nenhuma movimentação esta semana</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Movimentação de Paletes (Mensal) -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Movimentação de Paletes (Mensal)</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Tipo de Movimento</th>
                                                <th>Quantidade</th>
                                            </tr>
                                        </thead>
                                        <tbody id="monthly-paletes-movements">
                                            <tr>
                                                <td colspan="2" class="text-center">Nenhuma movimentação este mês</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Status de Produtos</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3 d-flex justify-content-between align-items-center">
                                    <span class="status-valid">Dentro do Prazo</span>
                                    <span id="count-valid" class="fw-bold">0</span>
                                </div>
                                <div class="mb-3 d-flex justify-content-between align-items-center">
                                    <span class="status-warning">Vencimento Próximo</span>
                                    <span id="count-warning" class="fw-bold">0</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="status-expired">Vencidos</span>
                                    <span id="count-expired" class="fw-bold">0</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mt-4">
                            <div class="card-header">
                                <h5 class="mb-0">Produtos com Vencimento Próximo</h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover mb-0">
                                        <thead>
                                            <tr>
                                                <th>Produto</th>
                                                <th>Data de Vencimento</th>
                                                <th class="text-center">Quantidade</th>
                                            </tr>
                                        </thead>
                                        <tbody id="expiring-products-table">
                                            <tr>
                                                <td colspan="3" class="text-center">Nenhum produto com vencimento próximo</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tela de Relatório de Estoque -->
            <div id="stock-report-page" class="page">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="text-gradient">Relatório de Estoque</h2>
                    <div>
                        <button id="generate-stock-pdf" class="btn btn-primary me-2">
                            <i class="bi bi-file-earmark-pdf me-1"></i>Gerar PDF
                        </button>
                        <button id="generate-stock-excel" class="btn btn-success">
                            <i class="bi bi-file-earmark-spreadsheet me-1"></i>Exportar Excel
                        </button>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Filtros do Relatório</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="stock-filter-date" class="form-label">Data do Relatório</label>
                                <input type="date" class="form-control" id="stock-filter-date">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="stock-filter-product" class="form-label">Produto</label>
                                <input type="text" class="form-control" id="stock-filter-product" placeholder="Nome do produto">
                            </div>
                            <div class="col-md-4 mb-3 d-flex align-items-end">
                                <div class="btn-group w-100">
                                    <button id="apply-stock-filters" class="btn btn-primary me-2 flex-fill">Filtrar</button>
                                    <button id="reset-stock-filters" class="btn btn-outline-secondary flex-fill">Limpar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div id="stock-report-container">
                            <!-- Estrutura expansível será gerada dinamicamente aqui -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tela de Cadastro de Movimentação -->
            <div id="report-page" class="page">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="text-gradient">Cadastro de Movimentação</h2>
                    <div>
                        <!-- BOTÃO MODIFICADO: Removido o botão Limpar Tudo do topo -->
                        <button id="save-and-generate-pdf" class="btn btn-success me-2">
                            <i class="bi bi-check-circle me-1"></i>Salvar e Gerar PDF
                        </button>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Dados da Movimentação</h5>
                    </div>
                    <div class="card-body">
                        <form id="movement-form">
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <label for="input-date" class="form-label">Data *</label>
                                    <input type="date" class="form-control" id="input-date" required>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="input-movementType" class="form-label">Tipo de Movimento *</label>
                                    <select class="form-select" id="input-movementType" required>
                                        <option value="">Selecione...</option>
                                        <option value="Entrada">Entrada</option>
                                        <option value="Saída">Saída</option>
                                        <option value="Devolução">Devolução</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="input-product" class="form-label">Produto *</label>
                                    <select class="form-select" id="input-product" required>
                                        <option value="">Selecione um produto</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="input-quantity" class="form-label">Quantidade *</label>
                                    <input type="number" class="form-control" id="input-quantity" min="1" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="input-lote" class="form-label">Lote</label>
                                    <select class="form-select" id="input-lote">
                                        <option value="">Selecione um lote</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3 d-flex align-items-end">
                                    <button type="button" id="add-to-table" class="btn btn-primary w-100">
                                        <i class="bi bi-plus-circle me-1"></i>Adicionar à Lista
                                    </button>
                                </div>
                            </div>
                            <!-- NOVA FUNCIONALIDADE: Upload de Fotos -->
                            <div class="row mt-3">
                                <div class="col-12">
                                    <label for="input-photos" class="form-label">Adicionar Fotos/Imagens</label>
                                    <input type="file" class="form-control" id="input-photos" accept="image/*" multiple>
                                    <div class="form-text">As fotos adicionadas serão incluídas automaticamente no relatório PDF.</div>
                                    <div class="photo-preview-container" id="photo-preview-container">
                                        <!-- Preview das fotos será exibido aqui -->
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Itens da Movimentação</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Produto</th>
                                        <th>Tipo</th>
                                        <th>Lote</th>
                                        <th>Movimento</th>
                                        <th>Quantidade</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="movement-table">
                                    <tr>
                                        <td colspan="6" class="text-center">Nenhum item adicionado</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <!-- BOTÃO MODIFICADO: Salvar e Gerar PDF colocado abaixo da tabela -->
                        <div class="save-pdf-bottom">
                            <button id="save-and-generate-pdf-bottom" class="btn btn-success me-2">
                                <i class="bi bi-check-circle me-1"></i>Salvar e Gerar PDF
                            </button>
                            <button id="clear-movement" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle me-1"></i>Limpar Tudo
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tela de Estoque de Produtos -->
            <div id="products-page" class="page">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="text-gradient">Estoque de Produtos</h2>
                    <div>
                        <button id="export-products-excel" class="btn btn-success me-2">
                            <i class="bi bi-file-earmark-spreadsheet me-1"></i>Exportar para Excel
                        </button>
                        <button id="add-product" class="btn btn-primary">
                            <i class="bi bi-plus-circle me-1"></i>Adicionar Produto
                        </button>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 col-sm-6 mb-3">
                                <label for="products-filter-sku" class="form-label">SKU</label>
                                <input type="text" class="form-control" id="products-filter-sku" placeholder="Código SKU">
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <label for="products-filter-name" class="form-label">Produto</label>
                                <input type="text" class="form-control" id="products-filter-name" placeholder="Nome do produto">
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <label for="products-filter-type" class="form-label">Tipo de Produto</label>
                                <select class="form-select" id="products-filter-type">
                                    <option value="">Todos</option>
                                    <option value="Tambor">Tambor</option>
                                    <option value="Balde">Balde</option>
                                    <option value="Bombona">Bombona</option>
                                    <option value="IBC1000L">IBC1000L</option>
                                    <option value="Caixa">Caixa</option>
                                </select>
                            </div>
                            <div class="col-md-3 col-sm-12 mb-3 d-flex align-items-end">
                                <div class="btn-group w-100">
                                    <button id="apply-products-filters" class="btn btn-primary me-2 flex-fill">Filtrar</button>
                                    <button id="reset-products-filters" class="btn btn-outline-secondary flex-fill">Limpar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div id="products-container">
                            <!-- Estrutura expansível será gerada dinamicamente aqui -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tela de Movimentação de Paletes -->
            <div id="paletes-page" class="page">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="text-gradient">Movimentação de Paletes</h2>
                    <div>
                        <button id="generate-paletes-pdf" class="btn btn-primary me-2">
                            <i class="bi bi-file-earmark-pdf me-1"></i>Gerar PDF
                        </button>
                        <button id="generate-paletes-excel" class="btn btn-success">
                            <i class="bi bi-file-earmark-spreadsheet me-1"></i>Exportar Excel
                        </button>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Filtros do Relatório</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="paletes-filter-date" class="form-label">Data do Relatório</label>
                                <input type="date" class="form-control" id="paletes-filter-date">
                            </div>
                            <div class="col-md-6 d-flex align-items-end">
                                <div class="btn-group w-100">
                                    <button id="apply-paletes-filters" class="btn btn-primary me-2 flex-fill">Filtrar</button>
                                    <button id="reset-paletes-filters" class="btn btn-outline-secondary flex-fill">Limpar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Relatório Diário de Paletes</h5>
                    </div>
                    <div class="card-body">
                        <div id="paletes-report-container">
                            <!-- Estrutura expansível será gerada dinamicamente aqui -->
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Adicionar Movimentação de Paletes</h5>
                    </div>
                    <div class="card-body">
                        <form id="paletes-form">
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Data</label>
                                    <input type="date" class="form-control" id="paletes-date" required>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Tipo de Palete</label>
                                    <select class="form-select" id="paletes-type" required>
                                        <option value="Fracionado">Fracionado</option>
                                        <option value="Tambor">Tambor</option>
                                        <option value="IBC 1000L">IBC 1000L</option>
                                        <option value="Outro">Outro</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Tipo de Movimento</label>
                                    <select class="form-select" id="paletes-movement" required>
                                        <option value="Entrada">Entrada</option>
                                        <option value="Saída">Saída</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Quantidade</label>
                                    <input type="number" class="form-control" id="paletes-quantity" min="1" value="1" required>
                                </div>
                            </div>
                            <div class="d-grid">
                                <button type="button" id="add-paletes-item" class="btn btn-primary">
                                    <i class="bi bi-plus-circle me-1"></i>Adicionar Movimentação
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Tela de Produtos Segregados -->
            <div id="segregated-products-page" class="page">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="text-gradient">Produtos Segregados</h2>
                    <button id="add-segregation" class="btn btn-primary">
                        <i class="bi bi-plus-circle me-1"></i>Adicionar Segregação
                    </button>
                </div>

                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="segregation-filter-product" class="form-label">Produto</label>
                                <input type="text" class="form-control" id="segregation-filter-product" placeholder="Nome do produto">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="segregation-filter-status" class="form-label">Status</label>
                                <select class="form-select" id="segregation-filter-status">
                                    <option value="">Todos</option>
                                    <option value="Ativo">Ativo</option>
                                    <option value="Liberado">Liberado</option>
                                    <option value="Descartado">Descartado</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="segregation-filter-date" class="form-label">Data</label>
                                <input type="date" class="form-control" id="segregation-filter-date">
                            </div>
                            <div class="col-md-3 mb-3 d-flex align-items-end">
                                <div class="btn-group w-100">
                                    <button id="apply-segregation-filters" class="btn btn-primary me-2 flex-fill">Filtrar</button>
                                    <button id="reset-segregation-filters" class="btn btn-outline-secondary flex-fill">Limpar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Produto</th>
                                        <th>Lote</th>
                                        <th>Motivo</th>
                                        <th>Data</th>
                                        <th>Status</th>
                                        <th class="text-center">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="segregated-products-table">
                                    <tr>
                                        <td colspan="6" class="text-center">Nenhum produto segregado</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tela de Configurações -->
            <div id="config-page" class="page">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="text-gradient">Configurações do Sistema</h2>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="mb-4">
                            <h5>Preferências de Exibição</h5>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="dark-mode-toggle" checked>
                                <label class="form-check-label" for="dark-mode-toggle">Modo escuro</label>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <h5>Notificações</h5>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="notify-expiry" checked>
                                <label class="form-check-label" for="notify-expiry">Alertas de vencimento</label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="notify-low-stock" checked>
                                <label class="form-check-label" for="notify-low-stock">Alertas de estoque baixo</label>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <h5>Relatórios</h5>
                            <div class="mb-3">
                                <label for="report-format" class="form-label">Formato padrão de relatório</label>
                                <select class="form-select" id="report-format">
                                    <option value="pdf" selected>PDF</option>
                                    <option value="excel">Excel</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <h5>Sincronização Firebase</h5>
                            <div class="mb-3">
                                <div class="sync-status mb-2">
                                    <span class="sync-indicator sync-offline" id="config-sync-status-indicator"></span>
                                    <span id="config-sync-status-text">Status: Offline</span>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="button" id="sync-to-firebase" class="btn btn-primary btn-sm">
                                        <i class="bi bi-cloud-upload me-1"></i>Sincronizar com Firebase
                                    </button>
                                    <button type="button" id="sync-from-firebase" class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-cloud-download me-1"></i>Carregar do Firebase
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid">
                            <button type="button" id="save-config-btn" class="btn btn-primary">
                                <i class="bi bi-check-circle me-1"></i>Salvar Configurações
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer com créditos -->
    <footer class="app-footer">
        <div class="container">
            <p class="mb-1">Sistema desenvolvido por <strong>Aldemir Garbino</strong> com auxílio de IA</p>
            <p class="mb-0">© 2025 - Todos os direitos reservados</p>
        </div>
    </footer>

    <!-- Modal para Adicionar/Editar Produto -->
    <div class="modal fade" id="productModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalTitle">Adicionar Produto ao Estoque</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="product-form">
                        <input type="hidden" id="edit-product-id">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="product-sku" class="form-label">SKU *</label>
                                <input type="text" class="form-control" id="product-sku" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="product-name" class="form-label">Produto *</label>
                                <input type="text" class="form-control" id="product-name" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="product-type" class="form-label">Tipo de Produto *</label>
                                <select class="form-select" id="product-type" required>
                                    <option value="Tambor">Tambor</option>
                                    <option value="Balde">Balde</option>
                                    <option value="Bombona">Bombona</option>
                                    <option value="IBC1000L">IBC1000L</option>
                                    <option value="Caixa">Caixa</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="product-quantity" class="form-label">Quantidade *</label>
                                <input type="number" class="form-control" id="product-quantity" min="0" value="0" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="product-batch" class="form-label">Lote</label>
                                <input type="text" class="form-control" id="product-batch" placeholder="Opcional">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="product-manufacturing-date" class="form-label">Data de Fabricação *</label>
                                <input type="date" class="form-control" id="product-manufacturing-date" required>
                            </div>
                        </div>
                        <p class="text-muted">* Campos obrigatórios</p>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="save-product">Salvar Produto</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Adicionar Segregação -->
    <div class="modal fade" id="addSegregationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Adicionar Segregação de Produto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="add-segregation-form">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="segregation-product" class="form-label">Produto *</label>
                                <select class="form-select" id="segregation-product" required>
                                    <option value="">Selecione um produto</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="segregation-lote" class="form-label">Lote *</label>
                                <select class="form-select" id="segregation-lote" required>
                                    <option value="">Selecione um lote</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="segregation-reason" class="form-label">Motivo *</label>
                                <select class="form-select" id="segregation-reason" required>
                                    <option value="">Selecione o motivo</option>
                                    <option value="Qualidade">Problema de Qualidade</option>
                                    <option value="Quarentena">Quarentena</option>
                                    <option value="Não Conformidade">Não Conformidade</option>
                                    <option value="Retorno Cliente">Retorno de Cliente</option>
                                    <option value="Análise Técnica">Análise Técnica</option>
                                    <option value="Outros">Outros</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="segregation-date" class="form-label">Data *</label>
                                <input type="date" class="form-control" id="segregation-date" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="segregation-quantity" class="form-label">Quantidade *</label>
                                <input type="number" class="form-control" id="segregation-quantity" min="1" required>
                            </div>
                            <div class="col-12 mb-3">
                                <label for="segregation-notes" class="form-label">Observações</label>
                                <textarea class="form-control" id="segregation-notes" rows="3" placeholder="Observações adicionais..."></textarea>
                            </div>
                        </div>
                        <p class="text-muted">* Campos obrigatórios</p>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="save-segregation">Salvar Segregação</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Visualizar Segregação -->
    <div class="modal fade" id="viewSegregationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalhes da Segregação</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <strong>Produto:</strong>
                            <p id="view-product-name" class="mb-2"></p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Lote:</strong>
                            <p id="view-batch" class="mb-2"></p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Motivo:</strong>
                            <p id="view-reason" class="mb-2"></p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Data:</strong>
                            <p id="view-date" class="mb-2"></p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Quantidade:</strong>
                            <p id="view-quantity" class="mb-2"></p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Status:</strong>
                            <p id="view-status" class="mb-2"></p>
                        </div>
                        <div class="col-12 mb-3">
                            <strong>Observações:</strong>
                            <p id="view-notes" class="mb-2"></p>
                        </div>
                    </div>
                    <div class="mt-4">
                        <h6>Alterar Status:</h6>
                        <div class="btn-group w-100" role="group">
                            <button type="button" class="btn btn-warning change-status" data-status="Ativo">Ativo</button>
                            <button type="button" class="btn btn-success change-status" data-status="Liberado">Liberado</button>
                            <button type="button" class="btn btn-danger change-status" data-status="Descartado">Descartado</button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Adicionar Lote -->
    <div class="modal fade" id="addBatchModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Adicionar Novo Lote</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="add-batch-form">
                        <input type="hidden" id="batch-product-sku">
                        <div class="mb-3">
                            <label for="new-batch-number" class="form-label">Número do Lote *</label>
                            <input type="text" class="form-control" id="new-batch-number" required>
                        </div>
                        <div class="mb-3">
                            <label for="new-batch-quantity" class="form-label">Quantidade *</label>
                            <input type="number" class="form-control" id="new-batch-quantity" min="1" required>
                        </div>
                        <div class="mb-3">
                            <label for="new-batch-manufacturing-date" class="form-label">Data de Fabricação *</label>
                            <input type="date" class="form-control" id="new-batch-manufacturing-date" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="save-new-batch">Salvar Lote</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Lote -->
    <div class="modal fade" id="editBatchModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Lote</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-batch-form">
                        <input type="hidden" id="edit-batch-id">
                        <div class="mb-3">
                            <label for="edit-batch-number" class="form-label">Número do Lote *</label>
                            <input type="text" class="form-control" id="edit-batch-number" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-batch-quantity" class="form-label">Quantidade *</label>
                            <input type="number" class="form-control" id="edit-batch-quantity" min="1" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-batch-manufacturing-date" class="form-label">Data de Fabricação *</label>
                            <input type="date" class="form-control" id="edit-batch-manufacturing-date" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="save-edit-batch">Salvar Alterações</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Movimentação de Paletes -->
    <div class="modal fade" id="editPaletesModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Movimentação de Paletes</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-paletes-form">
                        <input type="hidden" id="edit-paletes-id">
                        <div class="mb-3">
                            <label for="edit-paletes-date" class="form-label">Data</label>
                            <input type="date" class="form-control" id="edit-paletes-date" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-paletes-type" class="form-label">Tipo de Palete</label>
                            <select class="form-select" id="edit-paletes-type" required>
                                <option value="Fracionado">Fracionado</option>
                                <option value="Tambor">Tambor</option>
                                <option value="IBC 1000L">IBC 1000L</option>
                                <option value="Outro">Outro</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="edit-paletes-movement" class="form-label">Tipo de Movimento</label>
                            <select class="form-select" id="edit-paletes-movement" required>
                                <option value="Entrada">Entrada</option>
                                <option value="Saída">Saída</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="edit-paletes-quantity" class="form-label">Quantidade</label>
                            <input type="number" class="form-control" id="edit-paletes-quantity" min="1" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="save-edit-paletes">Salvar Alterações</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ========== CONFIGURAÇÃO DO FIREBASE ==========
        const firebaseConfig = {
            apiKey: "AIzaSyDOy0Ylpkkq9GZQLJmmpfkLwCorptjceV4",
            authDomain: "controlemovimentacao-cbd0d.firebaseapp.com",
            projectId: "controlemovimentacao-cbd0d",
            storageBucket: "controlemovimentacao-cbd0d.firebasestorage.app",
            messagingSenderId: "607751879879",
            appId: "1:607751879879:web:0b1bfd6f0beb95b95812e2"
        };

        // Inicialização do Firebase
        let firebaseApp, db, storage;
        let isFirebaseInitialized = false;

        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            storage = firebase.storage();
            isFirebaseInitialized = true;
            console.log("Firebase inicializado com sucesso");
            updateSyncStatus(true, "Conectado");
        } catch (error) {
            console.error("Erro ao inicializar Firebase:", error);
            updateSyncStatus(false, "Erro de conexão");
        }

        // ========== VARIÁVEIS GLOBAIS ==========
        let movementItems = [];
        let uploadedPhotos = [];
        let currentSegregationId = null;
        let currentEditPaletesId = null;

        // ========== NAVEGAÇÃO ENTRE PÁGINAS ==========
        function setupNavigation() {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const pageId = this.getAttribute('data-page');
                    showPage(pageId);
                    
                    // Atualizar navegação ativa
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
                
                // Atualizar dados específicos da página
                if (pageId === 'products-page') {
                    loadProductsData();
                } else if (pageId === 'report-page') {
                    loadProductsForMovement();
                } else if (pageId === 'stock-report-page') {
                    loadStockReport();
                } else if (pageId === 'paletes-page') {
                    loadPaletesData();
                } else if (pageId === 'dashboard-page') {
                    updateDashboard();
                } else if (pageId === 'segregated-products-page') {
                    loadSegregatedProducts();
                } else if (pageId === 'config-page') {
                    loadConfigSettings();
                }
            }
        }

        // ========== INICIALIZAÇÃO DE DADOS ==========
        function initializeData() {
            // Produtos
            if (!localStorage.getItem('productsData')) {
                const productsData = [
                    { 
                        SKU: "45277855", 
                        Produto: "SPIRAX S2 G 90 FR. 20LT.", 
                        Tipo: "Tambor", 
                        Quantidade: 2,
                        Lote: "329848",
                        'Data Fabricação': "2022-08-30",
                        Entradas: 2,
                        Saídas: 0,
                        id: 1
                    },
                    { 
                        SKU: "44227860", 
                        Produto: "RIMULA RS LE 10W40 AP CK 4 FR 20L", 
                        Tipo: "Tambor", 
                        Quantidade: 7,
                        Lote: "12015568",
                        'Data Fabricação': "2022-09-02",
                        Entradas: 7,
                        Saídas: 0,
                        id: 2
                    },
                    { 
                        SKU: "45880860", 
                        Produto: "REFRIGERATION OIL S4 FR-F 100 BALDE", 
                        Tipo: "Balde", 
                        Quantidade: 24,
                        Lote: "5012200299",
                        'Data Fabricação': "2022-10-05",
                        Entradas: 24,
                        Saídas: 0,
                        id: 3
                    }
                ];
                localStorage.setItem('productsData', JSON.stringify(productsData));
            }
            
            // Histórico de movimentações
            if (!localStorage.getItem('movementHistory')) {
                const today = new Date().toISOString().split('T')[0];
                const movementHistory = [
                    {
                        id: 1,
                        timestamp: new Date().toISOString(),
                        date: today,
                        movementType: 'Entrada',
                        productSKU: '45277855',
                        productName: 'SPIRAX S2 G 90 FR. 20LT.',
                        quantity: 2,
                        productType: 'Tambor',
                        batch: '329848',
                        manufacturingDate: '2022-08-30'
                    }
                ];
                localStorage.setItem('movementHistory', JSON.stringify(movementHistory));
            }
            
            // Relatórios de estoque
            if (!localStorage.getItem('reportsHistory')) {
                const today = new Date().toISOString().split('T')[0];
                const reportsHistory = [
                    {
                        reportNumber: 1,
                        date: today,
                        timestamp: new Date().toISOString(),
                        items: [
                            {
                                date: today,
                                movementType: 'Entrada',
                                productName: 'SPIRAX S2 G 90 FR. 20LT.',
                                quantity: 2,
                                productType: 'Tambor',
                                batch: '329848',
                                manufacturingDate: '2022-08-30'
                            }
                        ]
                    }
                ];
                localStorage.setItem('reportsHistory', JSON.stringify(reportsHistory));
            }
            
            // Movimentação de paletes
            if (!localStorage.getItem('paletesData')) {
                const today = new Date().toISOString().split('T')[0];
                const paletesData = [
                    {
                        id: 1,
                        date: "2025-10-14",
                        reportNumber: 8,
                        items: [
                            { type: 'Tambor', movement: 'Saída', quantity: 8 },
                            { type: 'Fracionado', movement: 'Entrada', quantity: 6 },
                            { type: 'Tambor', movement: 'Entrada', quantity: 12 },
                            { type: 'IBC 1000L', movement: 'Entrada', quantity: 48 }
                        ]
                    }
                ];
                localStorage.setItem('paletesData', JSON.stringify(paletesData));
            }

            // Produtos segregados
            if (!localStorage.getItem('segregatedProducts')) {
                const segregatedProducts = [];
                localStorage.setItem('segregatedProducts', JSON.stringify(segregatedProducts));
            }

            // Números de relatório
            if (!localStorage.getItem('lastReportNumber')) {
                localStorage.setItem('lastReportNumber', '1');
            }
            if (!localStorage.getItem('lastPaletesReportNumber')) {
                localStorage.setItem('lastPaletesReportNumber', '8');
            }
        }

        // ========== CONFIGURAÇÃO DE EVENTOS DOS BOTÕES ==========
        function setupEventListeners() {
            // Dashboard
            document.getElementById('paletes-filter-type')?.addEventListener('change', updateDashboardPaletes);
            
            // Relatório de Estoque
            document.getElementById('apply-stock-filters')?.addEventListener('click', loadStockReport);
            document.getElementById('reset-stock-filters')?.addEventListener('click', resetStockFilters);
            document.getElementById('generate-stock-pdf')?.addEventListener('click', generateStockPDF);
            document.getElementById('generate-stock-excel')?.addEventListener('click', generateStockExcel);
            
            // Cadastro de Movimentação - BOTÕES MODIFICADOS
            document.getElementById('input-product')?.addEventListener('change', updateLotesOnProductChange);
            document.getElementById('input-movementType')?.addEventListener('change', updateLotesOnProductChange);
            document.getElementById('add-to-table')?.addEventListener('click', addItemToTable);
            document.getElementById('save-and-generate-pdf')?.addEventListener('click', saveAndGeneratePDF);
            document.getElementById('save-and-generate-pdf-bottom')?.addEventListener('click', saveAndGeneratePDF);
            document.getElementById('clear-movement')?.addEventListener('click', clearMovement);
            
            // NOVO: Evento para upload de fotos
            document.getElementById('input-photos')?.addEventListener('change', handlePhotoUpload);
            
            // Estoque de Produtos
            document.getElementById('add-product')?.addEventListener('click', showAddProductModal);
            document.getElementById('save-product')?.addEventListener('click', saveProduct);
            document.getElementById('apply-products-filters')?.addEventListener('click', loadProductsData);
            document.getElementById('reset-products-filters')?.addEventListener('click', resetProductsFilters);
            document.getElementById('export-products-excel')?.addEventListener('click', exportProductsExcel);
            
            // Movimentação de Paletes
            document.getElementById('apply-paletes-filters')?.addEventListener('click', loadPaletesData);
            document.getElementById('reset-paletes-filters')?.addEventListener('click', resetPaletesFilters);
            document.getElementById('add-paletes-item')?.addEventListener('click', addPaletesItem);
            document.getElementById('generate-paletes-pdf')?.addEventListener('click', generatePaletesPDF);
            document.getElementById('generate-paletes-excel')?.addEventListener('click', generatePaletesExcel);
            document.getElementById('save-edit-paletes')?.addEventListener('click', saveEditPaletes);
            
            // Produtos Segregados
            document.getElementById('add-segregation')?.addEventListener('click', showAddSegregationModal);
            document.getElementById('save-segregation')?.addEventListener('click', addSegregation);
            document.getElementById('apply-segregation-filters')?.addEventListener('click', loadSegregatedProducts);
            document.getElementById('reset-segregation-filters')?.addEventListener('click', resetSegregationFilters);
            
            // Configurações
            document.getElementById('save-config-btn')?.addEventListener('click', saveConfigSettings);
            document.getElementById('sync-to-firebase')?.addEventListener('click', syncToFirebase);
            document.getElementById('sync-from-firebase')?.addEventListener('click', syncFromFirebase);

            // Adicionar Lote
            document.getElementById('save-new-batch')?.addEventListener('click', addNewBatch);
            
            // Editar Lote
            document.getElementById('save-edit-batch')?.addEventListener('click', saveEditBatch);
        }

        // ========== FUNÇÕES DOS BOTÕES ==========

        // Dashboard
        function updateDashboardPaletes() {
            const filterType = document.getElementById('paletes-filter-type').value;
            updateDashboard();
        }

        function updateDashboard() {
            // Atualizar estatísticas
            const productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
            const movementHistory = JSON.parse(localStorage.getItem('movementHistory') || '[]');
            const paletesData = JSON.parse(localStorage.getItem('paletesData') || '[]');
            
            // Total de produtos
            const totalProducts = productsData.reduce((sum, product) => sum + product.Quantidade, 0);
            document.getElementById('total-products').textContent = totalProducts;
            
            // Movimentações de hoje
            const today = new Date().toISOString().split('T')[0];
            const todayMovements = movementHistory.filter(m => m.date === today);
            const entradas = todayMovements.filter(m => m.movementType === 'Entrada').reduce((sum, m) => sum + m.quantity, 0);
            const saidas = todayMovements.filter(m => m.movementType === 'Saída').reduce((sum, m) => sum + m.quantity, 0);
            
            document.getElementById('total-entradas').textContent = entradas;
            document.getElementById('total-saidas').textContent = saidas;
            
            // Alertas (produtos com quantidade baixa)
            const alertCount = productsData.filter(p => p.Quantidade < 10).length;
            document.getElementById('total-alertas').textContent = alertCount;
            
            // Atualizar tabelas
            updateRecentMovements();
            updatePaletesMovements();
            updateProductStatus();
            updateExpiringProductsTable();
        }

        function updateRecentMovements() {
            const movementHistory = JSON.parse(localStorage.getItem('movementHistory') || '[]');
            
            // Movimentações de produtos (Semanal)
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const weeklyMovements = movementHistory.filter(m => new Date(m.date) >= weekAgo);
            const weeklyTbody = document.getElementById('weekly-products-movements');
            
            weeklyTbody.innerHTML = '';
            
            if (weeklyMovements.length === 0) {
                weeklyTbody.innerHTML = '<tr><td colspan="3" class="text-center">Nenhuma movimentação esta semana</td></tr>';
            } else {
                // Agrupar por tipo e movimento
                const groupedData = {};
                weeklyMovements.forEach(movement => {
                    const key = `${movement.productType}-${movement.movementType}`;
                    if (!groupedData[key]) {
                        groupedData[key] = {
                            type: movement.productType,
                            movement: movement.movementType,
                            quantity: 0
                        };
                    }
                    groupedData[key].quantity += movement.quantity;
                });
                
                Object.values(groupedData).forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.type}</td>
                        <td>${item.movement}</td>
                        <td>${item.quantity}</td>
                    `;
                    weeklyTbody.appendChild(row);
                });
            }
            
            // Movimentações de produtos (Mensal)
            const monthAgo = new Date();
            monthAgo.setMonth(monthAgo.getMonth() - 1);
            const monthlyMovements = movementHistory.filter(m => new Date(m.date) >= monthAgo);
            const monthlyTbody = document.getElementById('monthly-products-movements');
            
            monthlyTbody.innerHTML = '';
            
            if (monthlyMovements.length === 0) {
                monthlyTbody.innerHTML = '<tr><td colspan="3" class="text-center">Nenhuma movimentação este mês</td></tr>';
            } else {
                // Agrupar por tipo e movimento
                const groupedData = {};
                monthlyMovements.forEach(movement => {
                    const key = `${movement.productType}-${movement.movementType}`;
                    if (!groupedData[key]) {
                        groupedData[key] = {
                            type: movement.productType,
                            movement: movement.movementType,
                            quantity: 0
                        };
                    }
                    groupedData[key].quantity += movement.quantity;
                });
                
                Object.values(groupedData).forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.type}</td>
                        <td>${item.movement}</td>
                        <td>${item.quantity}</td>
                    `;
                    monthlyTbody.appendChild(row);
                });
            }
        }

        function updatePaletesMovements() {
            const paletesData = JSON.parse(localStorage.getItem('paletesData') || '[]');
            
            // Movimentações de paletes (Semanal)
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const weeklyPaletes = paletesData.filter(p => new Date(p.date) >= weekAgo);
            const weeklyTbody = document.getElementById('weekly-paletes-movements');
            
            weeklyTbody.innerHTML = '';
            
            if (weeklyPaletes.length === 0) {
                weeklyTbody.innerHTML = '<tr><td colspan="3" class="text-center">Nenhuma movimentação esta semana</td></tr>';
            } else {
                // Agrupar por tipo e movimento
                const groupedData = {};
                weeklyPaletes.forEach(report => {
                    report.items.forEach(item => {
                        const key = `${item.type}-${item.movement}`;
                        if (!groupedData[key]) {
                            groupedData[key] = {
                                type: item.type,
                                movement: item.movement,
                                quantity: 0
                            };
                        }
                        groupedData[key].quantity += item.quantity;
                    });
                });
                
                Object.values(groupedData).forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.type}</td>
                        <td>${item.movement}</td>
                        <td>${item.quantity}</td>
                    `;
                    weeklyTbody.appendChild(row);
                });
            }
            
            // Movimentações de paletes (Mensal)
            const monthAgo = new Date();
            monthAgo.setMonth(monthAgo.getMonth() - 1);
            const monthlyPaletes = paletesData.filter(p => new Date(p.date) >= monthAgo);
            const monthlyTbody = document.getElementById('monthly-paletes-movements');
            
            monthlyTbody.innerHTML = '';
            
            if (monthlyPaletes.length === 0) {
                monthlyTbody.innerHTML = '<tr><td colspan="2" class="text-center">Nenhuma movimentação este mês</td></tr>';
            } else {
                // Agrupar por movimento
                const groupedData = {};
                monthlyPaletes.forEach(report => {
                    report.items.forEach(item => {
                        if (!groupedData[item.movement]) {
                            groupedData[item.movement] = {
                                movement: item.movement,
                                quantity: 0
                            };
                        }
                        groupedData[item.movement].quantity += item.quantity;
                    });
                });
                
                Object.values(groupedData).forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.movement}</td>
                        <td>${item.quantity}</td>
                    `;
                    monthlyTbody.appendChild(row);
                });
            }
        }

        function updateProductStatus() {
            const productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
            
            // Contar produtos por status
            let validCount = 0;
            let warningCount = 0;
            let expiredCount = 0;
            
            productsData.forEach(product => {
                const status = getProductStatus(product['Data Fabricação']);
                if (status === 'Dentro do Prazo') validCount++;
                else if (status === 'Vencimento Próximo') warningCount++;
                else if (status === 'Vencido') expiredCount++;
            });
            
            document.getElementById('count-valid').textContent = validCount;
            document.getElementById('count-warning').textContent = warningCount;
            document.getElementById('count-expired').textContent = expiredCount;
        }

        // NOVA FUNÇÃO: Atualizar tabela de produtos com vencimento próximo
        function updateExpiringProductsTable() {
            const productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
            const tbody = document.getElementById('expiring-products-table');
            tbody.innerHTML = '';
            
            // Filtrar produtos com vencimento próximo ou vencidos
            const expiringProducts = productsData.filter(p => {
                const status = getProductStatus(p['Data Fabricação']);
                return status === 'Vencimento Próximo' || status === 'Vencido';
            }).slice(0, 10); // Limitar a 10 produtos
            
            if (expiringProducts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center">Nenhum produto com vencimento próximo</td></tr>';
                return;
            }
            
            expiringProducts.forEach(product => {
                const expiryDate = getExpiryDate(product['Data Fabricação']);
                const status = getProductStatus(product['Data Fabricação']);
                const statusBadge = status === 'Vencimento Próximo' ? '<span class="badge bg-warning">Vencimento Próximo</span>' : 
                                  '<span class="badge bg-danger">Vencido</span>';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="fw-bold">${product.Produto}</div>
                        <small class="text-muted">SKU: ${product.SKU} | Lote: ${product.Lote}</small>
                        <div>${statusBadge}</div>
                    </td>
                    <td>${formatDate(expiryDate)}</td>
                    <td class="text-center fw-bold">${product.Quantidade}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Relatório de Estoque - AGORA EXPANSÍVEL
        function loadStockReport() {
            const filterDate = document.getElementById('stock-filter-date').value;
            const filterProduct = document.getElementById('stock-filter-product').value.toLowerCase();
            
            const movementHistory = JSON.parse(localStorage.getItem('movementHistory') || '[]');
            const container = document.getElementById('stock-report-container');
            
            container.innerHTML = '';
            
            let filteredData = movementHistory;
            
            if (filterDate) {
                filteredData = filteredData.filter(m => m.date === filterDate);
            }
            
            if (filterProduct) {
                filteredData = filteredData.filter(m => 
                    m.productName.toLowerCase().includes(filterProduct) || 
                    m.productSKU.toLowerCase().includes(filterProduct)
                );
            }
            
            if (filteredData.length === 0) {
                container.innerHTML = '<div class="text-center p-3 text-muted">Nenhum dado encontrado</div>';
                return;
            }
            
            // Agrupar por data
            const groupedByDate = {};
            filteredData.forEach(movement => {
                if (!groupedByDate[movement.date]) {
                    groupedByDate[movement.date] = [];
                }
                groupedByDate[movement.date].push(movement);
            });
            
            // Criar elementos expansíveis para cada data
            Object.keys(groupedByDate).sort().reverse().forEach(date => {
                const dateMovements = groupedByDate[date];
                
                const reportElement = document.createElement('div');
                reportElement.className = 'report-line';
                reportElement.innerHTML = `
                    <div class="report-header">
                        <span>${formatDate(date)} - ${dateMovements.length} movimentação(ões)</span>
                        <div class="report-actions">
                            <button class="btn btn-sm btn-danger delete-report" data-date="${date}">
                                <i class="bi bi-trash"></i>
                            </button>
                            <i class="bi bi-chevron-down"></i>
                        </div>
                    </div>
                    <div class="report-details" style="display: none;">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Produto</th>
                                        <th>Tipo</th>
                                        <th>Lote</th>
                                        <th>Movimento</th>
                                        <th>Quantidade</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${dateMovements.map(movement => `
                                        <tr>
                                            <td>${movement.productName}</td>
                                            <td>${movement.productType}</td>
                                            <td>${movement.batch}</td>
                                            <td>${movement.movementType}</td>
                                            <td>${movement.quantity}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                container.appendChild(reportElement);
                
                // Adicionar evento de clique para expandir/recolher
                const header = reportElement.querySelector('.report-header');
                const details = reportElement.querySelector('.report-details');
                const icon = reportElement.querySelector('.bi-chevron-down');
                
                header.addEventListener('click', (e) => {
                    // Não expandir/recolher se clicar nos botões de ação
                    if (!e.target.closest('.delete-report')) {
                        const isVisible = details.style.display !== 'none';
                        details.style.display = isVisible ? 'none' : 'block';
                        icon.className = isVisible ? 'bi bi-chevron-down' : 'bi bi-chevron-up';
                    }
                });
                
                // Adicionar evento para o botão de excluir
                const deleteBtn = reportElement.querySelector('.delete-report');
                deleteBtn.addEventListener('click', function() {
                    const date = this.getAttribute('data-date');
                    deleteReportByDate(date);
                });
            });
        }

        // NOVA FUNÇÃO: Excluir relatório por data
        function deleteReportByDate(date) {
            if (confirm(`Tem certeza que deseja excluir o relatório do dia ${formatDate(date)}?`)) {
                let movementHistory = JSON.parse(localStorage.getItem('movementHistory') || '[]');
                movementHistory = movementHistory.filter(m => m.date !== date);
                localStorage.setItem('movementHistory', JSON.stringify(movementHistory));
                loadStockReport();
                updateDashboard();
                alert('Relatório excluído com sucesso!');
            }
        }

        function resetStockFilters() {
            document.getElementById('stock-filter-date').value = '';
            document.getElementById('stock-filter-product').value = '';
            loadStockReport();
        }

        function generateStockPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Título
            doc.setFontSize(20);
            doc.text('Relatório de Estoque', 105, 15, { align: 'center' });
            
            // Data do relatório
            const reportDate = document.getElementById('stock-filter-date').value || new Date().toISOString().split('T')[0];
            doc.setFontSize(12);
            doc.text(`Data: ${formatDate(reportDate)}`, 14, 25);
            
            // Cabeçalho da tabela
            const headers = [['Data', 'Produto', 'Tipo', 'Lote', 'Entradas', 'Saídas', 'Saldo']];
            
            // Dados da tabela
            const movementHistory = JSON.parse(localStorage.getItem('movementHistory') || '[]');
            let filteredData = movementHistory;
            
            if (reportDate) {
                filteredData = filteredData.filter(m => m.date === reportDate);
            }
            
            // Agrupar por produto e data
            const groupedData = {};
            filteredData.forEach(movement => {
                const key = `${movement.date}-${movement.productSKU}-${movement.batch}`;
                if (!groupedData[key]) {
                    groupedData[key] = {
                        date: movement.date,
                        productName: movement.productName,
                        productType: movement.productType,
                        batch: movement.batch,
                        entradas: 0,
                        saidas: 0
                    };
                }
                
                if (movement.movementType === 'Entrada') {
                    groupedData[key].entradas += movement.quantity;
                } else if (movement.movementType === 'Saída') {
                    groupedData[key].saidas += movement.quantity;
                }
            });
            
            const rows = Object.values(groupedData).map(item => [
                formatDate(item.date),
                item.productName,
                item.productType,
                item.batch,
                item.entradas.toString(),
                item.saidas.toString(),
                (item.entradas - item.saidas).toString()
            ]);
            
            if (rows.length === 0) {
                doc.text('Nenhum dado encontrado', 14, 35);
            } else {
                // Gerar tabela
                doc.autoTable({
                    head: headers,
                    body: rows,
                    startY: 35,
                    styles: { fontSize: 10 },
                    headStyles: { fillColor: [52, 58, 64] }
                });
            }
            
            // Salvar PDF
            doc.save(`relatorio_estoque_${reportDate}.pdf`);
        }

        function generateStockExcel() {
            // Criar workbook
            const wb = XLSX.utils.book_new();
            
            // Obter dados
            const reportDate = document.getElementById('stock-filter-date').value || new Date().toISOString().split('T')[0];
            const movementHistory = JSON.parse(localStorage.getItem('movementHistory') || '[]');
            let filteredData = movementHistory;
            
            if (reportDate) {
                filteredData = filteredData.filter(m => m.date === reportDate);
            }
            
            // Agrupar por produto e data
            const groupedData = {};
            filteredData.forEach(movement => {
                const key = `${movement.date}-${movement.productSKU}-${movement.batch}`;
                if (!groupedData[key]) {
                    groupedData[key] = {
                        date: movement.date,
                        productName: movement.productName,
                        productType: movement.productType,
                        batch: movement.batch,
                        entradas: 0,
                        saidas: 0
                    };
                }
                
                if (movement.movementType === 'Entrada') {
                    groupedData[key].entradas += movement.quantity;
                } else if (movement.movementType === 'Saída') {
                    groupedData[key].saidas += movement.quantity;
                }
            });
            
            const data = [['Data', 'Produto', 'Tipo', 'Lote', 'Entradas', 'Saídas', 'Saldo']];
            
            Object.values(groupedData).forEach(item => {
                data.push([
                    formatDate(item.date),
                    item.productName,
                    item.productType,
                    item.batch,
                    item.entradas,
                    item.saidas,
                    item.entradas - item.saidas
                ]);
            });
            
            if (data.length === 1) {
                data.push(['Nenhum dado encontrado']);
            }
            
            // Criar worksheet
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // Adicionar worksheet ao workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Relatório de Estoque');
            
            // Gerar e salvar arquivo
            XLSX.writeFile(wb, `relatorio_estoque_${reportDate}.xlsx`);
        }

        // Cadastro de Movimentação
        function loadProductsForMovement() {
            const productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
            const productSelect = document.getElementById('input-product');
            
            productSelect.innerHTML = '<option value="">Selecione um produto</option>';
            
            const uniqueProducts = [...new Set(productsData.map(p => p.SKU))];
            uniqueProducts.forEach(sku => {
                const product = productsData.find(p => p.SKU === sku);
                if (product) {
                    const option = document.createElement('option');
                    option.value = sku;
                    option.textContent = `${product.Produto} (${sku})`;
                    productSelect.appendChild(option);
                }
            });
        }

        // NOVA FUNÇÃO: Atualizar lotes quando produto é selecionado
        function updateLotesOnProductChange() {
            const productSKU = document.getElementById('input-product').value;
            const movementType = document.getElementById('input-movementType').value;
            
            if (productSKU && movementType) {
                loadLotesForProduct();
            }
        }

        function loadLotesForProduct() {
            const productSKU = document.getElementById('input-product').value;
            const movementType = document.getElementById('input-movementType').value;
            const loteSelect = document.getElementById('input-lote');
            
            loteSelect.innerHTML = '<option value="">Selecione um lote</option>';
            
            if (!productSKU) return;
            
            const productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
            const productLotes = productsData.filter(p => p.SKU === productSKU && p.Quantidade > 0);
            
            if (productLotes.length === 0) {
                const option = document.createElement('option');
                option.value = 'NOVO_LOTE';
                option.textContent = 'Novo Lote (Sem lotes disponíveis)';
                loteSelect.appendChild(option);
            } else {
                productLotes.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.Lote;
                    option.textContent = `${product.Lote} - ${product.Quantidade} unidades disponíveis`;
                    loteSelect.appendChild(option);
                });
                
                if (movementType === 'Entrada') {
                    const newLoteOption = document.createElement('option');
                    newLoteOption.value = 'NOVO_LOTE';
                    newLoteOption.textContent = '➕ Criar Novo Lote';
                    loteSelect.appendChild(newLoteOption);
                }
            }
        }

        function handlePhotoUpload(event) {
            const files = event.target.files;
            const previewContainer = document.getElementById('photo-preview-container');
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const photoData = {
                            id: Date.now() + i,
                            name: file.name,
                            dataUrl: e.target.result
                        };
                        
                        uploadedPhotos.push(photoData);
                        updatePhotoPreview();
                    };
                    
                    reader.readAsDataURL(file);
                }
            }
            
            // Limpar o input
            event.target.value = '';
        }

        function updatePhotoPreview() {
            const previewContainer = document.getElementById('photo-preview-container');
            previewContainer.innerHTML = '';
            
            uploadedPhotos.forEach(photo => {
                const photoElement = document.createElement('div');
                photoElement.className = 'document-item';
                photoElement.innerHTML = `
                    <img src="${photo.dataUrl}" class="photo-preview" alt="${photo.name}">
                    <div class="document-name">${photo.name}</div>
                    <button type="button" class="btn btn-sm btn-danger mt-1 remove-photo" data-id="${photo.id}">
                        <i class="bi bi-trash"></i>
                    </button>
                `;
                previewContainer.appendChild(photoElement);
            });
            
            // Adicionar eventos para remover fotos
            document.querySelectorAll('.remove-photo').forEach(btn => {
                btn.addEventListener('click', function() {
                    const photoId = parseInt(this.getAttribute('data-id'));
                    uploadedPhotos = uploadedPhotos.filter(p => p.id !== photoId);
                    updatePhotoPreview();
                });
            });
        }

        function addItemToTable() {
            const productSelect = document.getElementById('input-product');
            const movementType = document.getElementById('input-movementType').value;
            const quantity = document.getElementById('input-quantity').value;
            const lote = document.getElementById('input-lote').value;
            const date = document.getElementById('input-date').value;
            
            if (!productSelect.value || !movementType || !quantity || !date) {
                alert('Preencha todos os campos obrigatórios!');
                return;
            }
            
            const productText = productSelect.options[productSelect.selectedIndex].text;
            const productType = getProductType(productSelect.value);
            
            // Adicionar item ao array
            movementItems.push({
                productSKU: productSelect.value,
                productName: productText,
                productType: productType,
                movementType: movementType,
                quantity: parseInt(quantity),
                batch: lote || 'N/A',
                date: date
            });
            
            updateMovementTable();
            
            // Limpar campos
            document.getElementById('input-quantity').value = '';
            document.getElementById('input-lote').value = '';
        }

        function updateMovementTable() {
            const tableBody = document.getElementById('movement-table');
            tableBody.innerHTML = '';
            
            if (movementItems.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Nenhum item adicionado</td></tr>';
                return;
            }
            
            movementItems.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.productName}</td>
                    <td>${item.productType}</td>
                    <td>${item.batch}</td>
                    <td>${item.movementType}</td>
                    <td>${item.quantity}</td>
                    <td>
                        <button class="btn btn-sm btn-danger remove-item" data-index="${index}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Adicionar eventos para remover itens
            document.querySelectorAll('.remove-item').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    movementItems.splice(index, 1);
                    updateMovementTable();
                });
            });
        }

        // NOVA FUNÇÃO: Salvar e Gerar PDF (combina as duas funcionalidades)
        function saveAndGeneratePDF() {
            if (movementItems.length === 0) {
                alert('Adicione pelo menos um item antes de salvar!');
                return;
            }
            
            // Salvar a movimentação
            const movementHistory = JSON.parse(localStorage.getItem('movementHistory') || '[]');
            const newId = movementHistory.length > 0 ? Math.max(...movementHistory.map(m => m.id)) + 1 : 1;
            
            movementItems.forEach(item => {
                movementHistory.push({
                    id: newId,
                    timestamp: new Date().toISOString(),
                    date: item.date,
                    movementType: item.movementType,
                    productSKU: item.productSKU,
                    productName: item.productName,
                    quantity: item.quantity,
                    productType: item.productType,
                    batch: item.batch,
                    manufacturingDate: new Date().toISOString().split('T')[0],
                    photos: uploadedPhotos.map(photo => ({
                        name: photo.name,
                        dataUrl: photo.dataUrl
                    }))
                });
            });
            
            localStorage.setItem('movementHistory', JSON.stringify(movementHistory));
            
            // Atualizar estoque
            updateStockFromMovement();
            
            // Gerar PDF imediatamente após salvar
            generateMovementPDF();
            
            alert('Movimentação salva e PDF gerado com sucesso!');
            
            // Limpar o formulário
            clearMovement();
            updateDashboard();
        }

        function updateStockFromMovement() {
            const productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
            
            movementItems.forEach(movement => {
                if (movement.movementType === 'Entrada') {
                    // Adicionar entrada
                    const newProduct = {
                        SKU: movement.productSKU,
                        Produto: movement.productName,
                        Tipo: movement.productType,
                        Quantidade: movement.quantity,
                        Lote: movement.batch === 'NOVO_LOTE' ? `LOTE-${Date.now()}` : movement.batch,
                        'Data Fabricação': new Date().toISOString().split('T')[0],
                        Entradas: movement.quantity,
                        Saídas: 0,
                        id: productsData.length > 0 ? Math.max(...productsData.map(p => p.id)) + 1 : 1
                    };
                    productsData.push(newProduct);
                } else if (movement.movementType === 'Saída') {
                    // Processar saída
                    let remainingQuantity = movement.quantity;
                    
                    // Encontrar produtos do mesmo SKU ordenados por data de fabricação (mais antigos primeiro)
                    const sameSKUProducts = productsData
                        .filter(p => p.SKU === movement.productSKU && p.Quantidade > 0)
                        .sort((a, b) => new Date(a['Data Fabricação']) - new Date(b['Data Fabricação']));
                    
                    for (let product of sameSKUProducts) {
                        if (remainingQuantity <= 0) break;
                        
                        const quantityToDeduct = Math.min(product.Quantidade, remainingQuantity);
                        product.Quantidade -= quantityToDeduct;
                        product.Saídas += quantityToDeduct;
                        remainingQuantity -= quantityToDeduct;
                    }
                    
                    if (remainingQuantity > 0) {
                        alert(`Atenção: Não foi possível deduzir ${remainingQuantity} unidades do estoque. Estoque insuficiente.`);
                    }
                }
            });
            
            localStorage.setItem('productsData', JSON.stringify(productsData));
        }

        function clearMovement() {
            document.getElementById('movement-form').reset();
            movementItems = [];
            uploadedPhotos = [];
            updateMovementTable();
            updatePhotoPreview();
            loadProductsForMovement();
        }

        function generateMovementPDF() {
            if (movementItems.length === 0) {
                alert('Adicione itens antes de gerar o PDF!');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Título
            doc.setFontSize(20);
            doc.text('Relatório de Movimentação', 105, 15, { align: 'center' });
            
            // Data
            const date = document.getElementById('input-date').value || new Date().toISOString().split('T')[0];
            doc.setFontSize(12);
            doc.text(`Data: ${formatDate(date)}`, 14, 25);
            
            // Cabeçalho da tabela
            const headers = [['Produto', 'Tipo', 'Lote', 'Movimento', 'Quantidade']];
            
            // Dados da tabela
            const rows = movementItems.map(item => [
                item.productName,
                item.productType,
                item.batch,
                item.movementType,
                item.quantity.toString()
            ]);
            
            // Gerar tabela
            doc.autoTable({
                head: headers,
                body: rows,
                startY: 35,
                styles: { fontSize: 10 },
                headStyles: { fillColor: [52, 58, 64] }
            });
            
            let yPosition = doc.lastAutoTable.finalY + 10;
            
            // Adicionar fotos ao PDF se houver
            if (uploadedPhotos.length > 0) {
                doc.setFontSize(14);
                doc.text('Fotos Anexadas:', 14, yPosition);
                yPosition += 10;
                
                // Adicionar fotos (máximo 2 por linha)
                const photoWidth = 80;
                const photoHeight = 60;
                const margin = 10;
                
                for (let i = 0; i < uploadedPhotos.length; i++) {
                    const col = i % 2;
                    const row = Math.floor(i / 2);
                    
                    const x = 14 + col * (photoWidth + margin);
                    const y = yPosition + row * (photoHeight + margin);
                    
                    // Verificar se precisa de nova página
                    if (y + photoHeight > doc.internal.pageSize.height - 20) {
                        doc.addPage();
                        yPosition = 20;
                        // Redefinir posições para nova página
                        const newCol = i % 2;
                        const newRow = 0;
                        const newX = 14 + newCol * (photoWidth + margin);
                        const newY = yPosition;
                        try {
                            doc.addImage(uploadedPhotos[i].dataUrl, 'JPEG', newX, newY, photoWidth, photoHeight);
                            doc.setFontSize(8);
                            doc.text(uploadedPhotos[i].name, newX, newY + photoHeight + 5);
                        } catch (error) {
                            console.error('Erro ao adicionar imagem:', error);
                        }
                    } else {
                        try {
                            doc.addImage(uploadedPhotos[i].dataUrl, 'JPEG', x, y, photoWidth, photoHeight);
                            doc.setFontSize(8);
                            doc.text(uploadedPhotos[i].name, x, y + photoHeight + 5);
                        } catch (error) {
                            console.error('Erro ao adicionar imagem:', error);
                        }
                    }
                }
            }
            
            // Salvar PDF
            doc.save(`movimentacao_${date}.pdf`);
        }

        // Estoque de Produtos - AGORA EXPANSÍVEL
        function loadProductsData() {
            const filterSKU = document.getElementById('products-filter-sku').value.toLowerCase();
            const filterName = document.getElementById('products-filter-name').value.toLowerCase();
            const filterType = document.getElementById('products-filter-type').value;
            
            const productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
            const container = document.getElementById('products-container');
            
            container.innerHTML = '';
            
            let filteredData = productsData;
            
            if (filterSKU) {
                filteredData = filteredData.filter(p => p.SKU.toLowerCase().includes(filterSKU));
            }
            
            if (filterName) {
                filteredData = filteredData.filter(p => p.Produto.toLowerCase().includes(filterName));
            }
            
            if (filterType) {
                filteredData = filteredData.filter(p => p.Tipo === filterType);
            }
            
            if (filteredData.length === 0) {
                container.innerHTML = '<div class="text-center p-3 text-muted">Nenhum produto encontrado</div>';
                return;
            }
            
            // Agrupar por SKU
            const groupedData = {};
            filteredData.forEach(product => {
                if (!groupedData[product.SKU]) {
                    groupedData[product.SKU] = {
                        SKU: product.SKU,
                        Produto: product.Produto,
                        Tipo: product.Tipo,
                        QuantidadeTotal: 0,
                        Lotes: []
                    };
                }
                groupedData[product.SKU].QuantidadeTotal += product.Quantidade;
                groupedData[product.SKU].Lotes.push({
                    id: product.id,
                    lote: product.Lote,
                    quantidade: product.Quantidade,
                    fabricacao: product['Data Fabricação']
                });
            });
            
            // Criar elementos expansíveis para cada produto
            Object.values(groupedData).forEach(product => {
                const productElement = document.createElement('div');
                productElement.className = 'report-line';
                productElement.innerHTML = `
                    <div class="report-header">
                        <div class="d-flex justify-content-between align-items-center w-100">
                            <div>
                                <strong>${product.Produto}</strong> 
                                <span class="text-muted">(${product.SKU}) - ${product.Tipo}</span>
                                <span class="badge bg-primary ms-2">Total: ${product.QuantidadeTotal}</span>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-success me-1 add-batch-btn" data-sku="${product.SKU}">
                                    <i class="bi bi-plus-circle"></i> Novo Lote
                                </button>
                                <button class="btn btn-sm btn-warning me-1 edit-product-btn" data-sku="${product.SKU}">
                                    <i class="bi bi-pencil"></i> Editar Produto
                                </button>
                                <i class="bi bi-chevron-down"></i>
                            </div>
                        </div>
                    </div>
                    <div class="report-details" style="display: none;">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Lote</th>
                                        <th>Quantidade</th>
                                        <th>Data Fabricação</th>
                                        <th>Data Vencimento</th>
                                        <th>Status</th>
                                        <th class="text-center">Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${product.Lotes.map(lote => {
                                        const status = getProductStatus(lote.fabricacao);
                                        const statusClass = status === 'Vencido' ? 'status-expired' : 
                                                           status === 'Vencimento Próximo' ? 'status-warning' : 'status-valid';
                                        const expiryDate = getExpiryDate(lote.fabricacao);
                                        return `
                                        <tr>
                                            <td>${lote.lote}</td>
                                            <td>${lote.quantidade}</td>
                                            <td>${formatDate(lote.fabricacao)}</td>
                                            <td>${formatDate(expiryDate)}</td>
                                            <td><span class="${statusClass}">${status}</span></td>
                                            <td class="text-center">
                                                <button class="btn btn-sm btn-warning me-1 edit-batch" data-id="${lote.id}">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="btn btn-sm btn-danger delete-batch" data-id="${lote.id}">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `}).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                container.appendChild(productElement);
                
                // Adicionar evento de clique para expandir/recolher
                const header = productElement.querySelector('.report-header');
                const details = productElement.querySelector('.report-details');
                const icon = productElement.querySelector('.bi-chevron-down');
                
                header.addEventListener('click', (e) => {
                    // Não expandir/recolher se clicar nos botões de ação
                    if (!e.target.closest('.add-batch-btn') && !e.target.closest('.edit-product-btn')) {
                        const isVisible = details.style.display !== 'none';
                        details.style.display = isVisible ? 'none' : 'block';
                        icon.className = isVisible ? 'bi bi-chevron-down' : 'bi bi-chevron-up';
                    }
                });
                
                // Adicionar evento para o botão de adicionar lote
                const addBatchBtn = productElement.querySelector('.add-batch-btn');
                addBatchBtn.addEventListener('click', function() {
                    const sku = this.getAttribute('data-sku');
                    showAddBatchModal(sku);
                });
                
                // Adicionar evento para o botão de editar produto
                const editProductBtn = productElement.querySelector('.edit-product-btn');
                editProductBtn.addEventListener('click', function() {
                    const sku = this.getAttribute('data-sku');
                    editProduct(sku);
                });
                
                // Adicionar eventos para editar e excluir lotes
                productElement.querySelectorAll('.edit-batch').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = parseInt(this.getAttribute('data-id'));
                        editBatch(id);
                    });
                });
                
                productElement.querySelectorAll('.delete-batch').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = parseInt(this.getAttribute('data-id'));
                        deleteBatch(id);
                    });
                });
            });
        }

        // NOVA FUNÇÃO: Determinar status do produto com base na data de fabricação
        function getProductStatus(manufacturingDate) {
            const today = new Date();
            const manufacturing = new Date(manufacturingDate);
            const expiryDate = new Date(manufacturing);
            expiryDate.setFullYear(expiryDate.getFullYear() + 4); // Validade de 4 anos
            
            const warningDate = new Date(expiryDate);
            warningDate.setFullYear(warningDate.getFullYear() - 1); // Aviso 1 ano antes
            
            if (today > expiryDate) {
                return 'Vencido';
            } else if (today > warningDate) {
                return 'Vencimento Próximo';
            } else {
                return 'Dentro do Prazo';
            }
        }

        // NOVA FUNÇÃO: Calcular data de vencimento
        function getExpiryDate(manufacturingDate) {
            const manufacturing = new Date(manufacturingDate);
            const expiryDate = new Date(manufacturing);
            expiryDate.setFullYear(expiryDate.getFullYear() + 4);
            return expiryDate.toISOString().split('T')[0];
        }

        function showAddProductModal() {
            document.getElementById('productModalTitle').textContent = 'Adicionar Produto ao Estoque';
            document.getElementById('product-form').reset();
            document.getElementById('edit-product-id').value = '';
            document.getElementById('product-manufacturing-date').value = new Date().toISOString().split('T')[0];
            new bootstrap.Modal(document.getElementById('productModal')).show();
        }

        function editProduct(sku) {
            const productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
            const product = productsData.find(p => p.SKU === sku);
            
            if (product) {
                document.getElementById('productModalTitle').textContent = 'Editar Produto';
                document.getElementById('edit-product-id').value = product.id;
                document.getElementById('product-sku').value = product.SKU;
                document.getElementById('product-name').value = product.Produto;
                document.getElementById('product-type').value = product.Tipo;
                document.getElementById('product-quantity').value = product.Quantidade;
                document.getElementById('product-batch').value = product.Lote;
                document.getElementById('product-manufacturing-date').value = product['Data Fabricação'];
                
                new bootstrap.Modal(document.getElementById('productModal')).show();
            }
        }

        function saveProduct() {
            const id = document.getElementById('edit-product-id').value;
            const sku = document.getElementById('product-sku').value;
            const name = document.getElementById('product-name').value;
            const type = document.getElementById('product-type').value;
            const quantity = document.getElementById('product-quantity').value;
            const batch = document.getElementById('product-batch').value;
            const manufacturingDate = document.getElementById('product-manufacturing-date').value;
            
            if (!sku || !name || !type || !quantity || !manufacturingDate) {
                alert('Preencha todos os campos obrigatórios!');
                return;
            }
            
            // Salvar produto
            const productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
            
            if (id) {
                // Editar produto existente
                const productIndex = productsData.findIndex(p => p.id == id);
                if (productIndex !== -1) {
                    productsData[productIndex].SKU = sku;
                    productsData[productIndex].Produto = name;
                    productsData[productIndex].Tipo = type;
                    productsData[productIndex].Quantidade = parseInt(quantity);
                    productsData[productIndex].Lote = batch || `LOTE-${Date.now()}`;
                    productsData[productIndex]['Data Fabricação'] = manufacturingDate;
                }
            } else {
                // Adicionar novo produto
                const newId = productsData.length > 0 ? Math.max(...productsData.map(p => p.id)) + 1 : 1;
                
                const newProduct = {
                    SKU: sku,
                    Produto: name,
                    Tipo: type,
                    Quantidade: parseInt(quantity),
                    Lote: batch || `LOTE-${Date.now()}`,
                    'Data Fabricação': manufacturingDate,
                    Entradas: parseInt(quantity),
                    Saídas: 0,
                    id: newId
                };
                
                productsData.push(newProduct);
            }
            
            localStorage.setItem('productsData', JSON.stringify(productsData));
            
            alert(id ? 'Produto atualizado com sucesso!' : 'Produto adicionado com sucesso!');
            bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
            loadProductsData();
            updateDashboard();
        }

        function showAddBatchModal(sku) {
            document.getElementById('batch-product-sku').value = sku;
            document.getElementById('new-batch-number').value = '';
            document.getElementById('new-batch-quantity').value = '';
            document.getElementById('new-batch-manufacturing-date').value = new Date().toISOString().split('T')[0];
            new bootstrap.Modal(document.getElementById('addBatchModal')).show();
        }

        function addNewBatch() {
            const sku = document.getElementById('batch-product-sku').value;
            const batchNumber = document.getElementById('new-batch-number').value;
            const quantity = document.getElementById('new-batch-quantity').value;
            const manufacturingDate = document.getElementById('new-batch-manufacturing-date').value;
            
            if (!batchNumber || !quantity || !manufacturingDate) {
                alert('Preencha todos os campos obrigatórios!');
                return;
            }
            
            const productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
            const product = productsData.find(p => p.SKU === sku);
            
            if (!product) {
                alert('Produto não encontrado!');
                return;
            }
            
            const newBatch = {
                SKU: sku,
                Produto: product.Produto,
                Tipo: product.Tipo,
                Quantidade: parseInt(quantity),
                Lote: batchNumber,
                'Data Fabricação': manufacturingDate,
                Entradas: parseInt(quantity),
                Saídas: 0,
                id: productsData.length > 0 ? Math.max(...productsData.map(p => p.id)) + 1 : 1
            };
            
            productsData.push(newBatch);
            localStorage.setItem('productsData', JSON.stringify(productsData));
            
            alert('Lote adicionado com sucesso!');
            bootstrap.Modal.getInstance(document.getElementById('addBatchModal')).hide();
            loadProductsData();
            updateDashboard();
        }

        // NOVA FUNÇÃO: Editar lote
        function editBatch(id) {
            const productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
            const product = productsData.find(p => p.id === id);
            
            if (product) {
                document.getElementById('edit-batch-id').value = product.id;
                document.getElementById('edit-batch-number').value = product.Lote;
                document.getElementById('edit-batch-quantity').value = product.Quantidade;
                document.getElementById('edit-batch-manufacturing-date').value = product['Data Fabricação'];
                
                new bootstrap.Modal(document.getElementById('editBatchModal')).show();
            }
        }

        // NOVA FUNÇÃO: Salvar edição do lote
        function saveEditBatch() {
            const id = document.getElementById('edit-batch-id').value;
            const batchNumber = document.getElementById('edit-batch-number').value;
            const quantity = document.getElementById('edit-batch-quantity').value;
            const manufacturingDate = document.getElementById('edit-batch-manufacturing-date').value;
            
            if (!batchNumber || !quantity || !manufacturingDate) {
                alert('Preencha todos os campos obrigatórios!');
                return;
            }
            
            const productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
            const productIndex = productsData.findIndex(p => p.id == id);
            
            if (productIndex !== -1) {
                productsData[productIndex].Lote = batchNumber;
                productsData[productIndex].Quantidade = parseInt(quantity);
                productsData[productIndex]['Data Fabricação'] = manufacturingDate;
                
                localStorage.setItem('productsData', JSON.stringify(productsData));
                
                alert('Lote atualizado com sucesso!');
                bootstrap.Modal.getInstance(document.getElementById('editBatchModal')).hide();
                loadProductsData();
                updateDashboard();
            }
        }

        function deleteBatch(id) {
            if (confirm('Tem certeza que deseja excluir este lote?')) {
                let productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
                productsData = productsData.filter(p => p.id !== id);
                localStorage.setItem('productsData', JSON.stringify(productsData));
                loadProductsData();
                updateDashboard();
                alert('Lote excluído com sucesso!');
            }
        }

        function resetProductsFilters() {
            document.getElementById('products-filter-sku').value = '';
            document.getElementById('products-filter-name').value = '';
            document.getElementById('products-filter-type').value = '';
            loadProductsData();
        }

        function exportProductsExcel() {
            // Criar workbook
            const wb = XLSX.utils.book_new();
            
            // Obter dados
            const productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
            const data = [['SKU', 'Produto', 'Tipo', 'Quantidade', 'Lote', 'Data Fabricação', 'Data Vencimento', 'Status']];
            
            productsData.forEach(product => {
                const status = getProductStatus(product['Data Fabricação']);
                const expiryDate = getExpiryDate(product['Data Fabricação']);
                data.push([
                    product.SKU,
                    product.Produto,
                    product.Tipo,
                    product.Quantidade,
                    product.Lote,
                    formatDate(product['Data Fabricação']),
                    formatDate(expiryDate),
                    status
                ]);
            });
            
            // Criar worksheet
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // Adicionar worksheet ao workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Estoque de Produtos');
            
            // Gerar e salvar arquivo
            XLSX.writeFile(wb, 'estoque_produtos.xlsx');
        }

        // Movimentação de Paletes - MODIFICADA PARA REMOVER EXCLUIR E MANTER APENAS EDITAR
        function loadPaletesData() {
            const filterDate = document.getElementById('paletes-filter-date').value;
            const paletesData = JSON.parse(localStorage.getItem('paletesData') || '[]');
            const container = document.getElementById('paletes-report-container');
            
            container.innerHTML = '';
            
            let filteredData = paletesData;
            
            if (filterDate) {
                filteredData = filteredData.filter(p => p.date === filterDate);
            }
            
            if (filteredData.length === 0) {
                container.innerHTML = '<div class="text-center p-3 text-muted">Nenhum relatório encontrado</div>';
                return;
            }
            
            filteredData.forEach(report => {
                // Calcular totais de entradas e saídas
                let totalEntradas = 0;
                let totalSaidas = 0;
                
                report.items.forEach(item => {
                    if (item.movement === 'Entrada') {
                        totalEntradas += item.quantity;
                    } else if (item.movement === 'Saída') {
                        totalSaidas += item.quantity;
                    }
                });
                
                const reportElement = document.createElement('div');
                reportElement.className = 'report-line';
                reportElement.innerHTML = `
                    <div class="report-header">
                        <span>Relatório Diário - ${formatDate(report.date)} - Nº ${String(report.reportNumber).padStart(6, '0')}</span>
                        <div>
                            <button class="btn btn-sm btn-warning edit-report btn-edit-black" data-id="${report.id}">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <i class="bi bi-chevron-down"></i>
                        </div>
                    </div>
                    <div class="report-details" style="display: none;">
                        <h6 class="mb-3">MOVIMENTAÇÃO DE PALETES</h6>
                        <div class="paletes-movement-table">
                            ${report.items.map(item => `
                                <div class="paletes-item d-flex justify-content-between border-bottom pb-2 mb-2">
                                    <span class="fw-bold">${item.type}</span>
                                    <span>${item.movement === 'Entrada' ? 'Entrada' : 'Saídas'} ${item.quantity} paletes</span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="paletes-totals mt-3 pt-3 border-top">
                            <div class="d-flex justify-content-between fw-bold">
                                <span>TOTAIS</span>
                                <span>Entradas: ${totalEntradas} | Saídas: ${totalSaidas}</span>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(reportElement);
                
                // Adicionar evento de clique para expandir/recolher
                const header = reportElement.querySelector('.report-header');
                const details = reportElement.querySelector('.report-details');
                const icon = reportElement.querySelector('.bi-chevron-down');
                
                header.addEventListener('click', (e) => {
                    // Não expandir/recolher se clicar no botão de editar
                    if (!e.target.closest('.edit-report')) {
                        const isVisible = details.style.display !== 'none';
                        details.style.display = isVisible ? 'none' : 'block';
                        icon.className = isVisible ? 'bi bi-chevron-down' : 'bi bi-chevron-up';
                    }
                });
                
                // Adicionar evento para o botão de editar
                const editBtn = reportElement.querySelector('.edit-report');
                editBtn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    editPaletesReport(id);
                });
            });
        }

        function editPaletesReport(id) {
            const paletesData = JSON.parse(localStorage.getItem('paletesData') || '[]');
            const report = paletesData.find(r => r.id === id);
            
            if (report) {
                currentEditPaletesId = id;
                document.getElementById('edit-paletes-id').value = id;
                document.getElementById('edit-paletes-date').value = report.date;
                
                // Preencher com o primeiro item (simplificação)
                if (report.items.length > 0) {
                    const item = report.items[0];
                    document.getElementById('edit-paletes-type').value = item.type;
                    document.getElementById('edit-paletes-movement').value = item.movement;
                    document.getElementById('edit-paletes-quantity').value = item.quantity;
                }
                
                new bootstrap.Modal(document.getElementById('editPaletesModal')).show();
            }
        }

        function saveEditPaletes() {
            const id = document.getElementById('edit-paletes-id').value;
            const date = document.getElementById('edit-paletes-date').value;
            const type = document.getElementById('edit-paletes-type').value;
            const movement = document.getElementById('edit-paletes-movement').value;
            const quantity = document.getElementById('edit-paletes-quantity').value;
            
            if (!date || !type || !movement || !quantity) {
                alert('Preencha todos os campos!');
                return;
            }
            
            const paletesData = JSON.parse(localStorage.getItem('paletesData') || '[]');
            const reportIndex = paletesData.findIndex(r => r.id == id);
            
            if (reportIndex !== -1) {
                // Atualizar relatório (simplificação - atualiza apenas o primeiro item)
                paletesData[reportIndex].date = date;
                if (paletesData[reportIndex].items.length > 0) {
                    paletesData[reportIndex].items[0].type = type;
                    paletesData[reportIndex].items[0].movement = movement;
                    paletesData[reportIndex].items[0].quantity = parseInt(quantity);
                }
                
                localStorage.setItem('paletesData', JSON.stringify(paletesData));
                alert('Movimentação de paletes atualizada com sucesso!');
                bootstrap.Modal.getInstance(document.getElementById('editPaletesModal')).hide();
                loadPaletesData();
                updateDashboard();
            }
        }

        function resetPaletesFilters() {
            document.getElementById('paletes-filter-date').value = '';
            loadPaletesData();
        }

        function addPaletesItem() {
            const date = document.getElementById('paletes-date').value;
            const type = document.getElementById('paletes-type').value;
            const movement = document.getElementById('paletes-movement').value;
            const quantity = document.getElementById('paletes-quantity').value;
            
            if (!date || !type || !movement || !quantity) {
                alert('Preencha todos os campos!');
                return;
            }
            
            // Adicionar movimentação de paletes
            const paletesData = JSON.parse(localStorage.getItem('paletesData') || '[]');
            
            // Verificar se já existe relatório para esta data
            let existingReport = paletesData.find(report => report.date === date);
            
            if (!existingReport) {
                const newReportNumber = paletesData.length > 0 ? Math.max(...paletesData.map(p => p.reportNumber)) + 1 : 1;
                existingReport = {
                    id: paletesData.length > 0 ? Math.max(...paletesData.map(p => p.id)) + 1 : 1,
                    date: date,
                    reportNumber: newReportNumber,
                    items: []
                };
                paletesData.push(existingReport);
            }
            
            // Adicionar item ao relatório
            existingReport.items.push({
                type: type,
                movement: movement,
                quantity: parseInt(quantity)
            });
            
            localStorage.setItem('paletesData', JSON.stringify(paletesData));
            
            alert('Movimentação de paletes adicionada com sucesso!');
            document.getElementById('paletes-form').reset();
            document.getElementById('paletes-date').value = new Date().toISOString().split('T')[0];
            loadPaletesData();
            updateDashboard();
        }

        function generatePaletesPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Título
            doc.setFontSize(20);
            doc.text('Relatório de Movimentação de Paletes', 105, 15, { align: 'center' });
            
            // Data do relatório
            const reportDate = document.getElementById('paletes-filter-date').value || new Date().toISOString().split('T')[0];
            doc.setFontSize(12);
            doc.text(`Data: ${formatDate(reportDate)}`, 14, 25);
            
            // Cabeçalho da tabela
            const headers = [['Tipo', 'Movimento', 'Quantidade']];
            
            // Dados da tabela
            const paletesData = JSON.parse(localStorage.getItem('paletesData') || '[]');
            const report = paletesData.find(r => r.date === reportDate);
            const rows = [];
            
            if (report) {
                report.items.forEach(item => {
                    rows.push([item.type, item.movement, item.quantity.toString()]);
                });
            }
            
            if (rows.length === 0) {
                doc.text('Nenhuma movimentação encontrada', 14, 35);
            } else {
                // Gerar tabela
                doc.autoTable({
                    head: headers,
                    body: rows,
                    startY: 35,
                    styles: { fontSize: 10 },
                    headStyles: { fillColor: [52, 58, 64] }
                });
            }
            
            // Salvar PDF
            doc.save(`relatorio_paletes_${reportDate}.pdf`);
        }

        function generatePaletesExcel() {
            // Criar workbook
            const wb = XLSX.utils.book_new();
            
            // Obter dados
            const reportDate = document.getElementById('paletes-filter-date').value || new Date().toISOString().split('T')[0];
            const paletesData = JSON.parse(localStorage.getItem('paletesData') || '[]');
            const report = paletesData.find(r => r.date === reportDate);
            
            const data = [['Tipo', 'Movimento', 'Quantidade']];
            
            if (report) {
                report.items.forEach(item => {
                    data.push([item.type, item.movement, item.quantity]);
                });
            } else {
                data.push(['Nenhuma movimentação encontrada']);
            }
            
            // Criar worksheet
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // Adicionar worksheet ao workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Movimentação de Paletes');
            
            // Gerar e salvar arquivo
            XLSX.writeFile(wb, `relatorio_paletes_${reportDate}.xlsx`);
        }

        // Produtos Segregados - COM BOTÃO VISUALIZAR
        function loadSegregatedProducts() {
            const filterProduct = document.getElementById('segregation-filter-product').value.toLowerCase();
            const filterStatus = document.getElementById('segregation-filter-status').value;
            const filterDate = document.getElementById('segregation-filter-date').value;
            
            const segregatedProducts = JSON.parse(localStorage.getItem('segregatedProducts') || '[]');
            const tbody = document.getElementById('segregated-products-table');
            
            tbody.innerHTML = '';
            
            let filteredData = segregatedProducts;
            
            if (filterProduct) {
                filteredData = filteredData.filter(s => 
                    s.productName.toLowerCase().includes(filterProduct) || 
                    s.productSKU.toLowerCase().includes(filterProduct)
                );
            }
            
            if (filterStatus) {
                filteredData = filteredData.filter(s => s.status === filterStatus);
            }
            
            if (filterDate) {
                filteredData = filteredData.filter(s => s.date === filterDate);
            }
            
            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">Nenhum produto segregado</td></tr>';
                return;
            }
            
            filteredData.forEach(segregation => {
                const statusClass = segregation.status === 'Ativo' ? 'status-ativo' : 
                                  segregation.status === 'Liberado' ? 'status-liberado' : 'status-descartado';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${segregation.productName}</td>
                    <td>${segregation.batch}</td>
                    <td>${segregation.reason}</td>
                    <td>${formatDate(segregation.date)}</td>
                    <td><span class="${statusClass}">${segregation.status}</span></td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-info me-1 view-segregation" data-id="${segregation.id}">
                            <i class="bi bi-eye"></i> Visualizar
                        </button>
                        <button class="btn btn-sm btn-danger delete-segregation" data-id="${segregation.id}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Adicionar eventos para visualizar e excluir
            document.querySelectorAll('.view-segregation').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    viewSegregation(id);
                });
            });
            
            document.querySelectorAll('.delete-segregation').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    deleteSegregation(id);
                });
            });
        }

        function viewSegregation(id) {
            const segregatedProducts = JSON.parse(localStorage.getItem('segregatedProducts') || '[]');
            const segregation = segregatedProducts.find(s => s.id === id);
            
            if (segregation) {
                document.getElementById('view-product-name').textContent = segregation.productName;
                document.getElementById('view-batch').textContent = segregation.batch;
                document.getElementById('view-reason').textContent = segregation.reason;
                document.getElementById('view-date').textContent = formatDate(segregation.date);
                document.getElementById('view-quantity').textContent = segregation.quantity || 'N/A';
                document.getElementById('view-status').textContent = segregation.status;
                document.getElementById('view-notes').textContent = segregation.notes || 'Nenhuma observação';
                
                currentSegregationId = id;
                
                // Configurar eventos para os botões de alterar status
                document.querySelectorAll('.change-status').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const newStatus = this.getAttribute('data-status');
                        updateSegregationStatus(currentSegregationId, newStatus);
                    });
                });
                
                new bootstrap.Modal(document.getElementById('viewSegregationModal')).show();
            }
        }

        function updateSegregationStatus(id, newStatus) {
            const segregatedProducts = JSON.parse(localStorage.getItem('segregatedProducts') || '[]');
            const segregation = segregatedProducts.find(s => s.id === id);
            
            if (segregation) {
                segregation.status = newStatus;
                localStorage.setItem('segregatedProducts', JSON.stringify(segregatedProducts));
                loadSegregatedProducts();
                bootstrap.Modal.getInstance(document.getElementById('viewSegregationModal')).hide();
                alert(`Status alterado para: ${newStatus}`);
            }
        }

        function resetSegregationFilters() {
            document.getElementById('segregation-filter-product').value = '';
            document.getElementById('segregation-filter-status').value = '';
            document.getElementById('segregation-filter-date').value = '';
            loadSegregatedProducts();
        }

        function showAddSegregationModal() {
            // Limpar formulário
            document.getElementById('add-segregation-form').reset();
            // Definir data atual
            document.getElementById('segregation-date').value = new Date().toISOString().split('T')[0];
            // Definir quantidade padrão
            document.getElementById('segregation-quantity').value = '1';
            // Carregar produtos
            loadProductsForSegregation();
            // Mostrar modal
            new bootstrap.Modal(document.getElementById('addSegregationModal')).show();
        }

        function loadProductsForSegregation() {
            const productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
            const productSelect = document.getElementById('segregation-product');
            
            productSelect.innerHTML = '<option value="">Selecione um produto</option>';
            
            const uniqueProducts = [...new Set(productsData.map(p => p.SKU))];
            uniqueProducts.forEach(sku => {
                const product = productsData.find(p => p.SKU === sku);
                if (product) {
                    const option = document.createElement('option');
                    option.value = sku;
                    option.textContent = `${product.Produto} (${sku})`;
                    option.setAttribute('data-type', product.Tipo);
                    productSelect.appendChild(option);
                }
            });
            
            // Atualizar lotes quando produto mudar
            productSelect.addEventListener('change', function() {
                updateLotesForSegregation(this.value);
            });
        }

        function updateLotesForSegregation(sku) {
            const productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
            const loteSelect = document.getElementById('segregation-lote');
            
            loteSelect.innerHTML = '<option value="">Selecione um lote</option>';
            
            const productLotes = productsData.filter(p => p.SKU === sku && p.Quantidade > 0);
            productLotes.forEach(product => {
                const option = document.createElement('option');
                option.value = product.Lote;
                option.textContent = product.Lote;
                loteSelect.appendChild(option);
            });
        }

        function addSegregation() {
            const product = document.getElementById('segregation-product').value;
            const lote = document.getElementById('segregation-lote').value;
            const reason = document.getElementById('segregation-reason').value;
            const date = document.getElementById('segregation-date').value;
            const quantity = document.getElementById('segregation-quantity').value;
            const notes = document.getElementById('segregation-notes').value;
            
            if (!product || !lote || !reason || !date || !quantity) {
                alert('Preencha todos os campos obrigatórios!');
                return;
            }
            
            // Salvar segregação
            const segregatedProducts = JSON.parse(localStorage.getItem('segregatedProducts') || '[]');
            const productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
            
            const productInfo = productsData.find(p => p.SKU === product && p.Lote === lote);
            if (!productInfo) {
                alert('Produto ou lote não encontrado!');
                return;
            }
            
            const newSegregation = {
                id: segregatedProducts.length > 0 ? Math.max(...segregatedProducts.map(s => s.id)) + 1 : 1,
                productSKU: product,
                productName: productInfo.Produto,
                batch: lote,
                reason: reason,
                date: date,
                quantity: parseInt(quantity),
                status: 'Ativo',
                notes: notes,
                timestamp: new Date().toISOString()
            };
            
            segregatedProducts.push(newSegregation);
            localStorage.setItem('segregatedProducts', JSON.stringify(segregatedProducts));
            
            alert('Segregação adicionada com sucesso!');
            bootstrap.Modal.getInstance(document.getElementById('addSegregationModal')).hide();
            loadSegregatedProducts();
        }

        function deleteSegregation(id) {
            if (confirm('Tem certeza que deseja excluir esta segregação?')) {
                let segregatedProducts = JSON.parse(localStorage.getItem('segregatedProducts') || '[]');
                segregatedProducts = segregatedProducts.filter(s => s.id !== id);
                localStorage.setItem('segregatedProducts', JSON.stringify(segregatedProducts));
                loadSegregatedProducts();
                alert('Segregação excluída com sucesso!');
            }
        }

        // Configurações
        function loadConfigSettings() {
            // Carregar configurações salvas
            const darkMode = localStorage.getItem('darkMode') !== 'false';
            const notifyExpiry = localStorage.getItem('notifyExpiry') !== 'false';
            const notifyLowStock = localStorage.getItem('notifyLowStock') !== 'false';
            const reportFormat = localStorage.getItem('reportFormat') || 'pdf';
            
            document.getElementById('dark-mode-toggle').checked = darkMode;
            document.getElementById('notify-expiry').checked = notifyExpiry;
            document.getElementById('notify-low-stock').checked = notifyLowStock;
            document.getElementById('report-format').value = reportFormat;
        }

        function saveConfigSettings() {
            const darkMode = document.getElementById('dark-mode-toggle').checked;
            const notifyExpiry = document.getElementById('notify-expiry').checked;
            const notifyLowStock = document.getElementById('notify-low-stock').checked;
            const reportFormat = document.getElementById('report-format').value;
            
            // Salvar configurações
            localStorage.setItem('darkMode', darkMode);
            localStorage.setItem('notifyExpiry', notifyExpiry);
            localStorage.setItem('notifyLowStock', notifyLowStock);
            localStorage.setItem('reportFormat', reportFormat);
            
            alert('Configurações salvas com sucesso!');
        }

        // Firebase
        async function syncToFirebase() {
            if (!isFirebaseInitialized) {
                alert("Firebase não está inicializado. Verifique a conexão.");
                return;
            }

            updateSyncStatus(true, "Sincronizando...");
            
            try {
                // Preparar dados para sincronização
                const dataToSync = {
                    productsData: JSON.parse(localStorage.getItem('productsData') || '[]'),
                    movementHistory: JSON.parse(localStorage.getItem('movementHistory') || '[]'),
                    reportsHistory: JSON.parse(localStorage.getItem('reportsHistory') || '[]'),
                    paletesData: JSON.parse(localStorage.getItem('paletesData') || '[]'),
                    segregatedProducts: JSON.parse(localStorage.getItem('segregatedProducts') || '[]'),
                    lastReportNumber: localStorage.getItem('lastReportNumber') || '0',
                    lastPaletesReportNumber: localStorage.getItem('lastPaletesReportNumber') || '0',
                    syncTimestamp: new Date().toISOString()
                };

                // Salvar no Firestore
                await db.collection('systemData').doc('mainData').set(dataToSync);
                
                updateSyncStatus(true, "Sincronizado");
                alert("Dados sincronizados com sucesso!");
            } catch (error) {
                console.error("Erro ao sincronizar com Firebase:", error);
                updateSyncStatus(false, "Erro na sincronização");
                alert("Erro ao sincronizar dados: " + error.message);
            }
        }

        async function syncFromFirebase() {
            if (!isFirebaseInitialized) {
                alert("Firebase não está inicializado. Verifique a conexão.");
                return;
            }

            updateSyncStatus(true, "Carregando...");
            
            try {
                const doc = await db.collection('systemData').doc('mainData').get();
                
                if (doc.exists) {
                    const data = doc.data();
                    
                    // Restaurar dados do localStorage
                    localStorage.setItem('productsData', JSON.stringify(data.productsData || []));
                    localStorage.setItem('movementHistory', JSON.stringify(data.movementHistory || []));
                    localStorage.setItem('reportsHistory', JSON.stringify(data.reportsHistory || []));
                    localStorage.setItem('paletesData', JSON.stringify(data.paletesData || []));
                    localStorage.setItem('segregatedProducts', JSON.stringify(data.segregatedProducts || []));
                    localStorage.setItem('lastReportNumber', data.lastReportNumber || '0');
                    localStorage.setItem('lastPaletesReportNumber', data.lastPaletesReportNumber || '0');
                    
                    // Recarregar as visualizações
                    loadProductsData();
                    loadStockReport();
                    loadPaletesData();
                    loadSegregatedProducts();
                    updateDashboard();
                    
                    updateSyncStatus(true, "Dados carregados");
                    alert("Dados carregados do Firebase com sucesso!");
                } else {
                    alert("Nenhum dado encontrado no Firebase.");
                    updateSyncStatus(true, "Sem dados no Firebase");
                }
            } catch (error) {
                console.error("Erro ao carregar do Firebase:", error);
                updateSyncStatus(false, "Erro ao carregar");
                alert("Erro ao carregar dados: " + error.message);
            }
        }

        // ========== FUNÇÕES UTILITÁRIAS ==========
        function getProductType(sku) {
            const productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
            const product = productsData.find(p => p.SKU === sku);
            return product ? product.Tipo : 'N/A';
        }

        function updateSyncStatus(isOnline, message) {
            const indicator = document.getElementById('sync-status-indicator');
            const text = document.getElementById('sync-status-text');
            const configIndicator = document.getElementById('config-sync-status-indicator');
            const configText = document.getElementById('config-sync-status-text');
            
            if (isOnline) {
                indicator.className = 'sync-indicator sync-online';
                text.textContent = message;
                if (configIndicator) {
                    configIndicator.className = 'sync-indicator sync-online';
                    configText.textContent = `Status: ${message}`;
                }
            } else {
                indicator.className = 'sync-indicator sync-offline';
                text.textContent = message;
                if (configIndicator) {
                    configIndicator.className = 'sync-indicator sync-offline';
                    configText.textContent = `Status: ${message}`;
                }
            }
        }

       function formatDate(dateString) {
    // Verifica se a string de data existe e está no formato esperado (YYYY-MM-DD)
    if (!dateString || !dateString.includes('-')) {
        return 'Data inválida';
    }

    // 1. Divide a string "YYYY-MM-DD" em um array ["YYYY", "MM", "DD"]
    const parts = dateString.split('-');
    
    // 2. Pega as partes da data
    const year = parts[0];
    const month = parts[1];
    const day = parts[2];

    // 3. Retorna a data formatada como "DD/MM/YYYY"
    return `${day}/${month}/${year}`;
}

        // ========== INICIALIZAÇÃO ==========
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar data atual
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('current-date').textContent = new Date().toLocaleDateString('pt-BR');
            
            // Configurar datas padrão
            document.getElementById('input-date').value = today;
            document.getElementById('paletes-date').value = today;
            document.getElementById('stock-filter-date').value = today;
            document.getElementById('paletes-filter-date').value = today;
            
            // Configurar navegação
            setupNavigation();
            
            // Inicializar dados
            initializeData();
            
            // Configurar eventos dos botões
            setupEventListeners();
            
            // Carregar dados iniciais
            loadProductsForMovement();
            loadProductsData();
            loadStockReport();
            loadPaletesData();
            loadSegregatedProducts();
            updateDashboard();
            
            console.log("Sistema inicializado com sucesso!");
        });
    </script>
</body>
</html>
