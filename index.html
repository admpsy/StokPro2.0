<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Movimentação de Produtos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- Firebase Storage -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <style>
        :root {
            --primary-color: #4b6cb7;
            --secondary-color: #182848;
            --accent-color: #6a11cb;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --light-bg: #121212;
            --dark-bg: #1e1e1e;
            --card-bg: #2d2d2d;
            --text-color: #f8f9fa;
            --text-muted: #b0b0b0;
            --text-light: #ffffff;
            --border-color: #444;
            --sidebar-width: 280px;
            --table-header-bg: #343a40;
            --table-row-hover: rgba(255, 255, 255, 0.08);
            --table-striped: rgba(255, 255, 255, 0.05);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: var(--light-bg);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: all 0.3s ease;
            overflow-x: hidden;
            line-height: 1.6;
        }
        
        /* Layout com sidebar */
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--secondary-color) 0%, var(--dark-bg) 100%);
            color: white;
            padding: 0;
            box-shadow: 3px 0 10px rgba(0,0,0,0.2);
            z-index: 1000;
            transition: all 0.3s ease;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }
        
        .sidebar-header {
            padding: 25px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            text-align: center;
            background: rgba(0,0,0,0.2);
        }
        
        .sidebar-nav {
            padding: 20px 0;
        }
        
        .nav-item {
            margin-bottom: 5px;
        }
        
        .nav-link {
            color: rgba(255,255,255,0.9);
            padding: 15px 25px;
            border-radius: 0;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            border-left: 4px solid transparent;
            text-decoration: none;
            font-weight: 500;
        }
        
        .nav-link:hover, .nav-link.active {
            background: rgba(255,255,255,0.1);
            color: white;
            border-left-color: var(--primary-color);
        }
        
        .nav-link i {
            margin-right: 12px;
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }
        
        .main-content {
            flex: 1;
            padding: 20px;
            margin-left: var(--sidebar-width);
            background-color: var(--light-bg);
            min-height: 100vh;
        }
        
        .page {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .active {
            display: block;
        }
        
        /* Melhorias de legibilidade - textos */
        h1, h2, h3, h4, h5, h6 {
            color: var(--text-light);
            font-weight: 600;
            margin-bottom: 1rem;
        }
        
        h2 {
            font-size: 1.8rem;
        }
        
        p, span, div {
            color: var(--text-color);
        }
        
        .text-muted {
            color: var(--text-muted) !important;
        }
        
        .form-text {
            color: var(--text-muted) !important;
        }
        
        /* Cards e containers */
        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            margin-bottom: 24px;
            transition: transform 0.3s, box-shadow 0.3s;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        
        .card-header {
            background: linear-gradient(135deg, rgba(75, 108, 183, 0.1) 0%, rgba(106, 17, 203, 0.1) 100%);
            border-bottom: 1px solid var(--border-color);
            padding: 18px 24px;
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text-light);
        }
        
        .card-body {
            padding: 24px;
        }
        
        /* Formulários */
        .form-control, .form-select {
            background-color: #3a3a3a;
            border: 1px solid #555;
            color: var(--text-color);
            border-radius: 8px;
            padding: 10px 15px;
            transition: all 0.3s;
        }
        
        .form-control:focus, .form-select:focus {
            background-color: #424242;
            border-color: var(--primary-color);
            color: var(--text-color);
            box-shadow: 0 0 0 0.25rem rgba(75, 108, 183, 0.25);
        }
        
        .form-label {
            color: var(--text-light);
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        /* Tabelas - MELHORIAS APLICADAS */
        .table {
            color: var(--text-color);
            border-color: var(--border-color);
            margin-bottom: 0;
            width: 100%;
            /* Removendo transparência e ajustando espaçamento */
            background-color: var(--card-bg);
        }
        
        .table th {
            background-color: var(--table-header-bg);
            color: var(--text-light);
            font-weight: 600;
            padding: 10px 12px; /* Diminuído o padding */
            border-bottom: 2px solid var(--border-color);
            vertical-align: middle;
        }
        
        .table td {
            padding: 10px 12px; /* Diminuído o padding */
            vertical-align: middle;
            color: var(--text-color);
            border-top: 1px solid var(--border-color);
            /* Removendo transparência */
            background-color: transparent;
        }
        
        .table-striped>tbody>tr:nth-of-type(odd) {
            background-color: var(--table-striped);
        }
        
        .table-hover tbody tr:hover {
            background-color: var(--table-row-hover);
        }
        
        .table-bordered {
            border: 1px solid var(--border-color);
        }
        
        .table-bordered th,
        .table-bordered td {
            border: 1px solid var(--border-color);
        }
        
        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
        }
        
        /* Botões */
        .btn {
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s;
            padding: 10px 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: none;
        }
        
        .btn i {
            margin-right: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--primary-color) 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(75, 108, 183, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #1e7e34 100%);
            color: white;
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #1e7e34 0%, var(--success-color) 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }
        
        .btn-outline-primary {
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            background: transparent;
        }
        
        .btn-outline-primary:hover {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            color: white;
            transform: translateY(-2px);
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.875rem;
        }
        
        .btn-lg {
            padding: 12px 24px;
            font-size: 1.1rem;
        }
        
        /* Badges e status */
        .status-valid {
            background-color: #155724;
            color: #d4edda;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
            display: inline-block;
        }
        
        .status-warning {
            background-color: #856404;
            color: #fff3cd;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
            display: inline-block;
        }
        
        .status-expired {
            background-color: #721c24;
            color: #f8d7da;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
            display: inline-block;
        }
        
        .movement-badge {
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 12px;
            margin: 2px;
            display: inline-block;
        }
        
        .movement-entrada {
            background-color: #155724;
            color: #d4edda;
        }
        
        .movement-saida {
            background-color: #721c24;
            color: #f8d7da;
        }
        
        .movement-devolucao {
            background-color: #856404;
            color: #fff3cd;
        }
        
        /* Foto preview */
        .photo-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }
        
        .photo-preview {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 10px;
            border: 2px solid var(--border-color);
            transition: transform 0.3s;
        }
        
        .photo-preview:hover {
            transform: scale(1.05);
        }
        
        /* Estrutura expansível para relatórios */
        .report-line {
            padding: 15px 20px;
            border-left: 4px solid var(--primary-color);
            background: linear-gradient(135deg, rgba(75, 108, 183, 0.1) 0%, rgba(106, 17, 203, 0.05) 100%);
            margin-bottom: 15px;
            border-radius: 0 10px 10px 0;
            transition: all 0.3s;
        }
        
        .report-line:hover {
            background: linear-gradient(135deg, rgba(75, 108, 183, 0.15) 0%, rgba(106, 17, 203, 0.1) 100%);
        }
        
        .report-header {
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-size: 1.1rem;
            color: var(--text-light);
        }
        
        .report-details {
            margin-top: 15px;
            padding-left: 20px;
            border-left: 2px dashed var(--border-color);
        }
        
        .report-item {
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .report-item:last-child {
            border-bottom: none;
        }
        
        /* Dashboard cards */
        .stat-card {
            background: linear-gradient(135deg, rgba(75, 108, 183, 0.1) 0%, rgba(106, 17, 203, 0.1) 100%);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            transition: transform 0.3s;
            border: 1px solid rgba(255,255,255,0.1);
            height: 100%;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 5px;
            font-weight: 700;
            color: var(--text-light);
        }
        
        .stat-card p {
            color: var(--text-muted);
            margin-bottom: 0;
        }
        
        /* Melhorias para elementos específicos */
        .summary-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(147, 51, 234, 0.1) 100%);
            border-left: 4px solid var(--primary-color);
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 10px;
        }
        
        .summary-card h5 {
            color: var(--text-light);
            margin-bottom: 10px;
        }
        
        .batch-indicator {
            display: inline-block;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            text-align: center;
            line-height: 24px;
            font-size: 12px;
            margin-left: 8px;
            font-weight: bold;
        }
        
        .batch-details {
            padding-left: 40px !important;
        }
        
        .table-action-btn {
            padding: 6px 10px;
            margin: 0 3px;
            border-radius: 6px;
            font-size: 0.8rem;
        }
        
        .product-group, .loading-group {
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .product-group:hover, .loading-group:hover {
            background-color: rgba(255,255,255,0.1) !important;
        }
        
        .product-details, .loading-details {
            background-color: rgba(255,255,255,0.03);
        }
        
        /* Modal customizado */
        .modal-content {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-color);
        }
        
        .modal-header {
            border-bottom: 1px solid var(--border-color);
            padding: 20px 24px;
        }
        
        .modal-header .modal-title {
            color: var(--text-light);
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .modal-footer {
            border-top: 1px solid var(--border-color);
            padding: 20px 24px;
        }
        
        /* Responsividade */
        @media (max-width: 992px) {
            .sidebar {
                width: 80px;
            }
            
            .sidebar .nav-link span {
                display: none;
            }
            
            .sidebar .nav-link i {
                margin-right: 0;
            }
            
            .sidebar-header h3, .sidebar-header p {
                display: none;
            }
            
            .sidebar-header {
                padding: 20px 10px;
            }
            
            .main-content {
                margin-left: 80px;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .app-container {
                flex-direction: column;
            }
            
            .sidebar-nav {
                display: flex;
                overflow-x: auto;
                padding: 10px;
            }
            
            .nav-item {
                margin-bottom: 0;
                margin-right: 10px;
                flex-shrink: 0;
            }
            
            .nav-link {
                padding: 10px 15px;
                white-space: nowrap;
                border-left: none;
                border-bottom: 3px solid transparent;
            }
            
            .nav-link:hover, .nav-link.active {
                border-left: none;
                border-bottom-color: var(--primary-color);
            }
            
            .sidebar-header {
                display: none;
            }
        }
        
        /* Utilitários */
        .text-gradient {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .shadow-custom {
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .border-radius-custom {
            border-radius: 12px;
        }
        
        /* Melhorias de legibilidade para elementos específicos */
        small, .small {
            color: var(--text-muted) !important;
        }
        
        .form-check-label {
            color: var(--text-color);
        }
        
        .input-group-text {
            background-color: #3a3a3a;
            border: 1px solid #555;
            color: var(--text-muted);
        }
        
        /* Estilo para o rodapé de créditos */
        .credits-footer {
            background-color: var(--dark-bg);
            color: var(--text-muted);
            padding: 15px 0;
            margin-top: 30px;
            border-top: 1px solid var(--border-color);
            text-align: center;
            font-size: 0.9rem;
        }
        
        .credits-footer a {
            color: var(--primary-color);
            text-decoration: none;
        }
        
        .credits-footer a:hover {
            text-decoration: underline;
        }
        
        /* Estilos para produtos vencidos no dashboard */
        .expiring-products-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .expiring-product-item {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .expiring-product-item:last-child {
            border-bottom: none;
        }
        
        .expiring-product-info {
            flex: 1;
        }
        
        .expiring-product-name {
            font-weight: bold;
            color: var(--text-light);
        }
        
        .expiring-product-details {
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        
        /* Estilos para sincronização Firebase */
        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }
        
        .sync-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .sync-online {
            background-color: var(--success-color);
        }
        
        .sync-offline {
            background-color: var(--danger-color);
        }
        
        .sync-syncing {
            background-color: var(--warning-color);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar de Navegação -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3 class="mb-1">Sistema de Controle</h3>
                <p class="mb-0 small opacity-75">Gestão de Movimentação e Estoque</p>
                <div class="sync-status mt-2">
                    <span class="sync-indicator sync-offline" id="sync-status-indicator"></span>
                    <span id="sync-status-text">Offline</span>
                </div>
            </div>
            <div class="sidebar-nav">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" data-page="dashboard-page">
                            <i class="bi bi-speedometer2"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-page="stock-report-page">
                            <i class="bi bi-clipboard-data"></i>
                            <span>Relatório de Estoque</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-page="report-page">
                            <i class="bi bi-box-arrow-in-down"></i>
                            <span>Cadastro de Movimentação</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-page="products-page">
                            <i class="bi bi-boxes"></i>
                            <span>Estoque de Produtos</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-page="paletes-page">
                            <i class="bi bi-pallet"></i>
                            <span>Movimentação de Paletes</span>
                        </a>
                    </li>
                    <!-- ADICIONAR NO SIDEBAR (após o item de Paletes) -->
<li class="nav-item">
    <a class="nav-link" href="#" data-page="segregated-products-page">
        <i class="bi bi-shield-exclamation"></i>
        <span>Produtos Segregados</span>
    </a>
</li>
                    <li class="nav-item mt-4">
                        <a class="nav-link" href="#" data-page="config-page">
                            <i class="bi bi-gear-fill"></i>
                            <span>Configurações</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-danger" href="#" id="logout-btn">
                            <i class="bi bi-box-arrow-left"></i>
                            <span>Sair do Sistema</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Conteúdo Principal -->
        <div class="main-content">
            <!-- Dashboard -->
            <div id="dashboard-page" class="page active">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="text-gradient">Dashboard</h2>
                    <div class="text-muted">
                        <i class="bi bi-calendar3 me-1"></i>
                        <span id="current-date"></span>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-3 col-sm-6 mb-4">
                        <div class="stat-card">
                            <i class="bi bi-box-seam"></i>
                            <h3 id="total-products">0</h3>
                            <p class="text-muted">Produtos em Estoque</p>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-4">
                        <div class="stat-card">
                            <i class="bi bi-arrow-down-circle"></i>
                            <h3 id="total-entradas">0</h3>
                            <p class="text-muted">Entradas Hoje</p>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-4">
                        <div class="stat-card">
                            <i class="bi bi-arrow-up-circle"></i>
                            <h3 id="total-saidas">0</h3>
                            <p class="text-muted">Saídas Hoje</p>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-4">
                        <div class="stat-card">
                            <i class="bi bi-exclamation-triangle"></i>
                            <h3 id="total-alertas">0</h3>
                            <p class="text-muted">Alertas</p>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-8 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Movimentações Recentes</h5>
                            </div>
                            <div class="card-body">
                                <ul class="nav nav-tabs" id="movementTabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="paletes-tab" data-bs-toggle="tab" data-bs-target="#paletes-tab-pane" type="button" role="tab">Paletes</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="products-tab" data-bs-toggle="tab" data-bs-target="#products-tab-pane" type="button" role="tab">Produtos por Tipo</button>
                                    </li>
                                </ul>
                                <div class="tab-content mt-3" id="movementTabsContent">
                                    <div class="tab-pane fade show active" id="paletes-tab-pane" role="tabpanel">
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>Data</th>
                                                        <th>Tipo</th>
                                                        <th>Movimento</th>
                                                        <th>Quantidade</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="recent-paletes-movements">
                                                    <tr>
                                                        <td colspan="4" class="text-center">Nenhuma movimentação de paletes recente</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="products-tab-pane" role="tabpanel">
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>Data</th>
                                                        <th>Produto</th>
                                                        <th>Tipo</th>
                                                        <th>Movimento</th>
                                                        <th>Quantidade</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="recent-products-movements">
                                                    <tr>
                                                        <td colspan="5" class="text-center">Nenhuma movimentação de produtos recente</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Status de Produtos</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3 d-flex justify-content-between align-items-center">
                                    <span class="status-valid">Dentro do Prazo</span>
                                    <span id="count-valid" class="fw-bold">0</span>
                                </div>
                                <div class="mb-3 d-flex justify-content-between align-items-center">
                                    <span class="status-warning">Vencimento Próximo</span>
                                    <span id="count-warning" class="fw-bold">0</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="status-expired">Vencidos</span>
                                    <span id="count-expired" class="fw-bold">0</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- NOVA SEÇÃO: Produtos com Vencimento Próximo ou Vencidos -->
                        <div class="card mt-4">
                            <div class="card-header">
                                <h5 class="mb-0">Produtos com Vencimento Próximo ou Vencidos</h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="expiring-products-list" id="expiring-products-list">
                                    <!-- Itens serão carregados dinamicamente aqui -->
                                    <div class="text-center p-3 text-muted">
                                        Nenhum produto com vencimento próximo ou vencido
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tela de Relatório de Estoque -->
            <div id="stock-report-page" class="page">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="text-gradient">Relatório de Estoque</h2>
                    <div>
                        <button id="generate-stock-pdf" class="btn btn-primary me-2">
                            <i class="bi bi-file-earmark-pdf me-1"></i>Exportar PDF
                        </button>
                        <button id="generate-stock-excel" class="btn btn-success">
                            <i class="bi bi-file-earmark-spreadsheet me-1"></i>Exportar Excel
                        </button>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="stock-filter-date" class="form-label">Data do Relatório</label>
                                <input type="date" class="form-control" id="stock-filter-date">
                            </div>
                            <div class="col-md-6 d-flex align-items-end">
                                <div class="btn-group w-100">
                                    <button id="apply-stock-filters" class="btn btn-primary me-2 flex-fill">Filtrar</button>
                                    <button id="reset-stock-filters" class="btn btn-outline-secondary flex-fill">Limpar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Nº Relatório</th>
                                        <th>Data</th>
                                        <th>Movimentação</th>
                                        <th>Total de Itens</th>
                                        <th class="text-center">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="stock-list">
                                    <tr>
                                        <td colspan="5" class="text-center">Nenhum relatório encontrado</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tela de Cadastro de Movimentação -->
            <div id="report-page" class="page">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="text-gradient">Cadastro de Movimentação</h2>
                    <div>
                        <button id="view-history" class="btn btn-outline-secondary me-2">
                            <i class="bi bi-clock-history me-1"></i>Histórico
                        </button>
                    </div>
                </div>

                <div class="summary-card mb-4">
                    <h5>Resumo do Relatório</h5>
                    <p id="summary-text">Nenhum item adicionado ainda</p>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Adicionar Item</h5>
                    </div>
                    <div class="card-body">
                        <form id="movement-form">
                            <div class="row">
                                <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                                    <label class="form-label">Data</label>
                                    <input type="date" class="form-control" id="input-date" required>
                                </div>
                                <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                                    <label class="form-label">Tipo Movimento</label>
                                    <select class="form-select" id="input-movementType" required>
                                        <option value="Entrada">Entrada</option>
                                        <option value="Saída">Saída</option>
                                        <option value="Devolução">Devolução</option>
                                    </select>
                                </div>
                                <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                                    <label class="form-label">Produto</label>
                                    <select class="form-select" id="input-product" required>
                                        <option value="">Selecione um produto</option>
                                    </select>
                                </div>
                                <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                                    <label class="form-label">Quantidade</label>
                                    <input type="number" class="form-control" id="input-quantity" min="1" value="1" required>
                                </div>
                                <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                                    <label class="form-label">Tipo Produto</label>
                                    <input type="text" class="form-control" id="input-productType" readonly>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 col-sm-6 mb-3">
                                    <label class="form-label">Lote</label>
                                    <select class="form-select" id="input-batch">
                                        <option value="">Selecione um lote</option>
                                    </select>
                                    <div id="lote-info" class="form-text"></div>
                                </div>
                                <div class="col-md-4 col-sm-6 mb-3">
                                    <label class="form-label">Data Fabricação</label>
                                    <input type="date" class="form-control" id="input-manufacturingDate">
                                </div>
                                <div class="col-md-4 col-12 d-flex align-items-end">
                                    <button type="button" id="add-to-table" class="btn btn-primary w-100">
                                        <i class="bi bi-plus-circle me-1"></i>Adicionar Item
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="card mb-4" id="products-table-container" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0">Itens Adicionados</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Movimento</th>
                                        <th>Produto</th>
                                        <th>Quantidade</th>
                                        <th>Tipo</th>
                                        <th>Lote</th>
                                        <th>Fabricação</th>
                                        <th>Disponível</th>
                                        <th class="text-center">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="products-table-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Fotos (opcional)</h5>
                    </div>
                    <div class="card-body">
                        <input type="file" class="form-control" id="photos" multiple accept="image/*">
                        <div id="photo-previews" class="photo-preview-container mt-3"></div>
                    </div>
                </div>
                
                <div class="d-grid">
                    <button type="button" id="generate-pdf" class="btn btn-primary btn-lg">
                        <i class="bi bi-file-earmark-pdf me-2"></i>Gerar PDF e Salvar Relatório
                    </button>
                </div>
            </div>

            <!-- Tela de Estoque de Produtos -->
            <div id="products-page" class="page">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="text-gradient">Estoque de Produtos</h2>
                    <div>
                        <button id="export-products-excel" class="btn btn-success me-2">
                            <i class="bi bi-file-earmark-spreadsheet me-1"></i>Exportar para Excel
                        </button>
                        <button id="add-product" class="btn btn-primary">
                            <i class="bi bi-plus-circle me-1"></i>Adicionar Produto
                        </button>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 col-sm-6 mb-3">
                                <label for="products-filter-sku" class="form-label">SKU</label>
                                <input type="text" class="form-control" id="products-filter-sku" placeholder="Código SKU">
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <label for="products-filter-name" class="form-label">Produto</label>
                                <input type="text" class="form-control" id="products-filter-name" placeholder="Nome do produto">
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <label for="products-filter-type" class="form-label">Tipo de Produto</label>
                                <select class="form-select" id="products-filter-type">
                                    <option value="">Todos</option>
                                    <option value="Tambor">Tambor</option>
                                    <option value="Balde">Balde</option>
                                    <option value="Bombona">Bombona</option>
                                    <option value="IBC1000L">IBC1000L</option>
                                    <option value="Caixa">Caixa</option>
                                </select>
                            </div>
                            <div class="col-md-3 col-sm-12 mb-3 d-flex align-items-end">
                                <div class="btn-group w-100">
                                    <button id="apply-products-filters" class="btn btn-primary me-2 flex-fill">Filtrar</button>
                                    <button id="reset-products-filters" class="btn btn-outline-secondary flex-fill">Limpar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>SKU</th>
                                        <th>Produto</th>
                                        <th>Tipo</th>
                                        <th>Quantidade Total</th>
                                        <th>Lotes</th>
                                        <th class="text-center">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="products-list">
                                    <tr>
                                        <td colspan="6" class="text-center">Nenhum produto encontrado</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tela de Movimentação de Paletes (ATUALIZADA) -->
            <div id="paletes-page" class="page">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="text-gradient">Movimentação de Paletes</h2>
                    <div>
                        <button id="generate-paletes-pdf" class="btn btn-primary me-2">
                            <i class="bi bi-file-earmark-pdf me-1"></i>Gerar PDF
                        </button>
                        <button id="generate-paletes-excel" class="btn btn-success">
                            <i class="bi bi-file-earmark-spreadsheet me-1"></i>Exportar Excel
                        </button>
                    </div>
                </div>

                <!-- NOVO: Filtro de data para o relatório -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Filtros do Relatório</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="paletes-filter-date" class="form-label">Data do Relatório</label>
                                <input type="date" class="form-control" id="paletes-filter-date">
                            </div>
                            <div class="col-md-6 d-flex align-items-end">
                                <div class="btn-group w-100">
                                    <button id="apply-paletes-filters" class="btn btn-primary me-2 flex-fill">Filtrar</button>
                                    <button id="reset-paletes-filters" class="btn btn-outline-secondary flex-fill">Limpar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Relatório Diário de Paletes</h5>
                    </div>
                    <div class="card-body">
                        <div id="paletes-report-container">
                            <!-- Estrutura expansível será gerada dinamicamente aqui -->
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Adicionar Movimentação de Paletes</h5>
                    </div>
                    <div class="card-body">
                        <form id="paletes-form">
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Data</label>
                                    <input type="date" class="form-control" id="paletes-date" required>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Tipo de Palete</label>
                                    <select class="form-select" id="paletes-type" required>
                                        <option value="Fracionado">Fracionado</option>
                                        <option value="Tambor">Tambor</option>
                                        <option value="IBC 1000L">IBC 1000L</option>
                                        <option value="Outro">Outro</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Tipo de Movimento</label>
                                    <select class="form-select" id="paletes-movement" required>
                                        <option value="Entrada">Entrada</option>
                                        <option value="Saída">Saída</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Quantidade</label>
                                    <input type="number" class="form-control" id="paletes-quantity" min="1" value="1" required>
                                </div>
                            </div>
                            <div class="d-grid">
                                <button type="button" id="add-paletes-item" class="btn btn-primary">
                                    <i class="bi bi-plus-circle me-1"></i>Adicionar Movimentação
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- ADICIONAR APÓS A PÁGINA DE PALETES -->
<!-- Tela de Produtos Segregados -->
<div id="segregated-products-page" class="page">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-gradient">Produtos Segregados</h2>
        <div>
            <button id="generate-segregated-pdf" class="btn btn-primary me-2">
                <i class="bi bi-file-earmark-pdf me-1"></i>Exportar PDF
            </button>
            <button id="generate-segregated-excel" class="btn btn-success me-2">
                <i class="bi bi-file-earmark-spreadsheet me-1"></i>Exportar Excel
            </button>
            <button id="add-segregated-product" class="btn btn-warning">
                <i class="bi bi-shield-plus me-1"></i>Nova Segregação
            </button>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Filtros</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3 col-sm-6 mb-3">
                    <label for="segregated-filter-status" class="form-label">Status</label>
                    <select class="form-select" id="segregated-filter-status">
                        <option value="">Todos</option>
                        <option value="ativo">🟡 Ativo</option>
                        <option value="liberado">🟢 Liberado</option>
                        <option value="descartado">🔴 Descartado</option>
                    </select>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <label for="segregated-filter-motivo" class="form-label">Motivo</label>
                    <select class="form-select" id="segregated-filter-motivo">
                        <option value="">Todos</option>
                        <option value="qualidade">Controle de Qualidade</option>
                        <option value="quarentena">Quarentena</option>
                        <option value="nao-conformidade">Não Conformidade</option>
                        <option value="retorno-cliente">Retorno de Cliente</option>
                        <option value="analise-tecnica">Análise Técnica</option>
                        <option value="outros">Outros</option>
                    </select>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <label for="segregated-filter-responsavel" class="form-label">Responsável</label>
                    <input type="text" class="form-control" id="segregated-filter-responsavel" placeholder="Filtrar por responsável">
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <label for="segregated-filter-search" class="form-label">Buscar</label>
                    <input type="text" class="form-control" id="segregated-filter-search" placeholder="SKU ou Produto">
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="segregated-filter-data-inicio" class="form-label">Data Início (de)</label>
                    <input type="date" class="form-control" id="segregated-filter-data-inicio">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="segregated-filter-data-fim" class="form-label">Data Início (até)</label>
                    <input type="date" class="form-control" id="segregated-filter-data-fim">
                </div>
            </div>
            <div class="d-flex gap-2">
                <button id="apply-segregated-filters" class="btn btn-primary">Aplicar Filtros</button>
                <button id="reset-segregated-filters" class="btn btn-outline-secondary">Limpar Filtros</button>
            </div>
        </div>
    </div>

    <!-- Lista de Produtos Segregados -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Produtos em Segregação</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>SKU</th>
                            <th>Produto</th>
                            <th>Lote</th>
                            <th>Quantidade</th>
                            <th>Motivo</th>
                            <th>Localização</th>
                            <th>Responsável</th>
                            <th>Data Início</th>
                            <th>Previsão</th>
                            <th class="text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="segregated-products-list">
                        <tr>
                            <td colspan="11" class="text-center">Nenhum produto segregado encontrado</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

            <!-- Tela de Configurações -->
            <div id="config-page" class="page">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="text-gradient">Configurações do Sistema</h2>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="mb-4">
                            <h5>Preferências de Exibição</h5>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="dark-mode-toggle" checked>
                                <label class="form-check-label" for="dark-mode-toggle">Modo escuro</label>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <h5>Notificações</h5>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="notify-expiry" checked>
                                <label class="form-check-label" for="notify-expiry">Alertas de vencimento</label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="notify-low-stock" checked>
                                <label class="form-check-label" for="notify-low-stock">Alertas de estoque baixo</label>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <h5>Relatórios</h5>
                            <div class="mb-3">
                                <label for="report-format" class="form-label">Formato padrão de relatório</label>
                                <select class="form-select" id="report-format">
                                    <option value="pdf" selected>PDF</option>
                                    <option value="excel">Excel</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <h5>Sincronização Firebase</h5>
                            <div class="mb-3">
                                <div class="sync-status mb-2">
                                    <span class="sync-indicator sync-offline" id="config-sync-status-indicator"></span>
                                    <span id="config-sync-status-text">Status: Offline</span>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="button" id="sync-to-firebase" class="btn btn-primary btn-sm">
                                        <i class="bi bi-cloud-upload me-1"></i>Sincronizar com Firebase
                                    </button>
                                    <button type="button" id="sync-from-firebase" class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-cloud-download me-1"></i>Carregar do Firebase
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid">
                            <button type="button" id="save-config-btn" class="btn btn-primary">
                                <i class="bi bi-check-circle me-1"></i>Salvar Configurações
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- NOVO: Rodapé com créditos -->
    <div class="credits-footer">
        <div class="container">
            <p>Sistema desenvolvido por <strong>[Aldemir Garbino]</strong> com auxílio de IA</p>
            <p class="mb-0">© 2025 - Todos os direitos reservados</p>
        </div>
    </div>

    <!-- Modal para Adicionar Produto -->
    <div class="modal fade" id="addProductModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Adicionar Produto ao Estoque</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="add-product-form">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="new-product-sku" class="form-label">SKU *</label>
                                <input type="text" class="form-control" id="new-product-sku" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="new-product-name" class="form-label">Produto *</label>
                                <input type="text" class="form-control" id="new-product-name" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="new-product-type" class="form-label">Tipo de Produto *</label>
                                <select class="form-select" id="new-product-type" required>
                                    <option value="Tambor">Tambor</option>
                                    <option value="Balde">Balde</option>
                                    <option value="Bombona">Bombona</option>
                                    <option value="IBC1000L">IBC1000L</option>
                                    <option value="Caixa">Caixa</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="new-product-quantity" class="form-label">Quantidade *</label>
                                <input type="number" class="form-control" id="new-product-quantity" min="0" value="0" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="new-product-batch" class="form-label">Lote</label>
                                <input type="text" class="form-control" id="new-product-batch" placeholder="Opcional">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="new-product-manufacturing-date" class="form-label">Data de Fabricação *</label>
                                <input type="date" class="form-control" id="new-product-manufacturing-date" required>
                            </div>
                        </div>
                        <p class="text-muted">* Campos obrigatórios</p>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="save-new-product">Salvar Produto</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Adicionar/Editar Lote -->
    <div class="modal fade" id="loteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="loteModalTitle">Adicionar Lote ao Produto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="lote-form">
                        <input type="hidden" id="lote-sku">
                        <input type="hidden" id="lote-index">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="lote-quantity" class="form-label">Quantidade *</label>
                                <input type="number" class="form-control" id="lote-quantity" min="1" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="lote-batch" class="form-label">Lote</label>
                                <input type="text" class="form-control" id="lote-batch" placeholder="Opcional">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="lote-manufacturing-date" class="form-label">Data de Fabricação *</label>
                                <input type="date" class="form-control" id="lote-manufacturing-date" required>
                            </div>
                        </div>
                        <p class="text-muted">* Campos obrigatórios</p>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="save-lote">Salvar Lote</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Produto -->
    <div class="modal fade" id="editProductModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Produto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-product-form">
                        <input type="hidden" id="edit-product-index">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="edit-product-sku" class="form-label">SKU *</label>
                                <input type="text" class="form-control" id="edit-product-sku" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit-product-name" class="form-label">Produto *</label>
                                <input type="text" class="form-control" id="edit-product-name" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit-product-type" class="form-label">Tipo de Produto *</label>
                                <select class="form-select" id="edit-product-type" required>
                                    <option value="Tambor">Tambor</option>
                                    <option value="Balde">Balde</option>
                                    <option value="Bombona">Bombona</option>
                                    <option value="IBC1000L">IBC1000L</option>
                                    <option value="Caixa">Caixa</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit-product-quantity" class="form-label">Quantidade *</label>
                                <input type="number" class="form-control" id="edit-product-quantity" min="0" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit-product-batch" class="form-label">Lote</label>
                                <input type="text" class="form-control" id="edit-product-batch" placeholder="Opcional">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit-product-manufacturing-date" class="form-label">Data de Fabricação *</label>
                                <input type="date" class="form-control" id="edit-product-manufacturing-date" required>
                            </div>
                        </div>
                        <p class="text-muted">* Campos obrigatórios</p>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="update-product">Atualizar Produto</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Histórico -->
    <div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Histórico de Movimentações</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" placeholder="Buscar no histórico..." id="historySearch">
                            <button class="btn btn-outline-secondary" type="button" id="clearHistorySearch">Limpar</button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Movimento</th>
                                    <th>Produto</th>
                                    <th>Quantidade</th>
                                    <th>Lote</th>
                                    <th>Disponível</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <tr>
                                    <td colspan="6" class="text-center">Nenhum registro encontrado</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-danger" id="clearHistoryBtn">Limpar Histórico</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Relatório de Paletes -->
    <div class="modal fade" id="editPaletesModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Relatório de Paletes</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-paletes-form">
                        <input type="hidden" id="edit-paletes-id">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Data</label>
                                <input type="date" class="form-control" id="edit-paletes-date" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Número do Relatório</label>
                                <input type="text" class="form-control" id="edit-paletes-report-number" readonly>
                            </div>
                        </div>
                        <div id="edit-paletes-items-container">
                            <!-- Itens serão adicionados dinamicamente aqui -->
                        </div>
                        <div class="d-grid mt-3">
                            <button type="button" class="btn btn-outline-primary" id="add-edit-paletes-item">
                                <i class="bi bi-plus-circle me-1"></i>Adicionar Item
                            </button>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="save-edited-paletes">Salvar Alterações</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL PARA ADICIONAR/EDITAR PRODUTO SEGREGADO -->
<div class="modal fade" id="segregatedProductModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="segregatedModalTitle">Nova Segregação de Produto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="segregated-product-form">
                    <input type="hidden" id="segregated-id">
                    
                    <!-- Seção 1: Identificação do Produto -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">Identificação do Produto</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Produto *</label>
                                    <select class="form-select" id="segregated-product" required>
                                        <option value="">Selecione um produto</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Lote *</label>
                                    <select class="form-select" id="segregated-batch" required>
                                        <option value="">Selecione um lote</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">SKU</label>
                                    <input type="text" class="form-control" id="segregated-sku" readonly>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Tipo</label>
                                    <input type="text" class="form-control" id="segregated-type" readonly>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Quantidade *</label>
                                    <input type="number" class="form-control" id="segregated-quantity" min="1" required>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Seção 2: Dados da Segregação -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">Dados da Segregação</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Motivo da Segregação *</label>
                                    <select class="form-select" id="segregated-motivo" required>
                                        <option value="">Selecione o motivo</option>
                                        <option value="qualidade">Controle de Qualidade</option>
                                        <option value="quarentena">Quarentena</option>
                                        <option value="nao-conformidade">Não Conformidade</option>
                                        <option value="retorno-cliente">Retorno de Cliente</option>
                                        <option value="analise-tecnica">Análise Técnica</option>
                                        <option value="outros">Outros</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3" id="segregated-motivo-outros-container" style="display: none;">
                                    <label class="form-label">Especificar Outro Motivo *</label>
                                    <input type="text" class="form-control" id="segregated-motivo-outros" placeholder="Descreva o motivo">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Localização Física *</label>
                                    <input type="text" class="form-control" id="segregated-localizacao" required placeholder="Área de segregação">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Responsável *</label>
                                    <input type="text" class="form-control" id="segregated-responsavel" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" id="segregated-status">
                                        <option value="ativo">🟡 Ativo (em segregação)</option>
                                        <option value="liberado">🟢 Liberado</option>
                                        <option value="descartado">🔴 Descartado</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Data de Início *</label>
                                    <input type="date" class="form-control" id="segregated-data-inicio" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Previsão de Liberação</label>
                                    <input type="date" class="form-control" id="segregated-previsao-liberacao">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Data de Fim</label>
                                    <input type="date" class="form-control" id="segregated-data-fim" readonly>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <label class="form-label">Observações</label>
                                    <textarea class="form-control" id="segregated-observacoes" rows="3" maxlength="500" placeholder="Observações sobre a segregação (máx. 500 caracteres)"></textarea>
                                    <div class="form-text">
                                        <span id="segregated-observacoes-count">0</span>/500 caracteres
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Seção 3: Documentação -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">Documentação</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Fotos (mínimo 1, máximo 5)</label>
                                    <input type="file" class="form-control" id="segregated-fotos" multiple accept="image/*">
                                    <div class="form-text">Adicione fotos do produto segregado</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Documentos (opcional)</label>
                                    <input type="file" class="form-control" id="segregated-documentos" multiple accept=".pdf,.doc,.docx,.xls,.xlsx">
                                    <div class="form-text">Laudos, relatórios, comunicados</div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <div id="segregated-fotos-previews" class="photo-preview-container mt-3"></div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div id="segregated-documentos-list" class="document-list"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="save-segregated-product">Salvar Segregação</button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL PARA HISTÓRICO DE SEGREGAÇÃO -->
<div class="modal fade" id="segregatedHistoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Histórico de Alterações</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Usuário</th>
                                <th>Ação</th>
                                <th>Observações</th>
                            </tr>
                        </thead>
                        <tbody id="segregated-history-body">
                            <tr>
                                <td colspan="4" class="text-center">Nenhum registro encontrado</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDOy0Ylpkkq9GZQLJmmpfkLwCorptjceV4",
            authDomain: "controlemovimentacao-cbd0d.firebaseapp.com",
            projectId: "controlemovimentacao-cbd0d",
            storageBucket: "controlemovimentacao-cbd0d.firebasestorage.app",
            messagingSenderId: "607751879879",
            appId: "1:607751879879:web:0b1bfd6f0beb95b95812e2"
        };

        // Inicialização do Firebase
        let firebaseApp, db, storage;
        let isFirebaseInitialized = false;

        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            storage = firebase.storage();
            isFirebaseInitialized = true;
            console.log("Firebase inicializado com sucesso");
            updateSyncStatus(true, "Conectado");
        } catch (error) {
            console.error("Erro ao inicializar Firebase:", error);
            updateSyncStatus(false, "Erro de conexão");
        }

        // Função para atualizar status de sincronização
        function updateSyncStatus(isOnline, message) {
            const indicator = document.getElementById('sync-status-indicator');
            const text = document.getElementById('sync-status-text');
            const configIndicator = document.getElementById('config-sync-status-indicator');
            const configText = document.getElementById('config-sync-status-text');
            
            if (isOnline) {
                indicator.className = 'sync-indicator sync-online';
                text.textContent = message;
                configIndicator.className = 'sync-indicator sync-online';
                configText.textContent = `Status: ${message}`;
            } else {
                indicator.className = 'sync-indicator sync-offline';
                text.textContent = message;
                configIndicator.className = 'sync-indicator sync-offline';
                configText.textContent = `Status: ${message}`;
            }
        }

        // Função para sincronizar dados com Firebase
        async function syncToFirebase() {
            if (!isFirebaseInitialized) {
                alert("Firebase não está inicializado. Verifique a conexão.");
                return;
            }

            updateSyncStatus(true, "Sincronizando...");
            
            try {
                // Preparar dados para sincronização
                const dataToSync = {
                    productsData: JSON.parse(localStorage.getItem('productsData') || '[]'),
                    movementHistory: JSON.parse(localStorage.getItem('movementHistory') || '[]'),
                    reportsHistory: JSON.parse(localStorage.getItem('reportsHistory') || '[]'),
                    paletesData: JSON.parse(localStorage.getItem('paletesData') || '[]'),
                    lastReportNumber: localStorage.getItem('lastReportNumber') || '0',
                    lastPaletesReportNumber: localStorage.getItem('lastPaletesReportNumber') || '0',
                    syncTimestamp: new Date().toISOString()
                };

                // Salvar no Firestore
                await db.collection('systemData').doc('mainData').set(dataToSync);
                
                // Sincronizar fotos se houver
                const reportsWithPhotos = JSON.parse(localStorage.getItem('reportsWithPhotos') || '{}');
                for (const reportId in reportsWithPhotos) {
                    const photos = reportsWithPhotos[reportId];
                    for (let i = 0; i < photos.length; i++) {
                        const photoData = photos[i];
                        // Converter base64 para blob
                        const response = await fetch(photoData.data);
                        const blob = await response.blob();
                        
                        // Fazer upload para Firebase Storage
                        const storageRef = storage.ref();
                        const photoRef = storageRef.child(`reports/${reportId}/photo_${i}.jpg`);
                        await photoRef.put(blob);
                    }
                }

                updateSyncStatus(true, "Sincronizado");
                alert("Dados sincronizados com sucesso!");
            } catch (error) {
                console.error("Erro ao sincronizar com Firebase:", error);
                updateSyncStatus(false, "Erro na sincronização");
                alert("Erro ao sincronizar dados: " + error.message);
            }
        }

        // Função para carregar dados do Firebase
        async function syncFromFirebase() {
            if (!isFirebaseInitialized) {
                alert("Firebase não está inicializado. Verifique a conexão.");
                return;
            }

            updateSyncStatus(true, "Carregando...");
            
            try {
                const doc = await db.collection('systemData').doc('mainData').get();
                
                if (doc.exists) {
                    const data = doc.data();
                    
                    // Restaurar dados do localStorage
                    localStorage.setItem('productsData', JSON.stringify(data.productsData || []));
                    localStorage.setItem('movementHistory', JSON.stringify(data.movementHistory || []));
                    localStorage.setItem('reportsHistory', JSON.stringify(data.reportsHistory || []));
                    localStorage.setItem('paletesData', JSON.stringify(data.paletesData || []));
                    localStorage.setItem('lastReportNumber', data.lastReportNumber || '0');
                    localStorage.setItem('lastPaletesReportNumber', data.lastPaletesReportNumber || '0');
                    
                    // Recarregar as visualizações
                    loadProductsData();
                    loadStockReport();
                    loadPaletesData();
                    updateDashboard();
                    
                    updateSyncStatus(true, "Dados carregados");
                    alert("Dados carregados do Firebase com sucesso!");
                } else {
                    alert("Nenhum dado encontrado no Firebase.");
                    updateSyncStatus(true, "Sem dados no Firebase");
                }
            } catch (error) {
                console.error("Erro ao carregar do Firebase:", error);
                updateSyncStatus(false, "Erro ao carregar");
                alert("Erro ao carregar dados: " + error.message);
            }
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar data atual
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('input-date').value = today;
            document.getElementById('paletes-date').value = today;
            document.getElementById('stock-filter-date').value = today;
            document.getElementById('paletes-filter-date').value = today;
            document.getElementById('current-date').textContent = new Date().toLocaleDateString('pt-BR');
            
            // Configurar navegação
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const pageId = this.getAttribute('data-page');
                    showPage(pageId);
                    
                    // Atualizar navegação ativa
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // Botão de logout
            document.getElementById('logout-btn').addEventListener('click', function(e) {
                e.preventDefault();
                if (confirm('Tem certeza que deseja sair do sistema?')) {
                    alert('Saindo do sistema...');
                    // Em um sistema real, aqui seria o redirecionamento para a página de login
                }
            });
            
            // Inicializar dados
            initializeData();
            loadProductsForMovement();
            loadProductsData();
            loadStockReport();
            loadPaletesData();
            updateDashboard();
            
            // Configurar eventos
            setupEventListeners();
        });
        
        // Função para inicializar dados de exemplo
        function initializeData() {
            // Produtos
            if (!localStorage.getItem('productsData')) {
                const productsData = [
                    { 
                        SKU: "PROD001", 
                        Produto: "Produto A", 
                        Tipo: "Tambor", 
                        Quantidade: 50,
                        Lote: "LOTE-001",
                        'Data Fabricação': "2022-05-15",
                        Entradas: 50,
                        Saídas: 0,
                        id: 1
                    },
                    { 
                        SKU: "PROD001", 
                        Produto: "Produto A", 
                        Tipo: "Tambor", 
                        Quantidade: 100,
                        Lote: "LOTE-002",
                        'Data Fabricação': "2023-01-20",
                        Entradas: 100,
                        Saídas: 0,
                        id: 2
                    },
                    { 
                        SKU: "PROD002", 
                        Produto: "Produto B", 
                        Tipo: "Balde", 
                        Quantidade: 75,
                        Lote: "LOTE-003",
                        'Data Fabricação': "2021-10-18",
                        Entradas: 75,
                        Saídas: 0,
                        id: 3
                    },
                    { 
                        SKU: "PROD003", 
                        Produto: "Produto C", 
                        Tipo: "Bombona", 
                        Quantidade: 200,
                        Lote: "LOTE-004",
                        'Data Fabricação': "2023-03-10",
                        Entradas: 200,
                        Saídas: 0,
                        id: 4
                    }
                ];
                localStorage.setItem('productsData', JSON.stringify(productsData));
            }
            
            // Histórico de movimentações
            if (!localStorage.getItem('movementHistory')) {
                const today = new Date().toISOString().split('T')[0];
                const movementHistory = [
                    {
                        id: 1,
                        timestamp: new Date().toISOString(),
                        date: today,
                        movementType: 'Entrada',
                        productSKU: 'PROD001',
                        productName: 'Produto A',
                        quantity: 50,
                        productType: 'Tambor',
                        batch: 'LOTE-001',
                        manufacturingDate: '2023-05-15'
                    },
                    {
                        id: 2,
                        timestamp: new Date().toISOString(),
                        date: today,
                        movementType: 'Entrada',
                        productSKU: 'PROD002',
                        productName: 'Produto B',
                        quantity: 75,
                        productType: 'Balde',
                        batch: 'LOTE-002',
                        manufacturingDate: '2023-06-20'
                    },
                    {
                        id: 3,
                        timestamp: new Date().toISOString(),
                        date: today,
                        movementType: 'Saída',
                        productSKU: 'PROD001',
                        productName: 'Produto A',
                        quantity: 25,
                        productType: 'Tambor',
                        batch: 'LOTE-001',
                        manufacturingDate: '2023-05-15'
                    }
                ];
                localStorage.setItem('movementHistory', JSON.stringify(movementHistory));
            }
            
            // Relatórios de estoque
            if (!localStorage.getItem('reportsHistory')) {
                const today = new Date().toISOString().split('T')[0];
                const reportsHistory = [
                    {
                        reportNumber: 1,
                        date: today,
                        timestamp: new Date().toISOString(),
                        items: [
                            {
                                date: today,
                                movementType: 'Entrada',
                                productName: 'Produto A',
                                quantity: 50,
                                productType: 'Tambor',
                                batch: 'LOTE-001',
                                manufacturingDate: '2023-05-15'
                            },
                            {
                                date: today,
                                movementType: 'Saída',
                                productName: 'Produto B',
                                quantity: 25,
                                productType: 'Balde',
                                batch: 'LOTE-002',
                                manufacturingDate: '2023-06-20'
                            }
                        ]
                    }
                ];
                localStorage.setItem('reportsHistory', JSON.stringify(reportsHistory));
            }
            
            // Movimentação de paletes
            if (!localStorage.getItem('paletesData')) {
                const today = new Date().toISOString().split('T')[0];
                const paletesData = [
                    {
                        id: 1,
                        date: today,
                        reportNumber: 1,
                        items: [
                            { type: 'Fracionado', movement: 'Entrada', quantity: 15 },
                            { type: 'Tambor', movement: 'Saída', quantity: 8 },
                            { type: 'IBC 1000L', movement: 'Entrada', quantity: 5 }
                        ]
                    }
                ];
                localStorage.setItem('paletesData', JSON.stringify(paletesData));
            }

            // Inicializar armazenamento de fotos se não existir
            if (!localStorage.getItem('reportsWithPhotos')) {
                localStorage.setItem('reportsWithPhotos', JSON.stringify({}));
            }
        }

// ADICIONAR AO SCRIPT PRINCIPAL

// Inicializar dados de produtos segregados
function initializeSegregatedData() {
    if (!localStorage.getItem('segregatedProductsData')) {
        const segregatedProductsData = [];
        localStorage.setItem('segregatedProductsData', JSON.stringify(segregatedProductsData));
    }
}

// Configurar event listeners para produtos segregados
function setupSegregatedEventListeners() {
    // Botão para adicionar nova segregação
    document.getElementById('add-segregated-product').addEventListener('click', function() {
        openSegregatedProductModal();
    });

    // Filtros
    document.getElementById('apply-segregated-filters').addEventListener('click', function() {
        loadSegregatedProductsData();
    });

    document.getElementById('reset-segregated-filters').addEventListener('click', function() {
        document.getElementById('segregated-filter-status').value = '';
        document.getElementById('segregated-filter-motivo').value = '';
        document.getElementById('segregated-filter-responsavel').value = '';
        document.getElementById('segregated-filter-search').value = '';
        document.getElementById('segregated-filter-data-inicio').value = '';
        document.getElementById('segregated-filter-data-fim').value = '';
        loadSegregatedProductsData();
    });

    // Exportações
    document.getElementById('generate-segregated-pdf').addEventListener('click', generateSegregatedPDF);
    document.getElementById('generate-segregated-excel').addEventListener('click', generateSegregatedExcel);

    // Modal events
    document.getElementById('segregated-product').addEventListener('change', updateSegregatedProductDetails);
    document.getElementById('segregated-motivo').addEventListener('change', function() {
        const outrosContainer = document.getElementById('segregated-motivo-outros-container');
        outrosContainer.style.display = this.value === 'outros' ? 'block' : 'none';
        if (this.value !== 'outros') {
            document.getElementById('segregated-motivo-outros').value = '';
        }
    });

    document.getElementById('segregated-observacoes').addEventListener('input', function() {
        document.getElementById('segregated-observacoes-count').textContent = this.value.length;
    });

    document.getElementById('segregated-status').addEventListener('change', function() {
        const dataFimInput = document.getElementById('segregated-data-fim');
        if (this.value !== 'ativo') {
            dataFimInput.value = new Date().toISOString().split('T')[0];
        } else {
            dataFimInput.value = '';
        }
    });

    document.getElementById('segregated-fotos').addEventListener('change', handleSegregatedPhotoUpload);
    document.getElementById('save-segregated-product').addEventListener('click', saveSegregatedProduct);
}

// Abrir modal de produto segregado
function openSegregatedProductModal(segregatedId = null) {
    const modal = new bootstrap.Modal(document.getElementById('segregatedProductModal'));
    const form = document.getElementById('segregated-product-form');
    
    form.reset();
    document.getElementById('segregated-observacoes-count').textContent = '0';
    document.getElementById('segregated-motivo-outros-container').style.display = 'none';
    document.getElementById('segregated-fotos-previews').innerHTML = '';
    document.getElementById('segregated-documentos-list').innerHTML = '';
    
    // Configurar data atual
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('segregated-data-inicio').value = today;
    
    // Carregar produtos disponíveis
    loadProductsForSegregation();
    
    if (segregatedId) {
        // Modo edição
        document.getElementById('segregatedModalTitle').textContent = 'Editar Segregação';
        document.getElementById('segregated-id').value = segregatedId;
        loadSegregatedProductData(segregatedId);
    } else {
        // Modo novo
        document.getElementById('segregatedModalTitle').textContent = 'Nova Segregação de Produto';
        document.getElementById('segregated-id').value = '';
        document.getElementById('segregated-status').value = 'ativo';
    }
    
    modal.show();
}

// Carregar produtos para segregação
function loadProductsForSegregation() {
    const productSelect = document.getElementById('segregated-product');
    productSelect.innerHTML = '<option value="">Selecione um produto</option>';
    
    const productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
    const uniqueProducts = {};
    
    productsData.forEach(product => {
        if (!uniqueProducts[product.SKU]) {
            uniqueProducts[product.SKU] = {
                SKU: product.SKU,
                Produto: product.Produto,
                Tipo: product.Tipo
            };
        }
    });
    
    Object.values(uniqueProducts).forEach(product => {
        const option = document.createElement('option');
        option.value = product.SKU;
        option.textContent = `${product.SKU} - ${product.Produto} (${product.Tipo})`;
        option.setAttribute('data-type', product.Tipo);
        productSelect.appendChild(option);
    });
}

// Atualizar detalhes do produto selecionado
function updateSegregatedProductDetails() {
    const productSelect = document.getElementById('segregated-product');
    const selectedOption = productSelect.options[productSelect.selectedIndex];
    const skuInput = document.getElementById('segregated-sku');
    const typeInput = document.getElementById('segregated-type');
    const batchSelect = document.getElementById('segregated-batch');
    
    if (selectedOption.value) {
        skuInput.value = selectedOption.value;
        typeInput.value = selectedOption.getAttribute('data-type');
        
        // Carregar lotes disponíveis
        loadBatchesForSegregation(selectedOption.value);
    } else {
        skuInput.value = '';
        typeInput.value = '';
        batchSelect.innerHTML = '<option value="">Selecione um lote</option>';
    }
}

// Carregar lotes para o produto selecionado
function loadBatchesForSegregation(productSKU) {
    const batchSelect = document.getElementById('segregated-batch');
    batchSelect.innerHTML = '<option value="">Selecione um lote</option>';
    
    if (!productSKU) return;
    
    const productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
    const batches = productsData.filter(p => p.SKU === productSKU && p.Quantidade > 0);
    
    if (batches.length === 0) {
        batchSelect.innerHTML = '<option value="">Nenhum lote disponível</option>';
        return;
    }
    
    // Agrupar por lote
    const batchGroups = {};
    batches.forEach(product => {
        const lote = product.Lote || 'Sem Lote';
        if (!batchGroups[lote]) {
            batchGroups[lote] = {
                lote: lote,
                quantidade: 0,
                fabricacao: product['Data Fabricação']
            };
        }
        batchGroups[lote].quantidade += product.Quantidade;
    });
    
    Object.values(batchGroups).forEach(batch => {
        const option = document.createElement('option');
        option.value = batch.lote;
        option.textContent = `${batch.lote} (${batch.quantidade} disponíveis)`;
        batchSelect.appendChild(option);
    });
}

// Manipular upload de fotos para segregação
function handleSegregatedPhotoUpload(e) {
    const files = e.target.files;
    const previewContainer = document.getElementById('segregated-fotos-previews');
    
    // Limitar a 5 fotos
    const currentPhotos = previewContainer.children.length;
    const remainingSlots = 5 - currentPhotos;
    
    if (files.length > remainingSlots) {
        alert(`Você só pode adicionar mais ${remainingSlots} foto(s). Máximo de 5 fotos permitidas.`);
        return;
    }
    
    for (let i = 0; i < files.length && i < remainingSlots; i++) {
        const file = files[i];
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'photo-preview';
                img.alt = 'Preview da foto';
                
                const container = document.createElement('div');
                container.className = 'position-relative d-inline-block';
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn btn-sm btn-danger position-absolute top-0 end-0';
                removeBtn.innerHTML = '<i class="bi bi-x"></i>';
                removeBtn.style.transform = 'translate(30%, -30%)';
                
                removeBtn.addEventListener('click', function() {
                    container.remove();
                });
                
                container.appendChild(img);
                container.appendChild(removeBtn);
                previewContainer.appendChild(container);
            };
            
            reader.readAsDataURL(file);
        }
    }
}

// Salvar produto segregado
function saveSegregatedProduct() {
    const form = document.getElementById('segregated-product-form');
    const segregatedId = document.getElementById('segregated-id').value;
    
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Coletar dados do formulário
    const productSKU = document.getElementById('segregated-product').value;
    const batch = document.getElementById('segregated-batch').value;
    const quantity = parseInt(document.getElementById('segregated-quantity').value);
    const motivo = document.getElementById('segregated-motivo').value;
    const motivoOutros = document.getElementById('segregated-motivo-outros').value;
    const localizacao = document.getElementById('segregated-localizacao').value;
    const responsavel = document.getElementById('segregated-responsavel').value;
    const status = document.getElementById('segregated-status').value;
    const dataInicio = document.getElementById('segregated-data-inicio').value;
    const previsaoLiberacao = document.getElementById('segregated-previsao-liberacao').value;
    const dataFim = document.getElementById('segregated-data-fim').value;
    const observacoes = document.getElementById('segregated-observacoes').value;
    
    // Validar quantidade disponível
    const availableQuantity = getAvailableQuantity(productSKU, batch);
    if (quantity > availableQuantity) {
        alert(`Quantidade indisponível! Disponível: ${availableQuantity}`);
        return;
    }
    
    // Coletar fotos
    const fotos = [];
    const fotoPreviews = document.getElementById('segregated-fotos-previews').children;
    for (let i = 0; i < fotoPreviews.length; i++) {
        const img = fotoPreviews[i].querySelector('img');
        fotos.push({
            data: img.src,
            nome: `foto_${i + 1}.jpg`,
            tipo: 'image/jpeg'
        });
    }
    
    // Validar mínimo de fotos
    if (fotos.length === 0) {
        alert('É obrigatório adicionar pelo menos 1 foto do produto segregado!');
        return;
    }
    
    let segregatedProductsData = JSON.parse(localStorage.getItem('segregatedProductsData') || '[]');
    
    if (segregatedId) {
        // Modo edição
        const index = segregatedProductsData.findIndex(p => p.id == segregatedId);
        if (index !== -1) {
            // Adicionar ao histórico
            const historicoEntry = {
                data: new Date().toISOString(),
                usuario: 'Sistema', // Em um sistema real, pegar do usuário logado
                acao: 'Atualização de segregação',
                observacoes: `Status alterado para: ${getStatusText(status)}`
            };
            
            segregatedProductsData[index] = {
                ...segregatedProductsData[index],
                SKU: productSKU,
                Produto: document.getElementById('segregated-product').options[document.getElementById('segregated-product').selectedIndex].text.split(' - ')[1].split(' (')[0],
                Tipo: document.getElementById('segregated-type').value,
                Quantidade: quantity,
                Lote: batch,
                DataFabricacao: getManufacturingDate(productSKU, batch),
                MotivoSegregacao: motivo,
                MotivoSegregacaoOutros: motivo === 'outros' ? motivoOutros : '',
                Localizacao: localizacao,
                Responsavel: responsavel,
                StatusSegregacao: status,
                DataInicioSegregacao: dataInicio,
                DataPrevisaoLiberacao: previsaoLiberacao,
                DataFimSegregacao: dataFim,
                Observacoes: observacoes,
                Fotos: fotos,
                DataUltimaAtualizacao: new Date().toISOString(),
                UsuarioUltimaAtualizacao: 'Sistema',
                Historico: [...segregatedProductsData[index].Historico, historicoEntry]
            };
        }
    } else {
        // Modo novo
        const newSegregatedProduct = {
            id: Date.now(),
            SKU: productSKU,
            Produto: document.getElementById('segregated-product').options[document.getElementById('segregated-product').selectedIndex].text.split(' - ')[1].split(' (')[0],
            Tipo: document.getElementById('segregated-type').value,
            Quantidade: quantity,
            Lote: batch,
            DataFabricacao: getManufacturingDate(productSKU, batch),
            MotivoSegregacao: motivo,
            MotivoSegregacaoOutros: motivo === 'outros' ? motivoOutros : '',
            Localizacao: localizacao,
            Responsavel: responsavel,
            StatusSegregacao: status,
            DataInicioSegregacao: dataInicio,
            DataPrevisaoLiberacao: previsaoLiberacao,
            DataFimSegregacao: dataFim,
            Observacoes: observacoes,
            Fotos: fotos,
            Documentos: [], // Implementar upload de documentos se necessário
            Historico: [{
                data: new Date().toISOString(),
                usuario: 'Sistema',
                acao: 'Criação de segregação',
                observacoes: 'Produto colocado em segregação'
            }],
            DataCriacao: new Date().toISOString(),
            UsuarioCriacao: 'Sistema',
            DataUltimaAtualizacao: new Date().toISOString(),
            UsuarioUltimaAtualizacao: 'Sistema'
        };
        
        segregatedProductsData.push(newSegregatedProduct);
    }
    
    localStorage.setItem('segregatedProductsData', JSON.stringify(segregatedProductsData));
    
    // Atualizar estoque (remover quantidade segregada)
    updateStockForSegregation(productSKU, batch, quantity, segregatedId ? 'update' : 'new');
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('segregatedProductModal'));
    modal.hide();
    
    loadSegregatedProductsData();
    alert(segregatedId ? 'Segregação atualizada com sucesso!' : 'Produto segregado com sucesso!');
}

// Carregar dados do produto segregado para edição
function loadSegregatedProductData(segregatedId) {
    const segregatedProductsData = JSON.parse(localStorage.getItem('segregatedProductsData') || '[]');
    const product = segregatedProductsData.find(p => p.id == segregatedId);
    
    if (!product) return;
    
    // Preencher formulário
    document.getElementById('segregated-product').value = product.SKU;
    updateSegregatedProductDetails();
    
    // Aguardar carregamento dos lotes
    setTimeout(() => {
        document.getElementById('segregated-batch').value = product.Lote;
        document.getElementById('segregated-quantity').value = product.Quantidade;
        document.getElementById('segregated-motivo').value = product.MotivoSegregacao;
        document.getElementById('segregated-localizacao').value = product.Localizacao;
        document.getElementById('segregated-responsavel').value = product.Responsavel;
        document.getElementById('segregated-status').value = product.StatusSegregacao;
        document.getElementById('segregated-data-inicio').value = product.DataInicioSegregacao;
        document.getElementById('segregated-previsao-liberacao').value = product.DataPrevisaoLiberacao;
        document.getElementById('segregated-data-fim').value = product.DataFimSegregacao || '';
        document.getElementById('segregated-observacoes').value = product.Observacoes || '';
        document.getElementById('segregated-observacoes-count').textContent = (product.Observacoes || '').length;
        
        if (product.MotivoSegregacao === 'outros') {
            document.getElementById('segregated-motivo-outros-container').style.display = 'block';
            document.getElementById('segregated-motivo-outros').value = product.MotivoSegregacaoOutros || '';
        }
        
        // Carregar fotos existentes
        const previewContainer = document.getElementById('segregated-fotos-previews');
        previewContainer.innerHTML = '';
        
        product.Fotos.forEach((foto, index) => {
            const img = document.createElement('img');
            img.src = foto.data;
            img.className = 'photo-preview';
            img.alt = 'Preview da foto';
            
            const container = document.createElement('div');
            container.className = 'position-relative d-inline-block';
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'btn btn-sm btn-danger position-absolute top-0 end-0';
            removeBtn.innerHTML = '<i class="bi bi-x"></i>';
            removeBtn.style.transform = 'translate(30%, -30%)';
            
            removeBtn.addEventListener('click', function() {
                container.remove();
            });
            
            container.appendChild(img);
            container.appendChild(removeBtn);
            previewContainer.appendChild(container);
        });
    }, 100);
}

// Carregar lista de produtos segregados
function loadSegregatedProductsData() {
    const statusFilter = document.getElementById('segregated-filter-status').value;
    const motivoFilter = document.getElementById('segregated-filter-motivo').value;
    const responsavelFilter = document.getElementById('segregated-filter-responsavel').value.toLowerCase();
    const searchFilter = document.getElementById('segregated-filter-search').value.toLowerCase();
    const dataInicioFilter = document.getElementById('segregated-filter-data-inicio').value;
    const dataFimFilter = document.getElementById('segregated-filter-data-fim').value;
    
    let segregatedProductsData = JSON.parse(localStorage.getItem('segregatedProductsData') || '[]');
    
    // Aplicar filtros
    const filteredData = segregatedProductsData.filter(product => {
        return (!statusFilter || product.StatusSegregacao === statusFilter) &&
               (!motivoFilter || product.MotivoSegregacao === motivoFilter) &&
               (!responsavelFilter || product.Responsavel.toLowerCase().includes(responsavelFilter)) &&
               (!searchFilter || 
                product.SKU.toLowerCase().includes(searchFilter) || 
                product.Produto.toLowerCase().includes(searchFilter)) &&
               (!dataInicioFilter || product.DataInicioSegregacao >= dataInicioFilter) &&
               (!dataFimFilter || product.DataInicioSegregacao <= dataFimFilter);
    });
    
    // Ordenar por data de início (mais recente primeiro)
    filteredData.sort((a, b) => new Date(b.DataInicioSegregacao) - new Date(a.DataInicioSegregacao));
    
    const tbody = document.getElementById('segregated-products-list');
    tbody.innerHTML = '';
    
    if (filteredData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" class="text-center">Nenhum produto segregado encontrado</td></tr>';
        return;
    }
    
    filteredData.forEach(product => {
        const row = document.createElement('tr');
        const statusBadge = getStatusBadge(product.StatusSegregacao);
        const motivoText = getMotivoText(product.MotivoSegregacao, product.MotivoSegregacaoOutros);
        const isExpiring = checkIfSegregationExpiring(product.DataPrevisaoLiberacao);
        
        row.innerHTML = `
            <td>
                <span class="${statusBadge.class}">${statusBadge.text}</span>
                ${isExpiring && product.StatusSegregacao === 'ativo' ? '<i class="bi bi-exclamation-triangle text-warning ms-1" title="Segregação próxima do vencimento"></i>' : ''}
            </td>
            <td>${product.SKU}</td>
            <td>${product.Produto}</td>
            <td>${product.Lote}</td>
            <td>${product.Quantidade}</td>
            <td>${motivoText}</td>
            <td>${product.Localizacao}</td>
            <td>${product.Responsavel}</td>
            <td>${formatDate(product.DataInicioSegregacao)}</td>
            <td>${product.DataPrevisaoLiberacao ? formatDate(product.DataPrevisaoLiberacao) : 'N/A'}</td>
            <td class="text-center">
                <button class="btn btn-sm btn-outline-primary view-segregated-history" data-id="${product.id}" title="Histórico">
                    <i class="bi bi-clock-history"></i>
                </button>
                <button class="btn btn-sm btn-warning edit-segregated" data-id="${product.id}" title="Editar">
                    <i class="bi bi-pencil"></i>
                </button>
                ${product.StatusSegregacao === 'ativo' ? `
                    <button class="btn btn-sm btn-success liberar-segregated" data-id="${product.id}" title="Liberar">
                        <i class="bi bi-check-circle"></i>
                    </button>
                    <button class="btn btn-sm btn-danger descartar-segregated" data-id="${product.id}" title="Descartar">
                        <i class="bi bi-trash"></i>
                    </button>
                ` : ''}
            </td>
        `;
        
        tbody.appendChild(row);
    });
    
    // Adicionar eventos aos botões
    document.querySelectorAll('.view-segregated-history').forEach(btn => {
        btn.addEventListener('click', function() {
            const productId = this.getAttribute('data-id');
            viewSegregationHistory(productId);
        });
    });
    
    document.querySelectorAll('.edit-segregated').forEach(btn => {
        btn.addEventListener('click', function() {
            const productId = this.getAttribute('data-id');
            openSegregatedProductModal(productId);
        });
    });
    
    document.querySelectorAll('.liberar-segregated').forEach(btn => {
        btn.addEventListener('click', function() {
            const productId = this.getAttribute('data-id');
            liberarSegregatedProduct(productId);
        });
    });
    
    document.querySelectorAll('.descartar-segregated').forEach(btn => {
        btn.addEventListener('click', function() {
            const productId = this.getAttribute('data-id');
            descartarSegregatedProduct(productId);
        });
    });
}

// Funções auxiliares
function getStatusBadge(status) {
    switch(status) {
        case 'ativo': return { class: 'status-warning', text: '🟡 Ativo' };
        case 'liberado': return { class: 'status-valid', text: '🟢 Liberado' };
        case 'descartado': return { class: 'status-expired', text: '🔴 Descartado' };
        default: return { class: 'status-warning', text: status };
    }
}

function getMotivoText(motivo, outros) {
    const motivos = {
        'qualidade': 'Controle de Qualidade',
        'quarentena': 'Quarentena',
        'nao-conformidade': 'Não Conformidade',
        'retorno-cliente': 'Retorno de Cliente',
        'analise-tecnica': 'Análise Técnica',
        'outros': outros || 'Outros'
    };
    return motivos[motivo] || motivo;
}

function getStatusText(status) {
    const statusTexts = {
        'ativo': 'Ativo (em segregação)',
        'liberado': 'Liberado',
        'descartado': 'Descartado'
    };
    return statusTexts[status] || status;
}

function getManufacturingDate(sku, batch) {
    const productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
    const product = productsData.find(p => p.SKU === sku && p.Lote === batch);
    return product ? product['Data Fabricação'] : new Date().toISOString().split('T')[0];
}

function checkIfSegregationExpiring(previsaoLiberacao) {
    if (!previsaoLiberacao) return false;
    
    const previsao = new Date(previsaoLiberacao);
    const hoje = new Date();
    const diferencaDias = Math.ceil((previsao - hoje) / (1000 * 60 * 60 * 24));
    
    return diferencaDias <= 7 && diferencaDias >= 0; // Expira em 7 dias ou menos
}

// Atualizar estoque para segregação
function updateStockForSegregation(sku, batch, quantity, action) {
    let productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
    
    if (action === 'new') {
        // Para nova segregação, remover do estoque
        let remainingQuantity = quantity;
        const produtosOrdenados = productsData
            .filter(p => p.SKU === sku && p.Lote === batch && p.Quantidade > 0)
            .sort((a, b) => new Date(a['Data Fabricação']) - new Date(b['Data Fabricação']));
        
        for (let produto of produtosOrdenados) {
            if (remainingQuantity <= 0) break;
            
            const quantidadeDisponivel = produto.Quantidade;
            const quantidadeUsar = Math.min(remainingQuantity, quantidadeDisponivel);
            
            produto.Quantidade -= quantidadeUsar;
            produto.Saídas += quantidadeUsar;
            remainingQuantity -= quantidadeUsar;
        }
    }
    // Para atualização, a lógica seria mais complexa - implementar conforme necessidade
    
    localStorage.setItem('productsData', JSON.stringify(productsData));
}

// Visualizar histórico de segregação
function viewSegregationHistory(segregatedId) {
    const segregatedProductsData = JSON.parse(localStorage.getItem('segregatedProductsData') || '[]');
    const product = segregatedProductsData.find(p => p.id == segregatedId);
    
    if (!product || !product.Historico) return;
    
    const tbody = document.getElementById('segregated-history-body');
    tbody.innerHTML = '';
    
    // Ordenar histórico por data (mais recente primeiro)
    product.Historico.sort((a, b) => new Date(b.data) - new Date(a.data));
    
    product.Historico.forEach(entry => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${formatDate(entry.data)} ${new Date(entry.data).toLocaleTimeString('pt-BR')}</td>
            <td>${entry.usuario}</td>
            <td>${entry.acao}</td>
            <td>${entry.observacoes || '-'}</td>
        `;
        tbody.appendChild(row);
    });
    
    new bootstrap.Modal(document.getElementById('segregatedHistoryModal')).show();
}

// Liberar produto segregado
function liberarSegregatedProduct(segregatedId) {
    if (!confirm('Tem certeza que deseja liberar este produto da segregação?')) return;
    
    let segregatedProductsData = JSON.parse(localStorage.getItem('segregatedProductsData') || '[]');
    const index = segregatedProductsData.findIndex(p => p.id == segregatedId);
    
    if (index !== -1) {
        const product = segregatedProductsData[index];
        
        // Devolver ao estoque
        let productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
        const existingProductIndex = productsData.findIndex(p => 
            p.SKU === product.SKU && p.Lote === product.Lote
        );
        
        if (existingProductIndex !== -1) {
            productsData[existingProductIndex].Quantidade += product.Quantidade;
            productsData[existingProductIndex].Entradas += product.Quantidade;
        } else {
            productsData.push({
                SKU: product.SKU,
                Produto: product.Produto,
                Tipo: product.Tipo,
                Quantidade: product.Quantidade,
                Lote: product.Lote,
                'Data Fabricação': product.DataFabricacao,
                Entradas: product.Quantidade,
                Saídas: 0,
                id: Date.now()
            });
        }
        
        localStorage.setItem('productsData', JSON.stringify(productsData));
        
        // Atualizar segregação
        segregatedProductsData[index] = {
            ...product,
            StatusSegregacao: 'liberado',
            DataFimSegregacao: new Date().toISOString().split('T')[0],
            Historico: [
                ...product.Historico,
                {
                    data: new Date().toISOString(),
                    usuario: 'Sistema',
                    acao: 'Liberação de segregação',
                    observacoes: 'Produto liberado e retornado ao estoque normal'
                }
            ]
        };
        
        localStorage.setItem('segregatedProductsData', JSON.stringify(segregatedProductsData));
        loadSegregatedProductsData();
        alert('Produto liberado com sucesso!');
    }
}

// Descartar produto segregado
function descartarSegregatedProduct(segregatedId) {
    if (!confirm('Tem certeza que deseja descartar este produto? Esta ação não pode ser desfeita.')) return;
    
    let segregatedProductsData = JSON.parse(localStorage.getItem('segregatedProductsData') || '[]');
    const index = segregatedProductsData.findIndex(p => p.id == segregatedId);
    
    if (index !== -1) {
        const product = segregatedProductsData[index];
        
        // Produto é descartado, não retorna ao estoque
        
        // Atualizar segregação
        segregatedProductsData[index] = {
            ...product,
            StatusSegregacao: 'descartado',
            DataFimSegregacao: new Date().toISOString().split('T')[0],
            Historico: [
                ...product.Historico,
                {
                    data: new Date().toISOString(),
                    usuario: 'Sistema',
                    acao: 'Descarte de produto',
                    observacoes: 'Produto descartado por motivo de segregação'
                }
            ]
        };
        
        localStorage.setItem('segregatedProductsData', JSON.stringify(segregatedProductsData));
        loadSegregatedProductsData();
        alert('Produto descartado com sucesso!');
    }
}

// Gerar PDF de produtos segregados
function generateSegregatedPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Título
    doc.setFontSize(18);
    doc.text('RELATÓRIO DE PRODUTOS SEGREGADOS', 14, 15);
    doc.setFontSize(12);
    doc.text(`Data de geração: ${new Date().toLocaleDateString('pt-BR')}`, 14, 25);
    
    // Obter dados filtrados
    const filteredData = getFilteredSegregatedData();
    
    if (filteredData.length === 0) {
        doc.text('Nenhum produto segregado encontrado.', 14, 40);
        doc.save('relatorio_produtos_segregados.pdf');
        return;
    }
    
    // Tabela
    const tableData = filteredData.map(product => [
        getStatusBadge(product.StatusSegregacao).text,
        product.SKU,
        product.Produto,
        product.Lote,
        product.Quantidade.toString(),
        getMotivoText(product.MotivoSegregacao, product.MotivoSegregacaoOutros),
        product.Localizacao,
        product.Responsavel,
        formatDate(product.DataInicioSegregacao),
        product.DataPrevisaoLiberacao ? formatDate(product.DataPrevisaoLiberacao) : 'N/A'
    ]);
    
    doc.autoTable({
        startY: 35,
        head: [['Status', 'SKU', 'Produto', 'Lote', 'Qtd', 'Motivo', 'Localização', 'Responsável', 'Data Início', 'Previsão']],
        body: tableData,
        theme: 'grid'
    });
    
    doc.save('relatorio_produtos_segregados.pdf');
    alert('PDF de produtos segregados gerado com sucesso!');
}

// Gerar Excel de produtos segregados
function generateSegregatedExcel() {
    const filteredData = getFilteredSegregatedData();
    
    if (filteredData.length === 0) {
        alert('Nenhum produto segregado encontrado!');
        return;
    }
    
    const data = [
        ['Status', 'SKU', 'Produto', 'Lote', 'Quantidade', 'Motivo', 'Localização', 'Responsável', 'Data Início', 'Previsão Liberação']
    ];
    
    filteredData.forEach(product => {
        data.push([
            getStatusText(product.StatusSegregacao),
            product.SKU,
            product.Produto,
            product.Lote,
            product.Quantidade,
            getMotivoText(product.MotivoSegregacao, product.MotivoSegregacaoOutros),
            product.Localizacao,
            product.Responsavel,
            formatDate(product.DataInicioSegregacao),
            product.DataPrevisaoLiberacao ? formatDate(product.DataPrevisaoLiberacao) : 'N/A'
        ]);
    });
    
    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Produtos Segregados');
    XLSX.writeFile(wb, 'produtos_segregados.xlsx');
    alert('Excel de produtos segregados exportado com sucesso!');
}

// Obter dados filtrados de produtos segregados
function getFilteredSegregatedData() {
    const statusFilter = document.getElementById('segregated-filter-status').value;
    const motivoFilter = document.getElementById('segregated-filter-motivo').value;
    const responsavelFilter = document.getElementById('segregated-filter-responsavel').value.toLowerCase();
    const searchFilter = document.getElementById('segregated-filter-search').value.toLowerCase();
    const dataInicioFilter = document.getElementById('segregated-filter-data-inicio').value;
    const dataFimFilter = document.getElementById('segregated-filter-data-fim').value;
    
    let segregatedProductsData = JSON.parse(localStorage.getItem('segregatedProductsData') || '[]');
    
    return segregatedProductsData.filter(product => {
        return (!statusFilter || product.StatusSegregacao === statusFilter) &&
               (!motivoFilter || product.MotivoSegregacao === motivoFilter) &&
               (!responsavelFilter || product.Responsavel.toLowerCase().includes(responsavelFilter)) &&
               (!searchFilter || 
                product.SKU.toLowerCase().includes(searchFilter) || 
                product.Produto.toLowerCase().includes(searchFilter)) &&
               (!dataInicioFilter || product.DataInicioSegregacao >= dataInicioFilter) &&
               (!dataFimFilter || product.DataInicioSegregacao <= dataFimFilter);
    });
}

// ADICIONAR À FUNÇÃO showPage()
function showPage(pageId) {
    document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
    });
    document.getElementById(pageId).classList.add('active');
    
    // Atualizar dados específicos da página
    if (pageId === 'products-page') {
        loadProductsData();
    } else if (pageId === 'report-page') {
        loadProductsForMovement();
    } else if (pageId === 'stock-report-page') {
        loadStockReport();
    } else if (pageId === 'paletes-page') {
        loadPaletesData();
    } else if (pageId === 'dashboard-page') {
        updateDashboard();
    } else if (pageId === 'segregated-products-page') {
        loadSegregatedProductsData(); // NOVO
    }
}

// ADICIONAR À FUNÇÃO initializeData()
function initializeData() {
    // ... código existente ...
    
    // Produtos Segregados
    if (!localStorage.getItem('segregatedProductsData')) {
        const segregatedProductsData = [];
        localStorage.setItem('segregatedProductsData', JSON.stringify(segregatedProductsData));
    }
}

// ADICIONAR À FUNÇÃO setupEventListeners()
function setupEventListeners() {
    // ... código existente ...
    
    // Produtos Segregados
    setupSegregatedEventListeners();
}

// ADICIONAR CHAMADA NO DOMContentLoaded
document.addEventListener('DOMContentLoaded', function() {
    // ... código existente ...
    
    // Inicializar dados de produtos segregados
    initializeSegregatedData();
});

        
        // Função para configurar event listeners
        function setupEventListeners() {
            // Produtos
            document.getElementById('add-product').addEventListener('click', function() {
                document.getElementById('add-product-form').reset();
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('new-product-manufacturing-date').value = today;
                new bootstrap.Modal(document.getElementById('addProductModal')).show();
            });
            
            document.getElementById('save-new-product').addEventListener('click', addNewProduct);
            document.getElementById('save-lote').addEventListener('click', saveLote);
            document.getElementById('update-product').addEventListener('click', updateProduct);
            
            // Movimentação
            document.getElementById('input-product').addEventListener('change', function() {
                updateProductDetails();
                loadLotesForProduct();
            });
            
            document.getElementById('input-movementType').addEventListener('change', function() {
                loadLotesForProduct();
            });
            
            document.getElementById('add-to-table').addEventListener('click', addItemToTable);
            document.getElementById('generate-pdf').addEventListener('click', generatePDF);
            
            // Filtros
            document.getElementById('apply-stock-filters').addEventListener('click', function() {
                loadStockReport();
            });
            
            document.getElementById('reset-stock-filters').addEventListener('click', function() {
                document.getElementById('stock-filter-date').value = '';
                loadStockReport();
            });
            
            document.getElementById('apply-products-filters').addEventListener('click', function() {
                loadProductsData();
            });
            
            document.getElementById('reset-products-filters').addEventListener('click', function() {
                document.getElementById('products-filter-sku').value = '';
                document.getElementById('products-filter-name').value = '';
                document.getElementById('products-filter-type').value = '';
                loadProductsData();
            });
            
            // NOVOS EVENTOS PARA FILTROS DE PALETES
            document.getElementById('apply-paletes-filters').addEventListener('click', function() {
                loadPaletesData();
            });
            
            document.getElementById('reset-paletes-filters').addEventListener('click', function() {
                document.getElementById('paletes-filter-date').value = '';
                loadPaletesData();
            });
            
            // Histórico
            document.getElementById('view-history').addEventListener('click', function() {
                loadHistoryData();
                new bootstrap.Modal(document.getElementById('historyModal')).show();
            });
            
            document.getElementById('clearHistoryBtn').addEventListener('click', function() {
                if (confirm('Tem certeza que deseja limpar todo o histórico? Esta ação não pode ser desfeita.')) {
                    localStorage.removeItem('movementHistory');
                    loadHistoryData();
                    alert('Histórico limpo com sucesso!');
                }
            });
            
            document.getElementById('historySearch').addEventListener('input', function() {
                filterHistory(this.value);
            });
            
            document.getElementById('clearHistorySearch').addEventListener('click', function() {
                document.getElementById('historySearch').value = '';
                filterHistory('');
            });
            
            // Exportações
            document.getElementById('generate-stock-pdf').addEventListener('click', generateStockPDF);
            document.getElementById('generate-stock-excel').addEventListener('click', generateStockExcel);
            document.getElementById('export-products-excel').addEventListener('click', exportProductsExcel);
            document.getElementById('generate-paletes-pdf').addEventListener('click', generatePaletesPDF);
            document.getElementById('generate-paletes-excel').addEventListener('click', generatePaletesExcel);
            
            // Paletes
            document.getElementById('add-paletes-item').addEventListener('click', addPaletesItem);
            
            // Configurações
            document.getElementById('save-config-btn').addEventListener('click', function() {
                alert('Configurações salvas com sucesso!');
            });

            // Sincronização Firebase
            document.getElementById('sync-to-firebase').addEventListener('click', syncToFirebase);
            document.getElementById('sync-from-firebase').addEventListener('click', syncFromFirebase);
            
            // Upload de fotos
            document.getElementById('photos').addEventListener('change', handlePhotoUpload);
        }
        
        // Array para armazenar os produtos (para a tela de movimentação)
        let productsList = [];
        
        // Array para armazenar as fotos
        let uploadedPhotos = [];
        
        // Função para lidar com upload de fotos
        function handlePhotoUpload(e) {
            const files = e.target.files;
            const previewContainer = document.getElementById('photo-previews');
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'photo-preview';
                        img.alt = 'Preview da foto';
                        
                        // Adicionar botão de remover
                        const container = document.createElement('div');
                        container.className = 'position-relative d-inline-block';
                        
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'btn btn-sm btn-danger position-absolute top-0 end-0';
                        removeBtn.innerHTML = '<i class="bi bi-x"></i>';
                        removeBtn.style.transform = 'translate(30%, -30%)';
                        
                        removeBtn.addEventListener('click', function() {
                            container.remove();
                            // Remover também do array uploadedPhotos
                            const index = uploadedPhotos.findIndex(photo => photo.data === e.target.result);
                            if (index !== -1) {
                                uploadedPhotos.splice(index, 1);
                            }
                        });
                        
                        container.appendChild(img);
                        container.appendChild(removeBtn);
                        previewContainer.appendChild(container);
                        
                        // Armazenar a foto para o PDF
                        uploadedPhotos.push({
                            data: e.target.result,
                            width: 4, // 4x4 no PDF
                            height: 4
                        });
                    };
                    
                    reader.readAsDataURL(file);
                }
            }
        }
        
        // Função para mostrar página específica
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
            
            // Atualizar dados específicos da página
            if (pageId === 'products-page') {
                loadProductsData();
            } else if (pageId === 'report-page') {
                loadProductsForMovement();
            } else if (pageId === 'stock-report-page') {
                loadStockReport();
            } else if (pageId === 'paletes-page') {
                loadPaletesData();
            } else if (pageId === 'dashboard-page') {
                updateDashboard();
            }
        }
        
        // Função para atualizar o dashboard
        function updateDashboard() {
            const productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
            const movementHistory = JSON.parse(localStorage.getItem('movementHistory') || '[]');
            const paletesData = JSON.parse(localStorage.getItem('paletesData') || '[]');
            const today = new Date().toISOString().split('T')[0];
            
            // Total de produtos
            const uniqueProducts = [...new Set(productsData.map(p => p.SKU))];
            document.getElementById('total-products').textContent = uniqueProducts.length;
            
            // Movimentações do dia
            const todayMovements = movementHistory.filter(m => m.date === today);
            const entradas = todayMovements.filter(m => m.movementType === 'Entrada').reduce((sum, m) => sum + m.quantity, 0);
            const saidas = todayMovements.filter(m => m.movementType === 'Saída').reduce((sum, m) => sum + m.quantity, 0);
            
            document.getElementById('total-entradas').textContent = entradas;
            document.getElementById('total-saidas').textContent = saidas;
            
            // Alertas (produtos próximos do vencimento ou vencidos)
            let alertCount = 0;
            let validCount = 0;
            let warningCount = 0;
            let expiredCount = 0;
            
            // Array para produtos com vencimento próximo ou vencidos
            const expiringProducts = [];
            
            productsData.forEach(product => {
                const expiryDate = calculateExpiryDate(product['Data Fabricação']);
                const status = checkProductStatus(expiryDate);
                
                if (status.status === "Vencido") {
                    expiredCount++;
                    alertCount++;
                    expiringProducts.push({...product, status: "Vencido", expiryDate});
                } else if (status.status === "Vencimento Próximo") {
                    warningCount++;
                    alertCount++;
                    expiringProducts.push({...product, status: "Vencimento Próximo", expiryDate});
                } else {
                    validCount++;
                }
            });
            
            document.getElementById('total-alertas').textContent = alertCount;
            document.getElementById('count-valid').textContent = validCount;
            document.getElementById('count-warning').textContent = warningCount;
            document.getElementById('count-expired').textContent = expiredCount;
            
            // Atualizar lista de produtos com vencimento próximo ou vencidos
            updateExpiringProductsList(expiringProducts);
            
            // Movimentações recentes de paletes (últimas 5)
            const recentPaletesMovements = [];
            paletesData.forEach(report => {
                report.items.forEach(item => {
                    recentPaletesMovements.push({
                        date: report.date,
                        type: item.type,
                        movement: item.movement,
                        quantity: item.quantity
                    });
                });
            });
            
            // Ordenar por data (mais recente primeiro) e pegar as últimas 5
            recentPaletesMovements.sort((a, b) => new Date(b.date) - new Date(a.date));
            const recentPaletes = recentPaletesMovements.slice(0, 5);
            
            const paletesTbody = document.getElementById('recent-paletes-movements');
            paletesTbody.innerHTML = '';
            
            if (recentPaletes.length === 0) {
                paletesTbody.innerHTML = '<tr><td colspan="4" class="text-center">Nenhuma movimentação de paletes recente</td></tr>';
            } else {
                recentPaletes.forEach(movement => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${formatDate(movement.date)}</td>
                        <td>${movement.type}</td>
                        <td>${movement.movement}</td>
                        <td>${movement.quantity}</td>
                    `;
                    paletesTbody.appendChild(row);
                });
            }
            
            // Movimentações recentes de produtos (últimas 5)
            const recentProducts = movementHistory
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 5);
            
            const productsTbody = document.getElementById('recent-products-movements');
            productsTbody.innerHTML = '';
            
            if (recentProducts.length === 0) {
                productsTbody.innerHTML = '<tr><td colspan="5" class="text-center">Nenhuma movimentação de produtos recente</td></tr>';
            } else {
                recentProducts.forEach(movement => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${formatDate(movement.date)}</td>
                        <td>${movement.productName}</td>
                        <td>${movement.productType}</td>
                        <td>${movement.movementType}</td>
                        <td>${movement.quantity}</td>
                    `;
                    productsTbody.appendChild(row);
                });
            }
        }
        
        // Função para atualizar a lista de produtos com vencimento próximo ou vencidos
        function updateExpiringProductsList(expiringProducts) {
            const container = document.getElementById('expiring-products-list');
            container.innerHTML = '';
            
            if (expiringProducts.length === 0) {
                container.innerHTML = '<div class="text-center p-3 text-muted">Nenhum produto com vencimento próximo ou vencido</div>';
                return;
            }
            
            // Ordenar por status (vencidos primeiro) e depois por data de vencimento
            expiringProducts.sort((a, b) => {
                if (a.status === "Vencido" && b.status !== "Vencido") return -1;
                if (a.status !== "Vencido" && b.status === "Vencido") return 1;
                return new Date(a.expiryDate) - new Date(b.expiryDate);
            });
            
            expiringProducts.forEach(product => {
                const item = document.createElement('div');
                item.className = 'expiring-product-item';
                
                const statusClass = product.status === "Vencido" ? "status-expired" : "status-warning";
                
                item.innerHTML = `
                    <div class="expiring-product-info">
                        <div class="expiring-product-name">${product.Produto}</div>
                        <div class="expiring-product-details">
                            SKU: ${product.SKU} | Lote: ${product.Lote} | 
                            <span class="${statusClass}">${product.status}</span>
                        </div>
                        <div class="expiring-product-details">
                            Vencimento: ${formatDate(product.expiryDate)} | Quantidade: ${product.Quantidade}
                        </div>
                    </div>
                `;
                
                container.appendChild(item);
            });
        }
        
        // Função para carregar dados de paletes (ATUALIZADA)
        function loadPaletesData() {
            const filterDate = document.getElementById('paletes-filter-date').value;
            const paletesData = JSON.parse(localStorage.getItem('paletesData') || '[]');
            const container = document.getElementById('paletes-report-container');
            
            container.innerHTML = '';
            
            if (paletesData.length === 0) {
                container.innerHTML = '<p class="text-center">Nenhum relatório de paletes encontrado</p>';
                return;
            }
            
            // Filtrar por data se fornecida
            let filteredData = paletesData;
            if (filterDate) {
                filteredData = paletesData.filter(report => report.date === filterDate);
            }
            
            // Ordenar por data (mais recente primeiro)
            filteredData.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (filteredData.length === 0) {
                container.innerHTML = '<p class="text-center">Nenhum relatório encontrado para a data selecionada</p>';
                return;
            }
            
            filteredData.forEach(report => {
                const reportElement = document.createElement('div');
                reportElement.className = 'report-line mb-3';
                
                // Cabeçalho do relatório
                const header = document.createElement('div');
                header.className = 'report-header';
                header.innerHTML = `
                    <span>📊 Relatório Diário - ${formatDate(report.date)} - Nº ${report.reportNumber.toString().padStart(6, '0')}</span>
                    <div>
                        <button class="btn btn-sm btn-warning edit-paletes-report" data-id="${report.id}" title="Editar relatório">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <i class="bi bi-chevron-down"></i>
                    </div>
                `;
                
                // Detalhes do relatório
                const details = document.createElement('div');
                details.className = 'report-details';
                details.style.display = 'none';
                
                const movimentacaoTitle = document.createElement('div');
                movimentacaoTitle.innerHTML = '<strong>🏭 MOVIMENTAÇÃO DE PALETES</strong>';
                details.appendChild(movimentacaoTitle);
                
                // Calcular totais
                let totalEntradas = 0;
                let totalSaidas = 0;
                
                report.items.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'report-item';
                    itemElement.innerHTML = `
                        <span>${item.type}</span>
                        <span>${item.movement === 'Entrada' ? 'Entrada' : 'Saída'}: ${item.quantity} paletes</span>
                    `;
                    details.appendChild(itemElement);
                    
                    // Calcular totais
                    if (item.movement === 'Entrada') {
                        totalEntradas += item.quantity;
                    } else {
                        totalSaidas += item.quantity;
                    }
                });
                
                // Adicionar linha de totais
                const totalElement = document.createElement('div');
                totalElement.className = 'report-item mt-2 pt-2 border-top';
                totalElement.innerHTML = `
                    <span><strong>TOTAIS</strong></span>
                    <span><strong>Entradas: ${totalEntradas} | Saídas: ${totalSaidas}</strong></span>
                `;
                details.appendChild(totalElement);
                
                // Evento para expandir/recolher
                header.addEventListener('click', function(e) {
                    if (!e.target.closest('.edit-paletes-report')) {
                        const isVisible = details.style.display !== 'none';
                        details.style.display = isVisible ? 'none' : 'block';
                        this.querySelector('i.bi-chevron-down, i.bi-chevron-up').className = isVisible ? 'bi bi-chevron-down' : 'bi bi-chevron-up';
                    }
                });
                
                // Evento para editar relatório
                header.querySelector('.edit-paletes-report').addEventListener('click', function(e) {
                    e.stopPropagation();
                    const reportId = this.getAttribute('data-id');
                    editPaletesReport(reportId);
                });
                
                reportElement.appendChild(header);
                reportElement.appendChild(details);
                container.appendChild(reportElement);
            });
        }
        
        // Função para editar relatório de paletes
        function editPaletesReport(reportId) {
            const paletesData = JSON.parse(localStorage.getItem('paletesData') || '[]');
            const report = paletesData.find(r => r.id == reportId);
            
            if (!report) {
                alert('Relatório não encontrado!');
                return;
            }
            
            // Preencher formulário de edição
            document.getElementById('edit-paletes-id').value = report.id;
            document.getElementById('edit-paletes-date').value = report.date;
            document.getElementById('edit-paletes-report-number').value = report.reportNumber;
            
            // Limpar container de itens
            const itemsContainer = document.getElementById('edit-paletes-items-container');
            itemsContainer.innerHTML = '';
            
            // Adicionar itens existentes
            report.items.forEach((item, index) => {
                addEditPaletesItem(item, index);
            });
            
            // Mostrar modal
            new bootstrap.Modal(document.getElementById('editPaletesModal')).show();
        }
        
        // Função para adicionar item ao formulário de edição de paletes
        function addEditPaletesItem(item = null, index = null) {
            const itemsContainer = document.getElementById('edit-paletes-items-container');
            const itemIndex = index !== null ? index : itemsContainer.children.length;
            
            const itemElement = document.createElement('div');
            itemElement.className = 'row mb-3 border-bottom pb-3';
            itemElement.innerHTML = `
                <div class="col-md-4">
                    <label class="form-label">Tipo de Palete</label>
                    <select class="form-select edit-paletes-type" required>
                        <option value="Fracionado" ${item && item.type === 'Fracionado' ? 'selected' : ''}>Fracionado</option>
                        <option value="Tambor" ${item && item.type === 'Tambor' ? 'selected' : ''}>Tambor</option>
                        <option value="IBC 1000L" ${item && item.type === 'IBC 1000L' ? 'selected' : ''}>IBC 1000L</option>
                        <option value="Outro" ${item && item.type === 'Outro' ? 'selected' : ''}>Outro</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Tipo de Movimento</label>
                    <select class="form-select edit-paletes-movement" required>
                        <option value="Entrada" ${item && item.movement === 'Entrada' ? 'selected' : ''}>Entrada</option>
                        <option value="Saída" ${item && item.movement === 'Saída' ? 'selected' : ''}>Saída</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Quantidade</label>
                    <input type="number" class="form-control edit-paletes-quantity" min="1" value="${item ? item.quantity : '1'}" required>
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="button" class="btn btn-sm btn-danger remove-edit-paletes-item" ${itemsContainer.children.length === 0 ? 'disabled' : ''}>
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;
            
            itemsContainer.appendChild(itemElement);
            
            // Evento para remover item
            itemElement.querySelector('.remove-edit-paletes-item').addEventListener('click', function() {
                itemElement.remove();
            });
        }
        
        // Evento para adicionar item no formulário de edição
        document.getElementById('add-edit-paletes-item').addEventListener('click', function() {
            addEditPaletesItem();
        });
        
        // Evento para salvar alterações no relatório de paletes
        document.getElementById('save-edited-paletes').addEventListener('click', function() {
            const reportId = document.getElementById('edit-paletes-id').value;
            const date = document.getElementById('edit-paletes-date').value;
            const reportNumber = document.getElementById('edit-paletes-report-number').value;
            
            // Coletar itens
            const items = [];
            const itemElements = document.getElementById('edit-paletes-items-container').children;
            
            for (let i = 0; i < itemElements.length; i++) {
                const element = itemElements[i];
                const type = element.querySelector('.edit-paletes-type').value;
                const movement = element.querySelector('.edit-paletes-movement').value;
                const quantity = parseInt(element.querySelector('.edit-paletes-quantity').value);
                
                if (type && movement && quantity) {
                    items.push({ type, movement, quantity });
                }
            }
            
            if (items.length === 0) {
                alert('Adicione pelo menos um item ao relatório!');
                return;
            }
            
            // Atualizar relatório
            let paletesData = JSON.parse(localStorage.getItem('paletesData') || '[]');
            const reportIndex = paletesData.findIndex(r => r.id == reportId);
            
            if (reportIndex !== -1) {
                paletesData[reportIndex] = {
                    ...paletesData[reportIndex],
                    date,
                    items
                };
                
                localStorage.setItem('paletesData', JSON.stringify(paletesData));
                
                // Fechar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('editPaletesModal'));
                modal.hide();
                
                // Recarregar dados
                loadPaletesData();
                
                alert('Relatório atualizado com sucesso!');
            }
        });
        
        // Função para adicionar item de paletes
        function addPaletesItem() {
            const date = document.getElementById('paletes-date').value;
            const type = document.getElementById('paletes-type').value;
            const movement = document.getElementById('paletes-movement').value;
            const quantity = parseInt(document.getElementById('paletes-quantity').value);
            
            if (!date || !type || !movement || !quantity) {
                alert('Por favor, preencha todos os campos!');
                return;
            }
            
            let paletesData = JSON.parse(localStorage.getItem('paletesData') || '[]');
            
            // Verificar se já existe um relatório para esta data
            let existingReport = paletesData.find(r => r.date === date);
            
            if (!existingReport) {
                // Criar novo relatório
                const reportNumber = getNextPaletesReportNumber();
                existingReport = {
                    id: Date.now(),
                    date: date,
                    reportNumber: reportNumber,
                    items: []
                };
                paletesData.push(existingReport);
            }
            
            // Adicionar item ao relatório
            existingReport.items.push({
                type: type,
                movement: movement,
                quantity: quantity
            });
            
            // Salvar no localStorage
            localStorage.setItem('paletesData', JSON.stringify(paletesData));
            
            // Recarregar a exibição
            loadPaletesData();
            
            // Limpar formulário
            document.getElementById('paletes-form').reset();
            document.getElementById('paletes-date').value = date;
            document.getElementById('paletes-quantity').value = '1';
            
            alert('Movimentação de paletes adicionada com sucesso!');
        }
        
        // Função para obter o próximo número de relatório de paletes
        function getNextPaletesReportNumber() {
            let reportNumber = parseInt(localStorage.getItem('lastPaletesReportNumber') || '0');
            reportNumber++;
            localStorage.setItem('lastPaletesReportNumber', reportNumber.toString());
            return reportNumber;
        }
        
        // Função para gerar PDF de paletes (ATUALIZADA)
        function generatePaletesPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Título do relatório
            doc.setFontSize(18);
            doc.text('RELATÓRIO DE MOVIMENTAÇÃO DE PALETES', 14, 15);
            doc.setFontSize(12);
            doc.text(`Data de geração: ${new Date().toLocaleDateString('pt-BR')}`, 14, 25);
            
            // Obter dados com filtro aplicado
            const filterDate = document.getElementById('paletes-filter-date').value;
            let paletesData = JSON.parse(localStorage.getItem('paletesData') || '[]');
            
            // Aplicar filtro de data se existir
            if (filterDate) {
                paletesData = paletesData.filter(report => report.date === filterDate);
            }
            
            if (paletesData.length === 0) {
                doc.text('Nenhum dado de movimentação de paletes encontrado.', 14, 40);
                doc.save('relatorio_paletes.pdf');
                return;
            }
            
            // Ordenar por data (mais recente primeiro)
            paletesData.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let yPosition = 40;
            
            paletesData.forEach(report => {
                // Verificar se precisa de nova página
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                // Cabeçalho do relatório
                doc.setFontSize(14);
                doc.text(`Relatório Diário - Nº ${report.reportNumber.toString().padStart(6, '0')}`, 14, yPosition);
                yPosition += 7;
                
                doc.setFontSize(12);
                doc.text(`Data: ${formatDate(report.date)}`, 14, yPosition);
                yPosition += 7;
                doc.text(`Emissão: ${formatDate(report.date)} ${new Date().toLocaleTimeString('pt-BR')}`, 14, yPosition);
                yPosition += 10;
                
                // Seção de movimentação de paletes
                doc.setFontSize(12);
                doc.text('MOVIMENTAÇÃO DE PALETES', 14, yPosition);
                yPosition += 7;
                
                // Calcular totais
                let totalEntradas = 0;
                let totalSaidas = 0;
                
                // Detalhes das movimentações
                report.items.forEach(item => {
                    doc.text(`  ${item.type} - ${item.movement}: ${item.quantity} paletes`, 20, yPosition);
                    yPosition += 6;
                    
                    // Calcular totais
                    if (item.movement === 'Entrada') {
                        totalEntradas += item.quantity;
                    } else {
                        totalSaidas += item.quantity;
                    }
                });
                
                // Adicionar linha de totais
                yPosition += 5;
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text(`TOTAIS: Entradas: ${totalEntradas} | Saídas: ${totalSaidas}`, 20, yPosition);
                doc.setFont(undefined, 'normal');
                
                yPosition += 15;
            });
            
            // Adicionar créditos no final do PDF
            if (yPosition > 270) {
                doc.addPage();
                yPosition = 20;
            }
            
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text('Relatório de Movimentação BlueWay', 14, yPosition);
            
            doc.save('relatorio_paletes.pdf');
            alert('PDF de movimentação de paletes gerado com sucesso!');
        }
        
        // Função para exportar Excel de paletes (ATUALIZADA)
        function generatePaletesExcel() {
            const filterDate = document.getElementById('paletes-filter-date').value;
            let paletesData = JSON.parse(localStorage.getItem('paletesData') || '[]');
            
            // Aplicar filtro de data se existir
            if (filterDate) {
                paletesData = paletesData.filter(report => report.date === filterDate);
            }
            
            if (paletesData.length === 0) {
                alert('Nenhum dado de movimentação de paletes encontrado!');
                return;
            }
            
            // Ordenar por data (mais recente primeiro)
            paletesData.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Preparar dados para a planilha
            const data = [];
            
            // Cabeçalho
            data.push(['Relatório', 'Data', 'Tipo de Palete', 'Movimentação', 'Quantidade']);
            
            // Dados
            paletesData.forEach(report => {
                report.items.forEach(item => {
                    data.push([
                        `Nº ${report.reportNumber.toString().padStart(6, '0')}`,
                        formatDate(report.date),
                        item.type,
                        item.movement,
                        item.quantity
                    ]);
                });
            });
            
            // Adicionar linha de créditos
            data.push([]);
            data.push(['Relatório de Movimentação BlueWay']);
            
            // Criar planilha
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Movimentação de Paletes');
            
            // Salvar arquivo
            XLSX.writeFile(wb, 'movimentacao_paletes.xlsx');
            alert('Excel de movimentação de paletes exportado com sucesso!');
        }
        
        // Função para exportar produtos para Excel
        function exportProductsExcel() {
            const productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
            
            if (productsData.length === 0) {
                alert('Nenhum produto encontrado!');
                return;
            }
            
            // Preparar dados para a planilha
            const data = [];
            
            // Cabeçalho
            data.push(['SKU', 'Produto', 'Tipo', 'Quantidade', 'Lote', 'Data Fabricação', 'Status']);
            
            // Dados
            productsData.forEach(product => {
                const expiryDate = calculateExpiryDate(product['Data Fabricação']);
                const status = checkProductStatus(expiryDate);
                
                data.push([
                    product.SKU,
                    product.Produto,
                    product.Tipo,
                    product.Quantidade,
                    product.Lote,
                    formatDate(product['Data Fabricação']),
                    status.status
                ]);
            });
            
            // Adicionar linha de créditos
            data.push([]);
            data.push(['Relatório de Movimentação BlueWay']);
            
            // Criar planilha
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Estoque de Produtos');
            
            // Salvar arquivo
            XLSX.writeFile(wb, 'estoque_produtos.xlsx');
            alert('Excel de produtos exportado com sucesso!');
        }
        
        // Função para gerar PDF de estoque (ATUALIZADA para incluir fotos)
        function generateStockPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Título do relatório
            doc.setFontSize(18);
            doc.text('Relatório de Estoque', 14, 15);
            doc.setFontSize(12);
            doc.text(`Data de geração: ${new Date().toLocaleDateString('pt-BR')}`, 14, 25);
            
            // Obter dados filtrados
            const filteredData = getFilteredStockData();
            
            if (filteredData.length === 0) {
                doc.text('Nenhum dado encontrado para o filtro aplicado.', 14, 40);
                doc.save('relatorio_estoque.pdf');
                return;
            }
            
            // Tabela com os dados
            const tableData = filteredData.map(item => {
                return [
                    item.date,
                    item.movementType,
                    item.productName,
                    item.quantity,
                    item.productType,
                    item.batch,
                    formatDate(item.manufacturingDate)
                ];
            });
            
            doc.autoTable({
                startY: 35,
                head: [['Data', 'Movimento', 'Produto', 'Quantidade', 'Tipo', 'Lote', 'Fabrição']],
                body: tableData,
                theme: 'grid'
            });
            
            // Adicionar fotos se houver
            const reportsWithPhotos = JSON.parse(localStorage.getItem('reportsWithPhotos') || '{}');
            let yPosition = doc.lastAutoTable.finalY + 10;
            
            // Verificar se há fotos para os relatórios filtrados
            const reportNumbers = [...new Set(filteredData.map(item => item.reportNumber))];
            
            reportNumbers.forEach(reportNumber => {
                if (reportsWithPhotos[reportNumber] && reportsWithPhotos[reportNumber].length > 0) {
                    // Adicionar título para fotos
                    if (yPosition > 250) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    
                    doc.setFontSize(14);
                    doc.text(`Fotos do Relatório #${reportNumber}:`, 14, yPosition);
                    yPosition += 10;
                    
                    // Adicionar fotos
                    reportsWithPhotos[reportNumber].forEach((photo, index) => {
                        if (yPosition > 200) {
                            doc.addPage();
                            yPosition = 20;
                        }
                        
                        try {
                            doc.addImage(photo.data, 'JPEG', 14, yPosition, 40, 40);
                            yPosition += 45;
                        } catch (e) {
                            console.error('Erro ao adicionar imagem ao PDF:', e);
                        }
                    });
                    
                    yPosition += 10;
                }
            });
            
            // Adicionar créditos no final do PDF
            if (yPosition > 270) {
                doc.addPage();
                yPosition = 20;
            }
            
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text('Movimentação BlueWay', 14, yPosition);
            
            // Salvar o PDF
            doc.save('relatorio_estoque.pdf');
            alert('Relatório de estoque exportado com sucesso!');
        }
        
        // Função para gerar Excel de estoque
        function generateStockExcel() {
            const filteredData = getFilteredStockData();
            
            if (filteredData.length === 0) {
                alert('Nenhum dado encontrado para o filtro aplicado!');
                return;
            }
            
            // Preparar dados para a planilha
            const data = [];
            
            // Cabeçalho
            data.push(['Data', 'Movimento', 'Produto', 'Quantidade', 'Tipo', 'Lote', 'Data Fabricação']);
            
            // Dados
            filteredData.forEach(item => {
                data.push([
                    item.date,
                    item.movementType,
                    item.productName,
                    item.quantity,
                    item.productType,
                    item.batch,
                    formatDate(item.manufacturingDate)
                ]);
            });
            
            // Adicionar linha de créditos
            data.push([]);
            data.push(['Relatório de Movimentação BlueWay']);
            
            // Criar planilha
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Movimentações');
            
            // Salvar arquivo
            XLSX.writeFile(wb, 'relatorio_estoque.xlsx');
            alert('Excel de estoque exportado com sucesso!');
        }
        
        // Função para obter o próximo número de relatório
        function getNextReportNumber() {
            let reportNumber = parseInt(localStorage.getItem('lastReportNumber') || '0');
            reportNumber++;
            localStorage.setItem('lastReportNumber', reportNumber.toString());
            return reportNumber;
        }
        
        // Função para carregar produtos para a tela de movimentação
        function loadProductsForMovement() {
            const productSelect = document.getElementById('input-product');
            productSelect.innerHTML = '<option value="">Selecione um produto</option>';
            
            // Obter produtos do estoque
            const productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
            
            // Criar lista única de produtos (agrupando por SKU)
            const uniqueProducts = {};
            productsData.forEach(product => {
                if (!uniqueProducts[product.SKU]) {
                    uniqueProducts[product.SKU] = {
                        SKU: product.SKU,
                        Produto: product.Produto,
                        Tipo: product.Tipo
                    };
                }
            });
            
            // Adicionar opções ao select
            Object.values(uniqueProducts).forEach(product => {
                const option = document.createElement('option');
                option.value = product.SKU;
                option.textContent = `${product.SKU} - ${product.Produto} (${product.Tipo})`;
                option.setAttribute('data-type', product.Tipo);
                productSelect.appendChild(option);
            });
        }
        
        // Função para atualizar detalhes do produto na movimentação
        function updateProductDetails() {
            const productSelect = document.getElementById('input-product');
            const selectedOption = productSelect.options[productSelect.selectedIndex];
            const typeInput = document.getElementById('input-productType');
            
            if (selectedOption.value) {
                typeInput.value = selectedOption.getAttribute('data-type');
            } else {
                typeInput.value = '';
            }
        }
        
        // Função para carregar lotes para o produto selecionado
        function loadLotesForProduct() {
            const productSKU = document.getElementById('input-product').value;
            const movementType = document.getElementById('input-movementType').value;
            const batchSelect = document.getElementById('input-batch');
            const loteInfo = document.getElementById('lote-info');
            const manufacturingDateInput = document.getElementById('input-manufacturingDate');
            
            batchSelect.innerHTML = '<option value="">Selecione um lote</option>';
            loteInfo.innerHTML = '';
            manufacturingDateInput.value = '';
            
            if (!productSKU) return;
            
            // Obter produtos do estoque
            const productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
            
            if (movementType === 'Entrada') {
                // Para entrada, permitir novo lote ou lote existente
                batchSelect.innerHTML += '<option value="**NOVO_LOTE**">++ Novo Lote ++</option>';
                
                // Agrupar lotes existentes por lote
                const lotesExistentes = {};
                productsData.filter(p => p.SKU === productSKU).forEach(product => {
                    const lote = product.Lote || 'Sem Lote';
                    if (!lotesExistentes[lote]) {
                        lotesExistentes[lote] = {
                            lote: lote,
                            quantidade: 0,
                            fabricacao: product['Data Fabricação']
                        };
                    }
                    lotesExistentes[lote].quantidade += product.Quantidade;
                });
                
                // Adicionar lotes existentes
                Object.values(lotesExistentes).forEach(lote => {
                    const option = document.createElement('option');
                    option.value = lote.lote;
                    option.textContent = `${lote.lote} (${lote.quantidade} disponíveis)`;
                    option.setAttribute('data-fabricacao', lote.fabricacao);
                    batchSelect.appendChild(option);
                });
                
                loteInfo.innerHTML = 'Para entrada, selecione um lote existente ou crie um novo.';
                
            } else if (movementType === 'Saída' || movementType === 'Devolução') {
                // Para saída, mostrar apenas lotes com quantidade disponível
                const lotesDisponiveis = productsData.filter(p => 
                    p.SKU === productSKU && p.Quantidade > 0
                );
                
                if (lotesDisponiveis.length === 0) {
                    batchSelect.innerHTML = '<option value="">Nenhum lote disponível</option>';
                    loteInfo.innerHTML = '<span class="text-danger">Nenhum lote disponível para este produto.</span>';
                    return;
                }
                
                // Ordenar por data de fabricação (FIFO)
                lotesDisponiveis.sort((a, b) => new Date(a['Data Fabricação']) - new Date(b['Data Fabricação']));
                
                // Agrupar por lote
                const lotesAgrupados = {};
                lotesDisponiveis.forEach(product => {
                    const lote = product.Lote || 'Sem Lote';
                    if (!lotesAgrupados[lote]) {
                        lotesAgrupados[lote] = {
                            lote: lote,
                            quantidade: 0,
                            fabricacao: product['Data Fabricação'],
                            produtos: []
                        };
                    }
                    lotesAgrupados[lote].quantidade += product.Quantidade;
                    lotesAgrupados[lote].produtos.push(product);
                });
                
                // Adicionar opções
                Object.values(lotesAgrupados).forEach(lote => {
                    const option = document.createElement('option');
                    option.value = lote.lote;
                    option.textContent = `${lote.lote} (${lote.quantidade} disponíveis)`;
                    option.setAttribute('data-fabricacao', lote.fabricacao);
                    option.setAttribute('data-produtos', JSON.stringify(lote.produtos));
                    batchSelect.appendChild(option);
                });
                
                loteInfo.innerHTML = 'Para saída, o sistema usará o método FIFO (primeiro a entrar, primeiro a sair).';
            }
            
            // Event listener para quando o lote é selecionado
            batchSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption.value && selectedOption.getAttribute('data-fabricacao')) {
                    manufacturingDateInput.value = selectedOption.getAttribute('data-fabricacao');
                } else {
                    manufacturingDateInput.value = '';
                }
            });
        }
        
        // Função para adicionar novo produto
        function addNewProduct() {
            const sku = document.getElementById('new-product-sku').value;
            const product = document.getElementById('new-product-name').value;
            const type = document.getElementById('new-product-type').value;
            const quantity = document.getElementById('new-product-quantity').value;
            const batch = document.getElementById('new-product-batch').value;
            const manufacturingDate = document.getElementById('new-product-manufacturing-date').value;
            
            // Validar campos obrigatórios
            if (!sku || !product || !type || !quantity || !manufacturingDate) {
                alert('Por favor, preencha todos os campos obrigatórios!');
                return;
            }
            
            // Obter produtos existentes
            let productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
            
            // Verificar se já existe um produto com o mesmo SKU e lote
            const existingProductIndex = productsData.findIndex(p => 
                p.SKU === sku && p.Lote === (batch || 'Sem Lote')
            );
            
            if (existingProductIndex !== -1) {
                // Atualizar quantidade do produto existente
                productsData[existingProductIndex].Quantidade += parseInt(quantity);
                productsData[existingProductIndex].Entradas += parseInt(quantity);
            } else {
                // Adicionar novo produto
                productsData.push({
                    SKU: sku,
                    Produto: product,
                    Tipo: type,
                    Quantidade: parseInt(quantity),
                    Lote: batch || 'Sem Lote',
                    'Data Fabricação': manufacturingDate,
                    Entradas: parseInt(quantity),
                    Saídas: 0,
                    id: Date.now() // ID único para cada item
                });
            }
            
            // Salvar no localStorage
            localStorage.setItem('productsData', JSON.stringify(productsData));
            
            // Fechar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addProductModal'));
            modal.hide();
            
            // Recarregar tabela
            loadProductsData();
            
            alert('Produto adicionado com sucesso!');
        }
        
        // Função para abrir modal de adicionar/editar lote
        function openLoteModal(sku, index = null) {
            // Limpar formulário
            document.getElementById('lote-form').reset();
            
            // Definir SKU
            document.getElementById('lote-sku').value = sku;
            
            // Definir data atual como padrão
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('lote-manufacturing-date').value = today;
            
            // Configurar modal para edição se um índice for fornecido
            if (index !== null) {
                document.getElementById('loteModalTitle').textContent = 'Editar Lote';
                document.getElementById('lote-index').value = index;
                
                // Obter dados do lote
                const productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
                const lote = productsData[index];
                
                // Preencher formulário com dados existentes
                document.getElementById('lote-quantity').value = lote.Quantidade;
                document.getElementById('lote-batch').value = lote.Lote === 'Sem Lote' ? '' : lote.Lote;
                document.getElementById('lote-manufacturing-date').value = lote['Data Fabricação'];
            } else {
                document.getElementById('loteModalTitle').textContent = 'Adicionar Lote';
                document.getElementById('lote-index').value = '';
            }
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('loteModal'));
            modal.show();
        }
        
        // Função para salvar lote (adicionar ou editar)
        function saveLote() {
            const sku = document.getElementById('lote-sku').value;
            const index = document.getElementById('lote-index').value;
            const quantity = document.getElementById('lote-quantity').value;
            const batch = document.getElementById('lote-batch').value;
            const manufacturingDate = document.getElementById('lote-manufacturing-date').value;
            
            // Validar campos obrigatórios
            if (!quantity || !manufacturingDate) {
                alert('Por favor, preencha todos os campos obrigatórios!');
                return;
            }
            
            // Obter produtos existentes
            let productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
            
            if (index) {
                // Modo de edição - atualizar lote existente
                const loteIndex = parseInt(index);
                if (loteIndex >= 0 && loteIndex < productsData.length) {
                    productsData[loteIndex].Quantidade = parseInt(quantity);
                    productsData[loteIndex].Lote = batch || 'Sem Lote';
                    productsData[loteIndex]['Data Fabricação'] = manufacturingDate;
                }
            } else {
                // Modo de adição - verificar se já existe um lote com o mesmo nome
                const existingLoteIndex = productsData.findIndex(p => 
                    p.SKU === sku && p.Lote === (batch || 'Sem Lote')
                );
                
                if (existingLoteIndex !== -1) {
                    // Atualizar quantidade do lote existente
                    productsData[existingLoteIndex].Quantidade += parseInt(quantity);
                    productsData[existingLoteIndex].Entradas += parseInt(quantity);
                } else {
                    // Encontrar o produto base para copiar informações
                    const baseProduct = productsData.find(p => p.SKU === sku);
                    if (!baseProduct) {
                        alert('Produto não encontrado!');
                        return;
                    }
                    
                    // Adicionar novo lote
                    productsData.push({
                        SKU: sku,
                        Produto: baseProduct.Produto,
                        Tipo: baseProduct.Tipo,
                        Quantidade: parseInt(quantity),
                        Lote: batch || 'Sem Lote',
                        'Data Fabricação': manufacturingDate,
                        Entradas: parseInt(quantity),
                        Saídas: 0,
                        id: Date.now() // ID único para cada item
                    });
                }
            }
            
            // Salvar no localStorage
            localStorage.setItem('productsData', JSON.stringify(productsData));
            
            // Fechar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('loteModal'));
            modal.hide();
            
            // Recarregar tabela
            loadProductsData();
            
            alert(index ? 'Lote atualizado com sucesso!' : 'Lote adicionado com sucesso!');
        }
        
        // Função para editar produto
        function editProduct(index) {
            // Obter produtos do localStorage
            const productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
            
            if (index >= 0 && index < productsData.length) {
                const product = productsData[index];
                
                // Preencher formulário de edição
                document.getElementById('edit-product-index').value = index;
                document.getElementById('edit-product-sku').value = product.SKU;
                document.getElementById('edit-product-name').value = product.Produto;
                document.getElementById('edit-product-type').value = product.Tipo;
                document.getElementById('edit-product-quantity').value = product.Quantidade;
                document.getElementById('edit-product-batch').value = product.Lote === 'Sem Lote' ? '' : product.Lote;
                document.getElementById('edit-product-manufacturing-date').value = product['Data Fabricação'];
                
                // Mostrar modal de edição
                const modal = new bootstrap.Modal(document.getElementById('editProductModal'));
                modal.show();
            }
        }
        
        // Função para atualizar produto
        function updateProduct() {
            const index = document.getElementById('edit-product-index').value;
            const sku = document.getElementById('edit-product-sku').value;
            const product = document.getElementById('edit-product-name').value;
            const type = document.getElementById('edit-product-type').value;
            const quantity = document.getElementById('edit-product-quantity').value;
            const batch = document.getElementById('edit-product-batch').value;
            const manufacturingDate = document.getElementById('edit-product-manufacturing-date').value;
            
            // Validar campos obrigatórios
            if (!sku || !product || !type || !quantity || !manufacturingDate) {
                alert('Por favor, preencha todos os campos obrigatórios!');
                return;
            }
            
            // Obter produtos do localStorage
            let productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
            
            if (index >= 0 && index < productsData.length) {
                // Atualizar produto
                productsData[index] = {
                    ...productsData[index],
                    SKU: sku,
                    Produto: product,
                    Tipo: type,
                    Quantidade: parseInt(quantity),
                    Lote: batch || 'Sem Lote',
                    'Data Fabricação': manufacturingDate
                };
                
                // Salvar no localStorage
                localStorage.setItem('productsData', JSON.stringify(productsData));
                
                // Fechar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('editProductModal'));
                modal.hide();
                
                // Recarregar tabela
                loadProductsData();
                
                alert('Produto atualizado com sucesso!');
            }
        }
        
        // Função para excluir produto
        function deleteProduct(index) {
            if (confirm('Tem certeza que deseja excluir este produto?')) {
                // Obter produtos do localStorage
                let productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
                
                if (index >= 0 && index < productsData.length) {
                    // Remover produto
                    productsData.splice(index, 1);
                    
                    // Salvar no localStorage
                    localStorage.setItem('productsData', JSON.stringify(productsData));
                    
                    // Recarregar tabela
                    loadProductsData();
                    
                    alert('Produto excluído com sucesso!');
                }
            }
        }
        
        // Função para adicionar item à tabela (tela de movimentação)
        function addItemToTable() {
            // Obter valores dos campos
            const date = document.getElementById('input-date').value;
            const movementType = document.getElementById('input-movementType').value;
            const productSelect = document.getElementById('input-product');
            const productSKU = productSelect.value;
            const productText = productSelect.options[productSelect.selectedIndex].text;
            const quantity = parseInt(document.getElementById('input-quantity').value);
            const productType = document.getElementById('input-productType').value;
            const batchSelect = document.getElementById('input-batch');
            const batch = batchSelect.value;
            const manufacturingDate = document.getElementById('input-manufacturingDate').value;
            
            // Validar campos
            if (!date || !productSKU || !quantity || !batch) {
                alert('Por favor, preencha todos os campos obrigatórios!');
                return;
            }
            
            // Validar quantidade para saída
            if (movementType === 'Saída' || movementType === 'Devolução') {
                const availableQuantity = getAvailableQuantity(productSKU, batch);
                if (quantity > availableQuantity) {
                    alert(`Quantidade indisponível! Disponível: ${availableQuantity}`);
                    return;
                }
            }
            
            // Extrair nome do produto do texto do option
            const productName = productText.split(' - ')[1].split(' (')[0];
            
            // Adicionar produto à lista
            const productData = {
                date,
                movementType,
                productSKU,
                productName,
                quantity: quantity,
                productType,
                batch: batch === '**NOVO_LOTE**' ? 'Novo Lote' : batch,
                manufacturingDate,
                availableQuantity: movementType === 'Entrada' ? quantity : getAvailableQuantity(productSKU, batch)
            };
            
            productsList.push(productData);
            
            // Atualizar a tabela
            updateProductsTable();
            
            // Limpar o formulário (exceto data e tipo de movimento)
            document.getElementById('input-product').value = '';
            document.getElementById('input-quantity').value = '1';
            document.getElementById('input-batch').innerHTML = '<option value="">Selecione um lote</option>';
            document.getElementById('input-productType').value = '';
            document.getElementById('input-manufacturingDate').value = '';
            document.getElementById('lote-info').innerHTML = '';
            
            // Focar no campo de produto para próxima entrada
            document.getElementById('input-product').focus();
            
            // Mostrar mensagem de sucesso
            alert('Produto adicionado à tabela!');
        }
        
        // Função para obter quantidade disponível de um lote
        function getAvailableQuantity(productSKU, batch) {
            const productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
            const lotes = productsData.filter(p => p.SKU === productSKU && p.Lote === batch && p.Quantidade > 0);
            return lotes.reduce((total, p) => total + p.Quantidade, 0);
        }
        
        function updateProductsTable() {
            const tableBody = document.getElementById('products-table-body');
            const tableContainer = document.getElementById('products-table-container');
            
            tableBody.innerHTML = '';
            
            if (productsList.length === 0) {
                tableContainer.style.display = 'none';
                return;
            }
            
            tableContainer.style.display = 'block';
            
            productsList.forEach((product, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.date}</td>
                    <td>${product.movementType}</td>
                    <td>${product.productName}</td>
                    <td>${product.quantity}</td>
                    <td>${product.productType}</td>
                    <td>${product.batch}</td>
                    <td>${formatDate(product.manufacturingDate)}</td>
                    <td>${product.availableQuantity}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-warning table-action-btn edit-product" data-index="${index}" title="Alterar item">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger table-action-btn remove-product" data-index="${index}" title="Remover item">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Adicionar eventos aos botões de remover
            document.querySelectorAll('.remove-product').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    productsList.splice(index, 1);
                    updateProductsTable();
                    updateSummary();
                });
            });
            
            updateSummary();
        }
        
        function updateSummary() {
            let totalItems = productsList.length;
            let totalQuantity = 0;
            let entradaCount = 0;
            let saidaCount = 0;
            let devolucaoCount = 0;
            
            productsList.forEach(product => {
                totalQuantity += product.quantity;
                
                if (product.movementType === 'Entrada') {
                    entradaCount += product.quantity;
                } else if (product.movementType === 'Saída') {
                    saidaCount += product.quantity;
                } else if (product.movementType === 'Devolução') {
                    devolucaoCount += product.quantity;
                }
            });
            
            // Atualizar resumo
            const summaryText = document.getElementById('summary-text');
            if (totalItems === 0) {
                summaryText.textContent = 'Nenhum item adicionado ainda';
            } else {
                summaryText.innerHTML = `
                    <strong>Total de itens:</strong> ${totalItems} | 
                    <strong>Quantidade total:</strong> ${totalQuantity} |
                    <strong>Entradas:</strong> ${entradaCount} |
                    <strong>Saídas:</strong> ${saidaCount} |
                    <strong>Devoluções:</strong> ${devolucaoCount}
                `;
            }
        }
        
        // Função para gerar PDF e salvar relatório (ATUALIZADA para salvar fotos)
        function generatePDF() {
            if (productsList.length === 0) {
                alert('Adicione pelo menos um produto à tabela antes de gerar o PDF!');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Obter número do relatório
            const reportNumber = getNextReportNumber();
            const reportDate = document.getElementById('input-date').value;
            
            // Título do relatório
            doc.setFontSize(18);
            doc.text(`Relatório de Movimentação #${reportNumber}`, 14, 15);
            doc.setFontSize(12);
            doc.text(`Data: ${formatDate(reportDate)}`, 14, 22);
            doc.text(`Data de geração: ${new Date().toLocaleDateString()}`, 14, 28);
            
            // Tabela com os dados
            const tableData = productsList.map(product => [
                product.date,
                product.movementType,
                product.productName,
                product.quantity,
                product.productType,
                product.batch,
                formatDate(product.manufacturingDate),
                product.availableQuantity
            ]);
            
            doc.autoTable({
                startY: 35,
                head: [['Data', 'Movimento', 'Produto', 'Quantidade', 'Tipo', 'Lote', 'Fabrição', 'Disponível']],
                body: tableData,
                theme: 'grid'
            });
            
            // Adicionar fotos ao PDF se houver
            let yPosition = doc.lastAutoTable.finalY + 10;
            
            if (uploadedPhotos.length > 0) {
                doc.setFontSize(14);
                doc.text('Fotos:', 14, yPosition);
                yPosition += 10;
                
                uploadedPhotos.forEach((photo, index) => {
                    if (yPosition > 250) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    
                    try {
                        doc.addImage(photo.data, 'JPEG', 14, yPosition, 40, 40);
                        yPosition += 45;
                    } catch (e) {
                        console.error('Erro ao adicionar imagem ao PDF:', e);
                    }
                });
            }
            
            // Adicionar créditos no final do PDF
            const finalY = doc.lastAutoTable.finalY + 20;
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text('Relatório de Movimentação BlueWay', 14, finalY);
            
            // Salvar o PDF
            const fileName = `relatorio_movimentacao_${reportNumber}_${reportDate}.pdf`;
            doc.save(fileName);
            
            // Salvar relatório no histórico
            saveReportToHistory(reportNumber, reportDate);
            
            // Salvar fotos associadas ao relatório
            if (uploadedPhotos.length > 0) {
                saveReportPhotos(reportNumber, uploadedPhotos);
            }
            
            // Atualizar estoque com os produtos movimentados
            updateStockFromMovement();
            
            alert(`PDF gerado com sucesso! Relatório #${reportNumber} salvo.`);
        }
        
        // Função para salvar relatório no histórico
        function saveReportToHistory(reportNumber, reportDate) {
            let reportsHistory = JSON.parse(localStorage.getItem('reportsHistory') || '[]');
            
            const report = {
                reportNumber: reportNumber,
                date: reportDate,
                timestamp: new Date().toISOString(),
                items: [...productsList] // Copia os itens do relatório
            };
            
            reportsHistory.push(report);
            localStorage.setItem('reportsHistory', JSON.stringify(reportsHistory));
        }
        
        // Função para salvar fotos associadas a um relatório
        function saveReportPhotos(reportNumber, photos) {
            const reportsWithPhotos = JSON.parse(localStorage.getItem('reportsWithPhotos') || '{}');
            reportsWithPhotos[reportNumber] = photos;
            localStorage.setItem('reportsWithPhotos', JSON.stringify(reportsWithPhotos));
        }
        
        // Função para carregar dados dos produtos (com agrupamento)
        function loadProductsData() {
            const skuFilter = document.getElementById('products-filter-sku').value;
            const productFilter = document.getElementById('products-filter-name').value;
            const typeFilter = document.getElementById('products-filter-type').value;
            
            // Obter dados do localStorage
            let productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
            
            // Se não houver dados, usar dados de exemplo
            if (productsData.length === 0) {
                productsData = [
                    { 
                        SKU: "PROD001", 
                        Produto: "Produto A", 
                        Tipo: "Tambor", 
                        Quantidade: 50,
                        Lote: "LOTE-001",
                        'Data Fabricação': "2022-05-15",
                        Entradas: 50,
                        Saídas: 0,
                        id: 1
                    },
                    { 
                        SKU: "PROD001", 
                        Produto: "Produto A", 
                        Tipo: "Tambor", 
                        Quantidade: 100,
                        Lote: "LOTE-002",
                        'Data Fabricação': "2023-01-20",
                        Entradas: 100,
                        Saídas: 0,
                        id: 2
                    },
                    { 
                        SKU: "PROD002", 
                        Produto: "Produto B", 
                        Tipo: "Balde", 
                        Quantidade: 75,
                        Lote: "LOTE-003",
                        'Data Fabricação': "2021-10-18",
                        Entradas: 75,
                        Saídas: 0,
                        id: 3
                    },
                    { 
                        SKU: "PROD003", 
                        Produto: "Produto C", 
                        Tipo: "Bombona", 
                        Quantidade: 200,
                        Lote: "LOTE-004",
                        'Data Fabricação': "2023-03-10",
                        Entradas: 200,
                        Saídas: 0,
                        id: 4
                    }
                ];
                localStorage.setItem('productsData', JSON.stringify(productsData));
            }
            
            // Filtrar dados
            const filteredData = productsData.filter(item => {
                return (!skuFilter || item.SKU.toLowerCase().includes(skuFilter.toLowerCase())) &&
                       (!productFilter || item.Produto.toLowerCase().includes(productFilter.toLowerCase())) &&
                       (!typeFilter || item.Tipo === typeFilter);
            });
            
            // Agrupar produtos por SKU
            const groupedProducts = {};
            filteredData.forEach(item => {
                if (!groupedProducts[item.SKU]) {
                    groupedProducts[item.SKU] = {
                        SKU: item.SKU,
                        Produto: item.Produto,
                        Tipo: item.Tipo,
                        QuantidadeTotal: 0,
                        Lotes: [],
                        expanded: localStorage.getItem(`expanded_${item.SKU}`) === 'true'
                    };
                }
                groupedProducts[item.SKU].QuantidadeTotal += item.Quantidade;
                groupedProducts[item.SKU].Lotes.push(item);
            });
            
            // Atualizar tabela
            const tbody = document.getElementById('products-list');
            tbody.innerHTML = '';
            
            if (Object.keys(groupedProducts).length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">Nenhum resultado encontrado</td></tr>';
                return;
            }
            
            // Adicionar produtos agrupados à tabela
            Object.values(groupedProducts).forEach(group => {
                // Linha do grupo (cabeçalho)
                const groupRow = document.createElement('tr');
                groupRow.className = 'product-group';
                groupRow.setAttribute('data-sku', group.SKU);
                groupRow.innerHTML = `
                    <td>${group.SKU}</td>
                    <td>${group.Produto}</td>
                    <td>${group.Tipo}</td>
                    <td>${group.QuantidadeTotal}</td>
                    <td>
                        ${group.Lotes.length} lote(s)
                        ${group.Lotes.length > 1 ? '<span class="batch-indicator">' + group.Lotes.length + '</span>' : ''}
                    </td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-primary toggle-details" data-sku="${group.SKU}" title="${group.expanded ? 'Recolher' : 'Expandir'}">
                            <i class="bi ${group.expanded ? 'bi-dash' : 'bi-plus'}"></i>
                        </button>
                        <button class="btn btn-sm btn-success add-lote-btn" data-sku="${group.SKU}" title="Adicionar lote">
                            <i class="bi bi-plus-circle"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(groupRow);
                
                // Adicionar evento de clique para expandir/recolher
                groupRow.addEventListener('click', function(e) {
                    if (!e.target.closest('.toggle-details') && !e.target.closest('.add-lote-btn')) {
                        const sku = this.getAttribute('data-sku');
                        toggleProductDetails(sku);
                    }
                });
                
                // Adicionar evento ao botão de toggle
                groupRow.querySelector('.toggle-details').addEventListener('click', function(e) {
                    e.stopPropagation();
                    const sku = this.getAttribute('data-sku');
                    toggleProductDetails(sku);
                });
                
                // Adicionar evento ao botão de adicionar lote
                groupRow.querySelector('.add-lote-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    const sku = this.getAttribute('data-sku');
                    openLoteModal(sku);
                });
                
                // Linhas de detalhes (lotes) - se expandido
                if (group.expanded) {
                    // Ordenar lotes por data de fabricação
                    group.Lotes.sort((a, b) => new Date(a['Data Fabricação']) - new Date(b['Data Fabricação']));
                    
                    group.Lotes.forEach((lote, loteIndex) => {
                        // Calcular data de vencimento (4 anos após a fabricação)
                        const expiryDate = calculateExpiryDate(lote['Data Fabricação']);
                        
                        // Verificar status do produto
                        const statusInfo = checkProductStatus(expiryDate);
                        
                        const detailRow = document.createElement('tr');
                        detailRow.className = 'product-details';
                        detailRow.setAttribute('data-sku', group.SKU);
                        detailRow.innerHTML = `
                            <td class="batch-details"></td>
                            <td class="batch-details"></td>
                            <td class="batch-details"></td>
                            <td>${lote.Quantidade}</td>
                            <td>${lote.Lote || 'Sem Lote'}</td>
                            <td class="text-center">
                                <span class="${statusInfo.class}">${statusInfo.status}</span>
                                <button class="btn btn-sm btn-warning ms-2 edit-lote-btn" data-index="${productsData.findIndex(p => p.id === lote.id)}" title="Editar lote">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-danger ms-1 delete-lote-btn" data-index="${productsData.findIndex(p => p.id === lote.id)}" title="Excluir lote">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(detailRow);
                        
                        // Adicionar eventos aos botões de editar e excluir lote
                        detailRow.querySelector('.edit-lote-btn').addEventListener('click', function(e) {
                            e.stopPropagation();
                            const index = parseInt(this.getAttribute('data-index'));
                            openLoteModal(group.SKU, index);
                        });
                        
                        detailRow.querySelector('.delete-lote-btn').addEventListener('click', function(e) {
                            e.stopPropagation();
                            const index = parseInt(this.getAttribute('data-index'));
                            deleteProduct(index);
                        });
                        
                        // Adicionar linha com datas de fabricação e vencimento
                        const dateRow = document.createElement('tr');
                        dateRow.className = 'product-details';
                        dateRow.setAttribute('data-sku', group.SKU);
                        dateRow.innerHTML = `
                            <td class="batch-details" colspan="3"></td>
                            <td colspan="3">
                                <small>
                                    <strong>Fabricação:</strong> ${formatDate(lote['Data Fabricação'])} | 
                                    <strong>Vencimento:</strong> ${formatDate(expiryDate)} |
                                    <strong>Entradas:</strong> ${lote.Entradas} |
                                    <strong>Saídas:</strong> ${lote.Saídas}
                                </small>
                            </td>
                        `;
                        tbody.appendChild(dateRow);
                    });
                }
            });
        }
        
        // Função para expandir/recolher detalhes do produto
        function toggleProductDetails(sku) {
            // Alternar estado de expansão no localStorage
            const currentState = localStorage.getItem(`expanded_${sku}`) === 'true';
            localStorage.setItem(`expanded_${sku}`, !currentState);
            
            // Recarregar a tabela
            loadProductsData();
        }
        
        // Função para carregar relatório de estoque
        function loadStockReport() {
            const dateFilter = document.getElementById('stock-filter-date').value;
            
            // Obter relatórios do histórico
            let reportsHistory = JSON.parse(localStorage.getItem('reportsHistory') || '[]');
            
            // Se não houver dados, usar dados de exemplo
            if (reportsHistory.length === 0) {
                const today = new Date().toISOString().split('T')[0];
                reportsHistory = [
                    {
                        reportNumber: 1,
                        date: today,
                        timestamp: new Date().toISOString(),
                        items: [
                            {
                                date: today,
                                movementType: 'Entrada',
                                productName: 'Produto A',
                                quantity: 50,
                                productType: 'Tambor',
                                batch: 'LOTE-001',
                                manufacturingDate: '2023-05-15'
                            },
                            {
                                date: today,
                                movementType: 'Saída',
                                productName: 'Produto B',
                                quantity: 25,
                                productType: 'Balde',
                                batch: 'LOTE-002',
                                manufacturingDate: '2023-06-20'
                            }
                        ]
                    }
                ];
                localStorage.setItem('reportsHistory', JSON.stringify(reportsHistory));
            }
            
            // Filtrar por data se fornecida
            let filteredReports = reportsHistory;
            if (dateFilter) {
                filteredReports = reportsHistory.filter(report => report.date === dateFilter);
            }
            
            // Ordenar por número de relatório (decrescente)
            filteredReports.sort((a, b) => b.reportNumber - a.reportNumber);
            
            // Atualizar tabela
            const tbody = document.getElementById('stock-list');
            tbody.innerHTML = '';
            
            if (filteredReports.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">Nenhum relatório encontrado</td></tr>';
                return;
            }
            
            // Preencher tabela com relatórios
            filteredReports.forEach(report => {
                // Calcular totais por tipo de movimento
                const movimentos = {};
                report.items.forEach(item => {
                    if (!movimentos[item.movementType]) {
                        movimentos[item.movementType] = 0;
                    }
                    movimentos[item.movementType] += item.quantity;
                });
                
                // Criar badges para os movimentos
                const movimentosHTML = Object.entries(movimentos).map(([tipo, quantidade]) => 
                    `<span class="movement-badge movement-${tipo.toLowerCase()}">${tipo}: ${quantidade}</span>`
                ).join(' ');
                
                const row = document.createElement('tr');
                row.className = 'loading-group';
                row.setAttribute('data-report', report.reportNumber);
                row.innerHTML = `
                    <td>#${report.reportNumber}</td>
                    <td>${formatDate(report.date)}</td>
                    <td>${movimentosHTML}</td>
                    <td>${report.items.reduce((total, item) => total + item.quantity, 0)} itens</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-primary toggle-loading-details" data-report="${report.reportNumber}" title="Expandir/Recolher">
                            <i class="bi bi-plus"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
                
                // Adicionar evento ao botão de toggle
                row.querySelector('.toggle-loading-details').addEventListener('click', function(e) {
                    e.stopPropagation();
                    const reportNumber = this.getAttribute('data-report');
                    toggleReportDetails(reportNumber);
                });
                
                // Linhas de detalhes - se expandido
                const isExpanded = localStorage.getItem(`expanded_report_${report.reportNumber}`) === 'true';
                if (isExpanded) {
                    report.items.forEach((item, index) => {
                        const detailRow = document.createElement('tr');
                        detailRow.className = 'loading-details';
                        detailRow.setAttribute('data-report', report.reportNumber);
                        detailRow.innerHTML = `
                            <td class="batch-details"></td>
                            <td class="batch-details"></td>
                            <td>
                                <span class="movement-badge movement-${item.movementType.toLowerCase()}">${item.movementType}</span>
                                ${item.productName}
                            </td>
                            <td>${item.quantity}</td>
                            <td class="text-center">${item.batch}</td>
                        `;
                        tbody.appendChild(detailRow);
                    });
                    
                    // Atualizar ícone para menos
                    row.querySelector('.toggle-loading-details i').className = 'bi bi-dash';
                }
            });
        }
        
        // Função para expandir/recolher detalhes do relatório
        function toggleReportDetails(reportNumber) {
            // Alternar estado de expansão no localStorage
            const currentState = localStorage.getItem(`expanded_report_${reportNumber}`) === 'true';
            localStorage.setItem(`expanded_report_${reportNumber}`, !currentState);
            
            // Recarregar a tabela
            loadStockReport();
        }
        
        // Função para obter dados filtrados do estoque
        function getFilteredStockData() {
            const dateFilter = document.getElementById('stock-filter-date').value;
            
            // Obter dados do histórico de movimentações
            let movementHistory = JSON.parse(localStorage.getItem('movementHistory') || '[]');
            
            // Se não houver dados, usar dados de exemplo
            if (movementHistory.length === 0) {
                const today = new Date().toISOString().split('T')[0];
                movementHistory = [
                    {
                        id: 1,
                        timestamp: new Date().toISOString(),
                        date: today,
                        movementType: 'Entrada',
                        productSKU: 'PROD001',
                        productName: 'Produto A',
                        quantity: 50,
                        productType: 'Tambor',
                        batch: 'LOTE-001',
                        manufacturingDate: '2023-05-15'
                    },
                    {
                        id: 2,
                        timestamp: new Date().toISOString(),
                        date: today,
                        movementType: 'Entrada',
                        productSKU: 'PROD002',
                        productName: 'Produto B',
                        quantity: 75,
                        productType: 'Balde',
                        batch: 'LOTE-002',
                        manufacturingDate: '2023-06-20'
                    },
                    {
                        id: 3,
                        timestamp: new Date().toISOString(),
                        date: today,
                        movementType: 'Saída',
                        productSKU: 'PROD001',
                        productName: 'Produto A',
                        quantity: 25,
                        productType: 'Tambor',
                        batch: 'LOTE-001',
                        manufacturingDate: '2023-05-15'
                    }
                ];
                localStorage.setItem('movementHistory', JSON.stringify(movementHistory));
            }
            
            // Filtrar por data se fornecida
            if (dateFilter) {
                return movementHistory.filter(item => item.date === dateFilter);
            }
            
            return movementHistory;
        }
        
        // Função para carregar dados do histórico
        function loadHistoryData() {
            const historyData = JSON.parse(localStorage.getItem('movementHistory') || '[]');
            const tbody = document.getElementById('historyTableBody');
            
            tbody.innerHTML = '';
            
            if (historyData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">Nenhum registro encontrado</td></tr>';
                return;
            }
            
            // Ordenar por data (mais recente primeiro)
            historyData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            historyData.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(item.date)}</td>
                    <td>${item.movementType}</td>
                    <td>${item.productName}</td>
                    <td>${item.quantity}</td>
                    <td>${item.batch || 'N/A'}</td>
                    <td>${item.remainingQuantity !== undefined ? item.remainingQuantity : 'N/A'}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Função para filtrar histórico
        function filterHistory(searchTerm) {
            const rows = document.getElementById('historyTableBody').querySelectorAll('tr');
            const term = searchTerm.toLowerCase();
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(term)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        // Função para atualizar o estoque com base na movimentação (FIFO)
        function updateStockFromMovement() {
            // Obter produtos do estoque
            let productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
            
            // Para cada produto na movimentação, atualizar o estoque
            productsList.forEach(movement => {
                if (movement.movementType === 'Entrada') {
                    // Para entrada, verificar se já existe um lote com o mesmo nome
                    const existingLoteIndex = productsData.findIndex(p => 
                        p.SKU === movement.productSKU && p.Lote === movement.batch
                    );
                    
                    if (existingLoteIndex !== -1) {
                        // Atualizar quantidade do lote existente
                        productsData[existingLoteIndex].Quantidade += movement.quantity;
                        productsData[existingLoteIndex].Entradas += movement.quantity;
                    } else {
                        // Adicionar novo item ao estoque
                        const newProduct = {
                            SKU: movement.productSKU,
                            Produto: movement.productName,
                            Tipo: movement.productType,
                            Quantidade: movement.quantity,
                            Lote: movement.batch,
                            'Data Fabricação': movement.manufacturingDate,
                            Entradas: movement.quantity,
                            Saídas: 0,
                            id: Date.now()
                        };
                        
                        productsData.push(newProduct);
                    }
                    
                    // Salvar no histórico de movimentações
                    saveToMovementHistory(movement, movement.quantity);
                    
                } else if (movement.movementType === 'Saída') {
                    // Para saída, usar método FIFO
                    let remainingQuantity = movement.quantity;
                    const movimentacaoLotes = [];
                    
                    // Ordenar produtos por data de fabricação (mais antigos primeiro)
                    const produtosOrdenados = productsData
                        .filter(p => p.SKU === movement.productSKU && p.Quantidade > 0)
                        .sort((a, b) => new Date(a['Data Fabricação']) - new Date(b['Data Fabricação']));
                    
                    // Processar saída por lote (FIFO)
                    for (let produto of produtosOrdenados) {
                        if (remainingQuantity <= 0) break;
                        
                        const quantidadeDisponivel = produto.Quantidade;
                        const quantidadeUsar = Math.min(remainingQuantity, quantidadeDisponivel);
                        
                        // Registrar movimentação do lote
                        movimentacaoLotes.push({
                            lote: produto.Lote,
                            quantidade: quantidadeUsar,
                            disponivelAntes: quantidadeDisponivel
                        });
                        
                        // Atualizar quantidade no estoque
                        produto.Quantidade -= quantidadeUsar;
                        produto.Saídas += quantidadeUsar;
                        remainingQuantity -= quantidadeUsar;
                    }
                    
                    // Salvar detalhes da movimentação no histórico
                    movement.lotesUtilizados = movimentacaoLotes;
                    movement.remainingQuantity = remainingQuantity;
                    saveToMovementHistory(movement, movement.quantity - remainingQuantity);
                    
                } else if (movement.movementType === 'Devolução') {
                    // Para devolução, similar à entrada mas com registro específico
                    const existingLoteIndex = productsData.findIndex(p => 
                        p.SKU === movement.productSKU && p.Lote === movement.batch
                    );
                    
                    if (existingLoteIndex !== -1) {
                        // Atualizar quantidade do lote existente
                        productsData[existingLoteIndex].Quantidade += movement.quantity;
                        productsData[existingLoteIndex].Entradas += movement.quantity;
                    } else {
                        const newProduct = {
                            SKU: movement.productSKU,
                            Produto: movement.productName,
                            Tipo: movement.productType,
                            Quantidade: movement.quantity,
                            Lote: movement.batch,
                            'Data Fabricação': movement.manufacturingDate,
                            Entradas: movement.quantity,
                            Saídas: 0,
                            id: Date.now(),
                            isDevolucao: true
                        };
                        
                        productsData.push(newProduct);
                    }
                    
                    // Salvar no histórico de movimentações
                    saveToMovementHistory(movement, movement.quantity);
                }
            });
            
            // Remover produtos com quantidade zero
           // productsData = productsData.filter(p => p.Quantidade > 0);
            
            // Salvar no localStorage
            localStorage.setItem('productsData', JSON.stringify(productsData));
            
            // Limpar lista de produtos da movimentação
            productsList = [];
            updateProductsTable();
            
            // Limpar fotos
            uploadedPhotos = [];
            document.getElementById('photo-previews').innerHTML = '';
            
            // Recarregar estoque se estiver na página de produtos
            if (document.getElementById('products-page').classList.contains('active')) {
                loadProductsData();
            }
            
            // Recarregar relatório de estoque se estiver ativo
            if (document.getElementById('stock-report-page').classList.contains('active')) {
                loadStockReport();
            }
        }
        
        // Função para salvar movimentação no histórico
        function saveToMovementHistory(movement, quantidadeProcessada) {
            let movementHistory = JSON.parse(localStorage.getItem('movementHistory') || '[]');
            
            // Adicionar ID único e timestamp
            movementHistory.push({
                id: Date.now(),
                timestamp: new Date().toISOString(),
                ...movement,
                quantidadeProcessada: quantidadeProcessada,
                remainingQuantity: movement.remainingQuantity || 0
            });
            
            localStorage.setItem('movementHistory', JSON.stringify(movementHistory));
        }
        
        // Função para calcular a data de vencimento (4 anos após a fabricação)
        function calculateExpiryDate(manufacturingDate) {
            if (!manufacturingDate) return 'N/A';
            
            const date = new Date(manufacturingDate);
            date.setFullYear(date.getFullYear() + 4);
            return date.toISOString().split('T')[0];
        }
        
        // Função para verificar o status do produto
        function checkProductStatus(expiryDate) {
            if (!expiryDate || expiryDate === 'N/A') {
                return { status: "Sem data", class: "status-warning" };
            }
            
            const today = new Date();
            const expiry = new Date(expiryDate);
            const oneYearBefore = new Date(expiry);
            oneYearBefore.setFullYear(oneYearBefore.getFullYear() - 1);
            
            if (today > expiry) {
                return { status: "Vencido", class: "status-expired" };
            } else if (today > oneYearBefore) {
                return { status: "Vencimento Próximo", class: "status-warning" };
            } else {
                return { status: "Dentro do Prazo", class: "status-valid" };
            }
        }
        
        // Função para formatar data no formato brasileiro
      function formatDate(dateString) {
    // Verifica se a string de data existe e está no formato esperado (YYYY-MM-DD)
    if (!dateString || !dateString.includes('-')) {
        return 'Data inválida';
    }

    // 1. Divide a string "YYYY-MM-DD" em um array ["YYYY", "MM", "DD"]
    const parts = dateString.split('-');
    
    // 2. Pega as partes da data
    const year = parts[0];
    const month = parts[1];
    const day = parts[2];

    // 3. Retorna a data formatada como "DD/MM/YYYY"
    return `${day}/${month}/${year}`;
}
    </script>
</body>
</html>


